<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Portfolio Manager Simulator (Expandable Rows)</title>
  <style>
    :root {
      /* Light Mode defaults */
      --bg-body: #f8f9fa;
      --bg-container: #fff;
      --text-color: #000;
      --header-footer-bg: #e9e9e9;
      --asset-col-bg: #f7f7f7;
      --proposed-col-border: #007bff;
      --editable-field-border: #ccc;
    }
    body.dark-mode {
      /* Dark mode overrides */
      --bg-body: #202020;
      --bg-container: #2c2c2c;
      --text-color: #eee;
      --header-footer-bg: #444;
      --asset-col-bg: #333;
      --proposed-col-border: #66afff;
      --editable-field-border: #888;
    }
    body {
      margin: 0;
      font-family: 'Helvetica Neue', Arial, sans-serif;
      min-width: 1200px; /* wide layout */
      background: var(--bg-body);
      color: var(--text-color);
      transition: background 0.3s, color 0.3s;
    }
    .container {
      max-width: 1200px;
      margin: 1rem auto;
      padding: 1.5rem;
      background: var(--bg-container);
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      transition: background 0.3s, color 0.3s;
    }
    h1, h2 {
      margin-top: 0;
      margin-bottom: 0.75rem;
    }
    /* Toggle dot for Dark Mode */
    .dark-mode-toggle {
      width: 20px; height: 20px;
      border-radius: 50%;
      background: #666;
      position: absolute;
      top: 10px; right: 10px;
      cursor: pointer;
      border: 2px solid #999;
      transition: background 0.3s;
    }
    .dark-mode-toggle:hover { background: #444; }
    body.dark-mode .dark-mode-toggle {
      background: #aaa;
      border-color: #ccc;
    }
    body.dark-mode .dark-mode-toggle:hover {
      background: #ccc;
    }
    /* Buttons */
    .btn {
      padding: 0.4rem 0.8rem;
      border: none;
      background: #007bff;
      color: #fff;
      cursor: pointer;
      border-radius: 3px;
      margin-left: 0.5rem;
      font-size: 0.9rem;
    }
    .btn:hover {
      background: #0069d9;
    }
    /* Profile layout */
    #client-profile {
      display: flex; justify-content: space-between; flex-wrap: wrap;
    }
    .profile-info {
      flex: 1; min-width: 320px; margin-right: 1rem;
    }
    .profile-actions { margin-top: 1rem; }
    #riskSelect { margin-left: 0.5rem; }
    /* Editable field (Portfolio Value) */
    .editable-field {
      cursor: pointer;
      border: 1px dotted var(--editable-field-border);
      padding: 2px 4px;
      background: #fafafa;
      transition: border-color 0.3s;
    }
    body.dark-mode .editable-field { background: #333; }
    .editable-field input {
      width: 80px; border: 1px solid #007bff; text-align: right; 
      outline: none; font: inherit; box-sizing: border-box;
    }
    /* Table */
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 0.5rem 0;
      transition: background 0.3s, color 0.3s;
    }
    thead th {
      background: var(--header-footer-bg);
    }
    tfoot td {
      background: var(--header-footer-bg);
      font-weight: bold;
    }
    th, td {
      text-align: left; padding: 0.4rem; border-bottom: 1px solid #eee;
      vertical-align: middle;
    }
    /* ASSET column => bold text, slightly darker BG. */
    td.asset-col {
      background: var(--asset-col-bg);
      font-weight: bold; /* new request: bold assets */
      transition: background 0.3s;
    }
    /* Proposed columns => color inversion from final columns. 
       If Proposed($ or %) >0 => GREEN & BOLD; <0 => RED & BOLD; zero => black. */
    .proposed-col {
      border: 1px dotted var(--proposed-col-border);
      background: #fafafa;
      cursor: pointer;
      transition: border-color 0.3s;
    }
    body.dark-mode .proposed-col { background: #333; }
    .proposed-positive { color: green; font-weight: bold; }
    .proposed-negative { color: red;   font-weight: bold; }
    /* zero => black normal => no class */
    /* Delta color logic => final surplus or deficit => red/green bold if nonzero. */
    .delta-positive { color: red;   font-weight: bold; }
    .delta-negative { color: green; font-weight: bold; }
    /* 3 smaller charts side by side */
    .charts-container {
      display: flex; gap: 1rem; margin-top: 1rem;
      flex-wrap: wrap; justify-content: space-evenly;
    }
    .chart-box {
      flex: 1;
      min-width: 250px; max-width: 300px; max-height: 300px;
      margin: auto; background: #f9f9f9; border-radius: 4px; 
      padding: 1rem; text-align: center; transition: background 0.3s;
    }
    body.dark-mode .chart-box { background: #333; }
    .chart-title { margin-bottom: 0.5rem; font-weight: bold; }
    .chart-box canvas {
      width: 100% !important; height: 100% !important;
    }
    .footer {
      text-align: center; margin-top: 2rem; font-size: 0.85rem;
      color: var(--text-color);
      transition: color 0.3s;
    }
    .success { color: green; font-weight: bold; }
    .error   { color: red;   font-weight: bold; }
    /* 
      Expandable Rows 
      We'll have hidden child rows (Classes), and each Class can have hidden Position rows.
      We'll show/hide them by toggling a "hidden" class or removing from the DOM.
    */
    .expand-toggle {
      cursor: pointer; color: #007bff; margin-right: 0.5rem;
    }
    .hidden { display: none; }
    /* Sub-level indentation */
    .level-class td { padding-left: 2em; }
    .level-position td { padding-left: 4em; }
    /* Extra columns for Absolute(%) or Relative(%) only appear if expanded. 
       We'll define columns with "abs-col", "rel-col" classes, and hide them by default. 
    */
    .abs-col, .rel-col { display: none; }
    /* 
      If a row is expanded, we might show the abs-col, rel-col in that sub-group. 
      We'll do so dynamically with JS.
    */
  </style>
</head>
<body>
<div class="dark-mode-toggle" id="darkModeToggle"></div>

<div class="container">
  <h1>Portfolio Manager Simulator – Expandable Rows</h1>

  <div id="client-profile" class="section">
    <div class="profile-info">
      <p><strong>Name:</strong> <span id="clientName">--</span></p>
      <p>
        <strong>Risk Tolerance:</strong>
        <select id="riskSelect">
          <option value="conservative">Conservative</option>
          <option value="moderate" selected>Moderate</option>
          <option value="aggressive">Aggressive</option>
        </select>
      </p>
      <p>
        <strong>Portfolio Value:</strong>
        $<span id="clientValue" class="editable-field">0</span>
      </p>
      <p>
        <strong>Target Allocation:</strong>
        <span id="targetStocks">--</span>% Stocks, 
        <span id="targetBonds">--</span>% Bonds, 
        <span id="targetCash">--</span>% Cash
      </p>
      <div class="profile-actions">
        <button class="btn" id="newClientBtn">Generate New Client</button>
      </div>
    </div>
  </div>

  <div class="section">
    <div class="portfolio-header">
      <h2>Current (or Projected) Portfolio</h2>
      <div class="portfolio-buttons">
        <button class="btn" id="resetTradesBtn">Reset Trades</button>
      </div>
    </div>

    <table id="portfolioTable">
      <thead>
        <tr>
          <th>Asset/Class/Position</th>
          <th>Current ($)</th>
          <th>Target ($)</th>
          <th>Proposed +/- ($)</th>
          <th>Final ($)</th>
          <th>Delta ($)</th>
          <th>Current (%)</th>
          <th>Target (%)</th>
          <th>Proposed +/- (%)</th>
          <th>Final (%)</th>
          <th>Delta (%)</th>
          <!-- Additional columns for Absolute(%) and Relative(%) show up 
               when a row is expanded, to demonstrate how you'd display 
               Absolute vs. sub-group Relative. We'll insert them dynamically. -->
        </tr>
      </thead>
      <tbody id="portfolioRows"></tbody>
      <tfoot>
        <tr id="totalRow"></tr>
      </tfoot>
    </table>

    <div class="charts-container">
      <div class="chart-box">
        <div class="chart-title">Current Allocation</div>
        <canvas id="currentChart"></canvas>
      </div>
      <div class="chart-box">
        <div class="chart-title">Target Allocation</div>
        <canvas id="targetChart"></canvas>
      </div>
      <div class="chart-box">
        <div class="chart-title">Final Allocation</div>
        <canvas id="finalChart"></canvas>
      </div>
    </div>

    <p id="tradeMessage"></p>
  </div>
</div>

<div class="footer">
  &copy; Example: Expandable Rows, Proposed Color Inversion, Bold Assets, Dark Mode
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/*************************************************************************
 * Data Model Explanation
 *
 * We'll store a nested structure like:
 *
 * assets = [
 *   {
 *     name: 'Stocks',
 *     currentDollar, targetDollar, proposedDollar, finalDollar, etc...
 *     classes: [
 *       {
 *         name: 'Large Cap',
 *         currentDollar, ...
 *         positions: [
 *           {
 *             name: 'AAPL',
 *             ...
 *           }
 *         ],
 *       },
 *       { name: 'Small Cap', ... }
 *     ]
 *   },
 *   { name: 'Bonds', ... },
 *   ...
 * ]
 *
 * We'll build table rows for each top-level (Asset), each sub-level (Class), 
 * and each position. We can expand/collapse each level with a toggle.
 *************************************************************************/

let totalPortfolioValue= 0;
let currentChart, targetChart, finalChart;

// We'll store a nested structure as an example:
let portfolioData = {
  name: 'ROOT',
  currentDollar: 0,
  targetDollar: 0,
  proposedDollar: 0,
  finalDollar: 0,
  finalPct: 0,
  classes: [
    {
      name: 'Stocks',
      isAsset: true, // top-level
      expanded: false,
      currentDollar: 0,
      targetDollar: 0,
      proposedDollar: 0,
      finalDollar: 0,
      finalPct: 0,
      classes: [
        {
          name: 'Large Cap',
          isClass: true,
          expanded: false,
          currentDollar: 0,
          targetDollar: 0,
          proposedDollar: 0,
          finalDollar: 0,
          finalPct: 0,
          positions: [
            {
              name: 'AAPL',
              isPosition: true,
              currentDollar: 10000,
              targetDollar: 12000,
              proposedDollar: 0,
              finalDollar: 10000,
              finalPct: 0,
            },
            {
              name: 'MSFT',
              isPosition: true,
              currentDollar: 8000,
              targetDollar: 9000,
              proposedDollar: 0,
              finalDollar: 8000,
              finalPct: 0,
            },
          ]
        },
        {
          name: 'Small Cap',
          isClass: true,
          expanded: false,
          currentDollar: 0,
          targetDollar: 0,
          proposedDollar: 0,
          finalDollar: 0,
          finalPct: 0,
          positions: [
            {
              name: 'RGEN',
              isPosition: true,
              currentDollar: 3000,
              targetDollar: 3500,
              proposedDollar: 0,
              finalDollar: 3000,
              finalPct: 0,
            }
          ]
        }
      ]
    },
    {
      name: 'Bonds',
      isAsset: true,
      expanded: false,
      currentDollar: 5000,
      targetDollar: 7000,
      proposedDollar: 0,
      finalDollar: 5000,
      finalPct: 0,
      classes: [] // no sub-classes in this example
    }
  ]
};

/*******************************************************
 * Dark Mode Toggle
 ******************************************************/
const darkToggle = document.createElement('div');
darkToggle.className = 'dark-mode-toggle';
darkToggle.id = 'darkModeToggle';
document.body.appendChild(darkToggle);

darkToggle.addEventListener('click', () => {
  document.body.classList.toggle('dark-mode');
});

/*******************************************************
 * We skip the random client generation for simplicity 
 * and assume we already have 'portfolioData' structured.
 * We'll just illustrate expansions and color logic.
 *******************************************************/

// Table Rendering
function renderTable() {
  const tbody = document.getElementById('portfolioRows');
  tbody.innerHTML = '';

  // We'll recursively build rows for each asset/class/position
  portfolioData.classes.forEach(asset => {
    buildAssetRow(tbody, asset, 0); 
  });

  // Build total row for entire portfolio
  buildTotalRow();
  // We won't show or recalc actual "final vs. target" for entire portfolio here,
  // but you can adapt the same logic from prior versions if needed.
}

// Build a row for an Asset. If expanded, build rows for its classes.
function buildAssetRow(tbody, asset, level) {
  // Summaries
  const deltaDollar = asset.targetDollar - asset.finalDollar;
  // We'll do a row
  const tr = document.createElement('tr');

  // 1) Expand Toggle + Asset Name
  const tdName = document.createElement('td');
  tdName.classList.add('asset-col'); // bold text
  const toggle = document.createElement('span');
  toggle.className = 'expand-toggle';
  toggle.textContent = asset.expanded ? '▼' : '▶';
  toggle.onclick = () => {
    asset.expanded = !asset.expanded;
    renderTable(); // re-render
  };
  if(asset.classes && asset.classes.length>0) {
    // only show toggle if there are sub-classes
    tdName.appendChild(toggle);
  }
  tdName.appendChild(document.createTextNode(asset.name));
  tr.appendChild(tdName);

  // 2) Current($)
  const tdCurrent = document.createElement('td');
  tdCurrent.textContent = formatMoney(asset.currentDollar);
  tr.appendChild(tdCurrent);

  // 3) Target($)
  const tdTarget = document.createElement('td');
  tdTarget.textContent = formatMoney(asset.targetDollar);
  tr.appendChild(tdTarget);

  // 4) Proposed($) => color invert
  const tdProposed = document.createElement('td');
  tdProposed.className = 'proposed-col';
  // We'll do color logic for proposed: positive => green, negative => red
  if(asset.proposedDollar>0) {
    tdProposed.classList.add('proposed-positive');
  } else if(asset.proposedDollar<0) {
    tdProposed.classList.add('proposed-negative');
  }
  tdProposed.textContent = formatMoney(asset.proposedDollar);
  // No editing logic here for brevity, but you can do single-click edit
  tr.appendChild(tdProposed);

  // 5) Final($)
  const tdFinal = document.createElement('td');
  tdFinal.textContent = formatMoney(asset.finalDollar);
  tr.appendChild(tdFinal);

  // 6) Delta($) => color final surplus/deficit if you want
  const tdDelta = document.createElement('td');
  const dd = asset.targetDollar - asset.finalDollar;
  tdDelta.textContent = withSignMoney(dd);
  colorDeltaCell(tdDelta, dd); 
  tr.appendChild(tdDelta);

  // 7) Current(%)
  const tdCurPct = document.createElement('td');
  tdCurPct.textContent = '---%'; // example
  tr.appendChild(tdCurPct);

  // 8) Target(%)
  const tdTarPct = document.createElement('td');
  tdTarPct.textContent = '---%';
  tr.appendChild(tdTarPct);

  // 9) Proposed(%)
  const tdPropPct = document.createElement('td');
  tdPropPct.className='proposed-col';
  if(asset.proposedDollar>0) {
    tdPropPct.classList.add('proposed-positive');
  } else if(asset.proposedDollar<0) {
    tdPropPct.classList.add('proposed-negative');
  }
  tdPropPct.textContent = '---%';
  tr.appendChild(tdPropPct);

  // 10) Final(%)
  const tdFinPct = document.createElement('td');
  tdFinPct.textContent = '---%';
  tr.appendChild(tdFinPct);

  // 11) Delta(%)
  const tdDeltaPct = document.createElement('td');
  tdDeltaPct.textContent= '+0.00%';
  tr.appendChild(tdDeltaPct);

  tbody.appendChild(tr);

  // If expanded, show child classes
  if(asset.expanded && asset.classes) {
    asset.classes.forEach(cls => {
      buildClassRow(tbody, cls, level+1, asset);
    });
    // Build a TOT row for that Asset
    buildSubTotalRow(tbody, asset, level, 'Asset TOT');
  }
}

// Build row for a Class. If expanded => show positions
function buildClassRow(tbody, cls, level, parentAsset) {
  const tr = document.createElement('tr');
  tr.className='level-class';
  // Indent
  const tdName = document.createElement('td');
  const toggle = document.createElement('span');
  toggle.className='expand-toggle';
  toggle.textContent = cls.expanded ? '▼':'▶';
  toggle.onclick= ()=>{
    cls.expanded = !cls.expanded;
    renderTable();
  };
  if(cls.positions && cls.positions.length>0) {
    tdName.appendChild(toggle);
  }
  tdName.appendChild(document.createTextNode(cls.name));
  tr.appendChild(tdName);

  // We'll just do placeholders for the numeric columns
  // In your real logic, you'd sum up positions to find the class current/final amounts
  const tdCur= document.createElement('td');
  tdCur.textContent= formatMoney(cls.currentDollar);
  tr.appendChild(tdCur);

  const tdTar= document.createElement('td');
  tdTar.textContent= formatMoney(cls.targetDollar);
  tr.appendChild(tdTar);

  const tdProp= document.createElement('td');
  tdProp.className='proposed-col';
  if(cls.proposedDollar>0) {
    tdProp.classList.add('proposed-positive');
  } else if(cls.proposedDollar<0) {
    tdProp.classList.add('proposed-negative');
  }
  tdProp.textContent= formatMoney(cls.proposedDollar);
  tr.appendChild(tdProp);

  const tdFin= document.createElement('td');
  tdFin.textContent= formatMoney(cls.finalDollar);
  tr.appendChild(tdFin);

  const tdDelta= document.createElement('td');
  let dd = cls.targetDollar - cls.finalDollar;
  tdDelta.textContent= withSignMoney(dd);
  colorDeltaCell(tdDelta, dd);
  tr.appendChild(tdDelta);

  const tdCurPct= document.createElement('td');
  tdCurPct.textContent= '---%';
  tr.appendChild(tdCurPct);

  const tdTarPct= document.createElement('td');
  tdTarPct.textContent= '---%';
  tr.appendChild(tdTarPct);

  const tdPropPct= document.createElement('td');
  tdPropPct.className='proposed-col';
  if(cls.proposedDollar>0) {
    tdPropPct.classList.add('proposed-positive');
  } else if(cls.proposedDollar<0) {
    tdPropPct.classList.add('proposed-negative');
  }
  tdPropPct.textContent='---%';
  tr.appendChild(tdPropPct);

  const tdFinPct= document.createElement('td');
  tdFinPct.textContent='---%';
  tr.appendChild(tdFinPct);

  const tdDeltaPct= document.createElement('td');
  tdDeltaPct.textContent='+0.00%';
  tr.appendChild(tdDeltaPct);

  tbody.appendChild(tr);

  if(cls.expanded && cls.positions) {
    cls.positions.forEach(pos => {
      buildPositionRow(tbody, pos, level+2, cls);
    });
    buildSubTotalRow(tbody, cls, level+1, 'Class TOT');
  }
}

// Build row for a Position
function buildPositionRow(tbody, pos, level, parentClass) {
  const tr = document.createElement('tr');
  tr.className='level-position';
  // name cell
  const tdName= document.createElement('td');
  tdName.textContent= pos.name;
  tr.appendChild(tdName);

  // numeric columns
  const tdCur= document.createElement('td');
  tdCur.textContent= formatMoney(pos.currentDollar);
  tr.appendChild(tdCur);

  const tdTar= document.createElement('td');
  tdTar.textContent= formatMoney(pos.targetDollar);
  tr.appendChild(tdTar);

  const tdProp= document.createElement('td');
  tdProp.className='proposed-col';
  if(pos.proposedDollar>0) {
    tdProp.classList.add('proposed-positive');
  } else if(pos.proposedDollar<0) {
    tdProp.classList.add('proposed-negative');
  }
  tdProp.textContent= formatMoney(pos.proposedDollar);
  tr.appendChild(tdProp);

  const tdFin= document.createElement('td');
  tdFin.textContent= formatMoney(pos.finalDollar);
  tr.appendChild(tdFin);

  const tdDelta= document.createElement('td');
  let dd= pos.targetDollar - pos.finalDollar;
  tdDelta.textContent= withSignMoney(dd);
  colorDeltaCell(tdDelta, dd);
  tr.appendChild(tdDelta);

  const tdCurPct= document.createElement('td');
  tdCurPct.textContent='---%';
  tr.appendChild(tdCurPct);

  const tdTarPct= document.createElement('td');
  tdTarPct.textContent='---%';
  tr.appendChild(tdTarPct);

  const tdPropPct= document.createElement('td');
  tdPropPct.className='proposed-col';
  if(pos.proposedDollar>0) {
    tdPropPct.classList.add('proposed-positive');
  } else if(pos.proposedDollar<0) {
    tdPropPct.classList.add('proposed-negative');
  }
  tdPropPct.textContent='---%';
  tr.appendChild(tdPropPct);

  const tdFinPct= document.createElement('td');
  tdFinPct.textContent='---%';
  tr.appendChild(tdFinPct);

  const tdDeltaPct= document.createElement('td');
  tdDeltaPct.textContent='+0.00%';
  tr.appendChild(tdDeltaPct);

  tbody.appendChild(tr);
}

// Build a sub-total row for each level
function buildSubTotalRow(tbody, node, level, label) {
  const tr= document.createElement('tr');
  // We style it similarly to total, but at sub-level
  const tdName= document.createElement('td');
  tdName.textContent= `[${label}] ${node.name}`;
  tdName.style.fontWeight='bold';
  tdName.colSpan=11; 
  // For brevity, we won't do numeric columns. 
  // Or we could fill them with partial sums of sub-level. 
  tr.appendChild(tdName);
  tbody.appendChild(tr);
}

function buildTotalRow() {
  const tfoot= document.getElementById('totalRow');
  tfoot.innerHTML= '';

  // For now, a simple placeholder total row
  const td= document.createElement('td');
  td.textContent='TOTAL PORTFOLIO';
  td.colSpan=11;
  tfoot.appendChild(td);
}

/********************************************
 * Minimal chart placeholders & toggles
 ********************************************/

function initCharts() {
  currentChart= new Chart(document.getElementById('currentChart'), {
    type:'pie',
    data:{ labels:[], datasets:[{ label:'Current', data:[], backgroundColor:['#2196f3','#8bc34a','#ffc107']}] },
    options:{ responsive:true, maintainAspectRatio:true, plugins:{ legend:{ position:'bottom'}}}
  });
  targetChart= new Chart(document.getElementById('targetChart'), {
    type:'pie',
    data:{ labels:[], datasets:[{ label:'Target', data:[], backgroundColor:['#2196f3','#8bc34a','#ffc107']}] },
    options:{ responsive:true, maintainAspectRatio:true, plugins:{ legend:{ position:'bottom'}}}
  });
  finalChart= new Chart(document.getElementById('finalChart'), {
    type:'pie',
    data:{ labels:[], datasets:[{ label:'Final', data:[], backgroundColor:['#2196f3','#8bc34a','#ffc107']}] },
    options:{ responsive:true, maintainAspectRatio:true, plugins:{ legend:{ position:'bottom'}}}
  });
}
function updateCharts() {
  // For brevity, we won't do real chart updates in this example. 
  // You can sum up the data from each node for Current, Target, Final.
  currentChart.update();
  targetChart.update();
  finalChart.update();
}

/***********************************************
 * Proposed Color logic: 
 *  Positive => green bold, negative => red bold, zero => black normal
 ***********************************************/
function applyProposedColor(cell, value) {
  cell.classList.remove('proposed-positive','proposed-negative');
  if(Math.abs(value)<0.01) {
    // zero => black
  } else if(value>0) {
    cell.classList.add('proposed-positive');
  } else {
    cell.classList.add('proposed-negative');
  }
}

/***********************************************
 * Delta color logic => final surplus/deficit:
 *  positive => red bold, negative => green bold, zero => black
 ***********************************************/
function colorDeltaCell(td, val){
  td.classList.remove('delta-positive','delta-negative');
  let r= parseFloat(val.toFixed(2));
  if(Math.abs(r)<0.01){
    // zero => black normal => do nothing
  } else if(r>0) {
    td.classList.add('delta-positive'); 
  } else {
    td.classList.add('delta-negative');
  }
}

/***********************************************
 * withSignMoney => sign + comma formatting 
 ***********************************************/
function withSignMoney(value){
  let r= parseFloat(value.toFixed(2));
  if(Math.abs(r)<0.01) r=0; 
  let absVal= Math.abs(r);
  let absStr= formatMoney(absVal);
  if(r>0) return `+${absStr}`;
  else if(r<0) return `-${absStr}`;
  else return absStr; 
}

/***********************************************
 * withSignPct => sign + "xx.xx%"
 ***********************************************/
function withSignPct(value){
  let r= parseFloat(value.toFixed(2));
  if(Math.abs(r)<0.01) r=0; 
  let absVal= Math.abs(r).toFixed(2);
  if(r>0) return `+${absVal}%`;
  else if(r<0) return `-${absVal}%`;
  else return `0.00%`;
}

/***********************************************
 * Basic money formatting 
 ***********************************************/
function formatMoney(x){
  return new Intl.NumberFormat('en-US',{
    minimumFractionDigits:2,
    maximumFractionDigits:2
  }).format(x);
}

/***********************************************
 * Startup 
 ***********************************************/
window.addEventListener('DOMContentLoaded', ()=>{
  initCharts();

  // We'll wire up "Generate New Client" but let's skip random data for now
  document.getElementById('newClientBtn').addEventListener('click', ()=>{
    // no-op or you can re-initialize portfolioData
    alert("This example uses a static nested data structure.\nFeel free to adapt for real random generation!");
  });
  // Reset trades => we just forcibly revert 
  document.getElementById('resetTradesBtn').addEventListener('click', ()=>{
    alert("Reset trades not fully implemented in this nested example.\nYou'd restore the original nested data and re-render.");
  });

  // Risk select => do nothing special here 
  document.getElementById('riskSelect').addEventListener('change', ()=>{
    // example
    alert("Risk changed. In a real app, you'd recalc target distribution for each sub-level.");
  });

  // For the sake of demonstration, let's just render the table with the nested data
  renderTable();
  updateCharts();
});
</script>
</body>
</html>
