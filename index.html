<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Portfolio Manager Simulator (Percentage-Point Fix)</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background: #f8f9fa;
    }

    .container {
      max-width: 900px;
      margin: 1rem auto;
      padding: 1.5rem;
      background: #fff;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      border-radius: 5px;
    }

    h1, h2, h3 {
      margin-top: 0;
      margin-bottom: 0.75rem;
    }

    .section {
      margin-bottom: 1.5rem;
      border-bottom: 1px solid #ddd;
      padding-bottom: 1rem;
    }

    .btn {
      padding: 0.4rem 0.8rem;
      border: none;
      background: #007bff;
      color: #fff;
      cursor: pointer;
      border-radius: 3px;
      margin-left: 0.5rem;
      font-size: 0.9rem;
    }
    .btn:hover {
      background: #0069d9;
    }

    /* CLIENT PROFILE */
    #client-profile {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
    }
    .profile-info {
      flex: 1;
      min-width: 250px;
      margin-right: 1rem;
    }
    .profile-info p {
      margin: 0.3rem 0;
    }

    .profile-actions {
      margin-top: 1rem;
    }

    /* CURRENT (OR PROJECTED) HEADER WITH BUTTONS ON THE SAME LINE, RIGHT-ALIGNED */
    .portfolio-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      margin-bottom: 0.5rem;
    }
    .portfolio-header h2 {
      margin-bottom: 0.3rem;
    }
    .portfolio-buttons {
      display: flex;
      gap: 0.5rem;
    }

    /* TABLE */
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 0.5rem 0;
    }
    th, td {
      text-align: left;
      padding: 0.4rem;
      border-bottom: 1px solid #eee;
      vertical-align: middle;
    }
    th {
      background: #f0f0f0;
    }

    .editable-cell {
      cursor: pointer;
      background: #fafafa;
      border: 1px solid transparent;
    }
    .editable-cell input {
      width: 100%;
      border: 1px solid #007bff;
      outline: none;
      font: inherit;
      box-sizing: border-box;
      padding: 2px 4px;
      text-align: right;
    }

    /* CHARTS LAYOUT */
    .charts-container {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
      flex-wrap: wrap;
    }
    .chart-box {
      flex: 1;
      min-width: 270px;
      max-width: 400px;
      max-height: 400px;
      position: relative;
      margin: auto;
      background: #f9f9f9;
      border-radius: 4px;
      padding: 1rem;
      text-align: center;
    }
    .chart-title {
      margin-bottom: 0.5rem;
      font-weight: bold;
    }
    .chart-box canvas {
      width: 100% !important;
      height: 100% !important;
    }

    @media (max-width: 700px) {
      .charts-container {
        flex-direction: column;
      }
      .chart-box {
        max-width: 100%;
        margin-bottom: 1rem;
      }
    }

    .footer {
      text-align: center;
      margin-top: 2rem;
      font-size: 0.85rem;
      color: #666;
    }

    .success {
      color: green;
      font-weight: bold;
    }
    .error {
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>Portfolio Manager Simulator</h1>

  <!-- SECTION: CLIENT PROFILE -->
  <div class="section">
    <h2>Client Profile</h2>
    <div id="client-profile">
      <div class="profile-info">
        <p><strong>Name:</strong> <span id="clientName">--</span></p>
        <p><strong>Risk Tolerance:</strong> <span id="clientRisk">--</span></p>
        <p><strong>Portfolio Value:</strong> $<span id="clientValue">0</span></p>
        <p><strong>Target Allocation:</strong> 
          <span id="targetStocks">--</span>% Stocks, 
          <span id="targetBonds">--</span>% Bonds, 
          <span id="targetCash">--</span>% Cash
        </p>

        <!-- Moved "Generate New Client" button here -->
        <div class="profile-actions">
          <button class="btn" id="newClientBtn">Generate New Client</button>
        </div>
      </div>
    </div>
  </div>

  <!-- SECTION: CURRENT (OR PROJECTED) PORTFOLIO -->
  <div class="section">
    <div class="portfolio-header">
      <h2>Current (or Projected) Portfolio</h2>
      <div class="portfolio-buttons">
        <button class="btn" id="rebalanceBtn">Rebalance</button>
        <button class="btn" id="resetTradesBtn">Reset Trades</button>
      </div>
    </div>

    <!-- 9 columns as requested -->
    <table id="portfolioTable">
      <thead>
        <tr>
          <th>Asset</th>
          <th>Current ($)</th>
          <th>Target ($)</th>
          <th>Proposed +/- ($)</th>
          <th>Final ($)</th>
          <th>Current (%)</th>
          <th>Target (%)</th>
          <th>Proposed +/- (%)</th>
          <th>Final (%)</th>
        </tr>
      </thead>
      <tbody id="portfolioRows">
        <!-- Populated by JS -->
      </tbody>
    </table>

    <div class="charts-container">
      <!-- Left chart: Final Allocation (Current + Proposed) -->
      <div class="chart-box">
        <div class="chart-title">Final Allocation</div>
        <canvas id="finalChart"></canvas>
      </div>
      <!-- Right chart: Target Allocation (Original Goal) -->
      <div class="chart-box">
        <div class="chart-title">Target Allocation</div>
        <canvas id="targetChart"></canvas>
      </div>
    </div>

    <p id="tradeMessage"></p>
  </div>
</div>

<div class="footer">
  &copy; Percentage-Point Fix &bull; Single-Click Editing &amp; 9-Column Table
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/* 
  Percentage-Point Fix:

  If the user edits "Proposed +/- (%)" to X, we interpret that as:
  
      Final% = Current% + X
  
  Then Final($) = Final% * (Total Current $) / 100,
  and proposedDollar = Final($) - Current($).

  This ensures that if Current% = 46.8 and Proposed +/-(%) = 3.2,
  the difference between Final% and Current% is exactly 3.2 points.
  The user may see a mismatch with "summing to 100%" if multiple changes happen,
  but each row individually now matches the user's expectation.
*/

let assets = []; // [ {name, currentDollar, targetDollar, proposedDollar, finalDollar, ...}, ... ]
let totalCurrent = 0;
let totalTarget  = 0;
let totalFinal   = 0;

let finalChart, targetChart;

// Basic client data
let clientName = '';
let clientRisk = '';
let clientValue = 0; // total portfolio
let targetStocksPct = 0;
let targetBondsPct  = 0;
let targetCashPct   = 0;


/** Generate a random client (just like before). */
function generateRandomClient() {
  const names = ['John Smith', 'Jane Doe', 'Alex Johnson', 'Maria Garcia', 'Lee Wong'];
  const riskLevels = [
    { name: 'Conservative', stockPct: 0.3, bondPct: 0.5, cashPct: 0.2 },
    { name: 'Moderate',     stockPct: 0.5, bondPct: 0.4, cashPct: 0.1 },
    { name: 'Aggressive',   stockPct: 0.7, bondPct: 0.2, cashPct: 0.1 }
  ];
  const randName = names[Math.floor(Math.random() * names.length)];
  const randRisk = riskLevels[Math.floor(Math.random() * riskLevels.length)];

  return {
    clientName: randName,
    riskTolerance: randRisk.name,
    totalValue: 100000,
    targetStockPct: randRisk.stockPct,
    targetBondPct:  randRisk.bondPct,
    targetCashPct:  randRisk.cashPct
  };
}

function newRandomClient() {
  const c = generateRandomClient();
  clientName = c.clientName;
  clientRisk = c.riskTolerance;
  clientValue = c.totalValue;
  targetStocksPct = c.targetStockPct;
  targetBondsPct  = c.targetBondPct;
  targetCashPct   = c.targetCashPct;

  // Deviate the current amounts from the target for variety
  const deviate = () => (Math.random() * 0.2 - 0.1);
  const stDev = targetStocksPct + deviate();
  const boDev = targetBondsPct + deviate();
  const caDev = targetCashPct + deviate();
  const sum   = Math.max(stDev + boDev + caDev, 0.001);
  const stPct = stDev / sum;
  const boPct = boDev / sum;
  const caPct = caDev / sum;

  assets = [
    {
      name: "Stocks",
      currentDollar: c.totalValue * stPct,
      targetDollar:  c.totalValue * c.targetStockPct,
      proposedDollar: 0,
      finalDollar: 0,
      currentPct: 0,
      targetPct: 0,
      proposedPct: 0, // difference from current% in percentage points
      finalPct: 0
    },
    {
      name: "Bonds",
      currentDollar: c.totalValue * boPct,
      targetDollar:  c.totalValue * c.targetBondPct,
      proposedDollar: 0,
      finalDollar: 0,
      currentPct: 0,
      targetPct: 0,
      proposedPct: 0,
      finalPct: 0
    },
    {
      name: "Cash",
      currentDollar: c.totalValue * caPct,
      targetDollar:  c.totalValue * c.targetCashPct,
      proposedDollar: 0,
      finalDollar: 0,
      currentPct: 0,
      targetPct: 0,
      proposedPct: 0,
      finalPct: 0
    }
  ];

  document.getElementById('tradeMessage').textContent = '';
  renderClientProfile();
  recalcAndRender();
}

/** Show the name/risk in the Client Profile section. */
function renderClientProfile() {
  document.getElementById('clientName').textContent = clientName;
  document.getElementById('clientRisk').textContent = clientRisk;
  document.getElementById('clientValue').textContent = formatMoney(clientValue);

  document.getElementById('targetStocks').textContent = (targetStocksPct * 100).toFixed(0);
  document.getElementById('targetBonds').textContent  = (targetBondsPct  * 100).toFixed(0);
  document.getElementById('targetCash').textContent   = (targetCashPct   * 100).toFixed(0);
}

/** Recalculate all columns, then re-render table + charts. */
function recalcAndRender() {
  // sum of current
  totalCurrent = assets.reduce((acc,a) => acc + a.currentDollar, 0);
  // sum of target
  totalTarget  = assets.reduce((acc,a) => acc + a.targetDollar, 0);

  // finalDollar = currentDollar + proposedDollar
  assets.forEach(a => {
    a.finalDollar = a.currentDollar + a.proposedDollar;
  });
  totalFinal = assets.reduce((acc,a) => acc + a.finalDollar, 0);

  // now compute the percentages
  assets.forEach(a => {
    a.currentPct = (totalCurrent > 0) ? (a.currentDollar / totalCurrent) * 100 : 0;
    a.targetPct  = (totalTarget  > 0) ? (a.targetDollar  / totalTarget ) * 100 : 0;

    // proposedPct is “Final% - Current%”. We'll compute that from the final vs. current below.
    // but we also want to keep “the user’s typed #” in a. proposedPct if they typed it directly.
    // We'll override it with the actual difference so the table stays consistent.
    let actualFinalPct = (totalFinal > 0) ? (a.finalDollar / totalFinal) * 100 : 0;
    a.finalPct = actualFinalPct;

    // The difference between finalPct and currentPct is the actual Proposed +/- (%) in the table
    let difference = a.finalPct - a.currentPct;
    a.proposedPct = difference;
  });

  renderPortfolioTable();
  updateCharts();
}

/** Fill the portfolio table with rows. */
function renderPortfolioTable() {
  const tbody = document.getElementById('portfolioRows');
  tbody.innerHTML = '';

  assets.forEach((asset, idx) => {
    const tr = document.createElement('tr');

    // 1) Asset
    const tdName = document.createElement('td');
    tdName.textContent = asset.name;
    tr.appendChild(tdName);

    // 2) Current($)
    const tdCurrentDollar = document.createElement('td');
    tdCurrentDollar.textContent = formatMoney(asset.currentDollar);
    tr.appendChild(tdCurrentDollar);

    // 3) Target($)
    const tdTargetDollar = document.createElement('td');
    tdTargetDollar.textContent = formatMoney(asset.targetDollar);
    tr.appendChild(tdTargetDollar);

    // 4) Proposed +/-($) [editable]
    const tdProposedDollar = document.createElement('td');
    tdProposedDollar.className = 'editable-cell';
    tdProposedDollar.textContent = formatMoney(asset.proposedDollar);
    tdProposedDollar.onclick = () => makeEditable(tdProposedDollar, idx, 'dollar');
    tr.appendChild(tdProposedDollar);

    // 5) Final($)
    const tdFinalDollar = document.createElement('td');
    tdFinalDollar.textContent = formatMoney(asset.finalDollar);
    tr.appendChild(tdFinalDollar);

    // 6) Current(%)
    const tdCurrentPct = document.createElement('td');
    tdCurrentPct.textContent = asset.currentPct.toFixed(1) + '%';
    tr.appendChild(tdCurrentPct);

    // 7) Target(%)
    const tdTargetPct = document.createElement('td');
    tdTargetPct.textContent = asset.targetPct.toFixed(1) + '%';
    tr.appendChild(tdTargetPct);

    // 8) Proposed +/-(%) [editable]
    const tdProposedPct = document.createElement('td');
    tdProposedPct.className = 'editable-cell';
    // We show e.g. +3.20 or -0.70. Let's keep 2 decimals
    let prefix = (asset.proposedPct >= 0) ? '' : '';
    tdProposedPct.textContent = prefix + asset.proposedPct.toFixed(2) + '%';
    tdProposedPct.onclick = () => makeEditable(tdProposedPct, idx, 'percent');
    tr.appendChild(tdProposedPct);

    // 9) Final(%)
    const tdFinalPct = document.createElement('td');
    tdFinalPct.textContent = asset.finalPct.toFixed(1) + '%';
    tr.appendChild(tdFinalPct);

    tbody.appendChild(tr);
  });
}

/** Single-click editing for Proposed +/- ($) or Proposed +/- (%). */
function makeEditable(cell, assetIndex, mode) {
  const oldValue = cell.textContent.replace(/[^0-9.-]/g, ''); 
  cell.onclick = null;
  cell.innerHTML = '';

  const input = document.createElement('input');
  input.type = 'text';
  input.value = oldValue || '0';
  setTimeout(() => input.select(), 0);

  input.onblur = () => finishEdit(cell, input.value, assetIndex, mode);
  input.onkeydown = (ev) => {
    if (ev.key === 'Enter') {
      ev.preventDefault();
      input.blur();
    }
  };

  cell.appendChild(input);
  input.focus();
}

/**
 * Here is the crucial fix:
 * If mode == 'percent',
 *   we interpret the typed number as "Final% = Current% + typedValue".
 *   Then final$ = final% * totalCurrent / 100.
 *   Then proposed$ = final$ - current$.
 * 
 * If mode == 'dollar',
 *   proposed$ = typedValue
 *   final$ = current$ + proposed$ 
 *   final% = ...
 */
function finishEdit(cell, rawVal, assetIndex, mode) {
  let newVal = parseFloat(rawVal) || 0;

  if (mode === 'percent') {
    // final% = current% + newVal
    // final$ = (final% / 100) * totalCurrent
    // proposed$ = final$ - current$
    const a = assets[assetIndex];
    const finalPct = a.currentPct + newVal;  // in the example, 46.8 + 3.2 = 50.0
    const finalDollar = (finalPct / 100) * totalCurrent;
    const proposedDollar = finalDollar - a.currentDollar;
    a.proposedDollar = proposedDollar;

  } else {
    // mode = 'dollar'
    // If user typed e.g. 3200 => proposedDollar = 3200
    // final$ = current$ + proposed$
    assets[assetIndex].proposedDollar = newVal;
  }

  recalcAndRender(); // re-draw the table & charts

  // Re-apply the onclick for next time
  if (mode === 'percent') {
    const displayedPct = assets[assetIndex].proposedPct.toFixed(2) + '%';
    cell.textContent = displayedPct;
    cell.onclick = () => makeEditable(cell, assetIndex, 'percent');
  } else {
    const displayedDollar = formatMoney(assets[assetIndex].proposedDollar);
    cell.textContent = displayedDollar;
    cell.onclick = () => makeEditable(cell, assetIndex, 'dollar');
  }
}

/** Rebalance button does not reset proposed amounts. */
function doRebalance() {
  document.getElementById('tradeMessage').innerHTML =
    '<span class="success">Rebalance triggered (Proposed amounts were NOT cleared).</span>';
}

/** Reset all Proposed +/- columns to zero. */
function doResetTrades() {
  assets.forEach(a => {
    a.proposedDollar = 0;
  });
  recalcAndRender();
  document.getElementById('tradeMessage').textContent = 'All proposed trades reset to 0.';
}

/** Update the two charts. */
function updateCharts() {
  // Final chart => each asset's finalDollar
  const finalVals = assets.map(a => a.finalDollar);
  const labels = assets.map(a => a.name);

  // Target chart => each asset's targetDollar
  const targetVals = assets.map(a => a.targetDollar);

  finalChart.data.labels = labels;
  finalChart.data.datasets[0].data = finalVals;
  finalChart.update();

  targetChart.data.labels = labels;
  targetChart.data.datasets[0].data = targetVals;
  targetChart.update();
}

/** Format a dollar with commas and two decimals. */
function formatMoney(value) {
  return new Intl.NumberFormat('en-US', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  }).format(value);
}

/** Initialize Chart.js pies. */
function initCharts() {
  finalChart = new Chart(document.getElementById('finalChart'), {
    type: 'pie',
    data: {
      labels: [],
      datasets: [{
        label: 'Final Allocation',
        data: [],
        backgroundColor: ['#2196f3', '#8bc34a', '#ffc107']
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: { legend: { position: 'bottom' } }
    }
  });

  targetChart = new Chart(document.getElementById('targetChart'), {
    type: 'pie',
    data: {
      labels: [],
      datasets: [{
        label: 'Target Allocation',
        data: [],
        backgroundColor: ['#2196f3', '#8bc34a', '#ffc107']
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: { legend: { position: 'bottom' } }
    }
  });
}

/** On page load. */
window.addEventListener('DOMContentLoaded', () => {
  initCharts();

  document.getElementById('newClientBtn').addEventListener('click', newRandomClient);
  document.getElementById('rebalanceBtn').addEventListener('click', doRebalance);
  document.getElementById('resetTradesBtn').addEventListener('click', doResetTrades);

  // Generate first random scenario
  newRandomClient();
});
</script>
</body>
</html>
