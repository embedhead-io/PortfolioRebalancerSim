<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Portfolio Manager Simulator – Phase 2 (CSV Import, Export, Template)</title>
  <style>
    :root {
      --bg-body: #f8f9fa;
      --bg-container: #fff;
      --text-color: #000;
      --header-footer-bg: #e9e9e9;
      --asset-col-bg: #f7f7f7;
      --proposed-col-border: #007bff;
      --editable-field-border: #ccc;
      --section-bg: #fafafa; 
    }
    body.dark-mode {
      --bg-body: #202020;
      --bg-container: #2c2c2c;
      --text-color: #eee;
      --header-footer-bg: #444;
      --asset-col-bg: #333;
      --proposed-col-border: #66afff;
      --editable-field-border: #888;
      --section-bg: #3a3a3a;
    }
    body {
      margin: 0;
      font-family: 'Helvetica Neue', Arial, sans-serif;
      min-width: 1200px;
      background: var(--bg-body);
      color: var(--text-color);
      transition: background 0.3s, color 0.3s;
    }
    .container {
      width: 90%;
      margin: 1rem auto;
      padding: 1.5rem;
      background: var(--bg-container);
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      transition: background 0.3s, color 0.3s;
    }
    h1, h2, h3 {
      margin-top: 0;
      margin-bottom: 0.75rem;
    }
    .dark-mode-toggle {
      width: 20px; 
      height: 20px;
      border-radius: 50%;
      background: #666;
      position: absolute;
      top: 10px; 
      right: 10px;
      cursor: pointer;
      border: 2px solid #999;
      transition: background 0.3s;
    }
    .dark-mode-toggle:hover { background: #444; }
    body.dark-mode .dark-mode-toggle {
      background: #aaa; border-color: #ccc;
    }
    body.dark-mode .dark-mode-toggle:hover {
      background: #ccc;
    }
    .btn {
      padding: 0.5rem 1rem;
      border: none;
      background: #007bff;
      color: #fff;
      cursor: pointer;
      border-radius: 3px;
      font-size: 0.9rem;
      margin: 0.2rem;
    }
    .btn:hover {
      background: #0069d9;
    }
    .section {
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #ddd;
    }
    .top-row {
      display: flex;
      gap: 2rem;
      margin-bottom: 1.5rem;
      align-items: flex-start;
    }
    .profile-col, .enhancements-col {
      flex: 1;
      min-width: 300px;
      background: var(--section-bg);
      border-radius: 4px;
      padding: 1rem;
    }
    .profile-col > h2, .enhancements-col > h2 {
      margin-top: 0;
      margin-bottom: 1rem;
      font-size: 1.25rem;
      border-bottom: 1px solid #ccc;
      padding-bottom: 0.5rem;
    }
    .profile-info p { margin: 0.5rem 0; }
    .profile-actions { margin-top: 1rem; }
    #riskSelect { margin-left: 0.5rem; }
    #cashTargetInput {
      width: 50px; text-align: right; margin-left: 0.5rem;
    }
    .editable-field {
      cursor: pointer;
      border: 1px dotted var(--editable-field-border);
      padding: 2px 4px;
      background: #fafafa;
      transition: border-color 0.3s;
    }
    body.dark-mode .editable-field { background: #333; }
    .editable-field input {
      width: 80px;
      border: 1px solid #007bff;
      outline: none;
      font: inherit;
      box-sizing: border-box;
      text-align: right;
    }
    #custom-profile-section h3 {
      margin-top: 0;
      margin-bottom: 0.75rem;
      font-size: 1rem;
      border-bottom: 1px solid #ccc;
      padding-bottom: 0.5rem;
    }
    #custom-profile-section label {
      display: inline-block; width: 80px;
    }
    #custom-profile-section input[type="number"] {
      width: 50px; margin-right: 1rem;
    }
    .portfolio-header {
      display: flex; align-items: center; justify-content: space-between;
      margin: 1rem 0;
    }
    .portfolio-buttons button { margin-left: 0.5rem; }
    table {
      width: 100%;
      table-layout: fixed;
      border-collapse: collapse;
      margin: 1rem 0;
      transition: background 0.3s, color 0.3s;
    }
    thead th {
      background: var(--header-footer-bg);
    }
    th, td {
      padding: 0.4rem;
      border-bottom: 1px solid #eee;
      vertical-align: middle;
      text-align: right;
      overflow: hidden;
      white-space: nowrap;
      font-size: 0.88rem;
    }
    thead th:nth-child(1)  { width: 14%; text-align: left; }
    thead th:nth-child(2)  { width: 8%; }
    thead th:nth-child(3)  { width: 8%; }
    thead th:nth-child(4)  { width: 8%; }
    thead th:nth-child(5)  { width: 8%; }
    thead th:nth-child(6)  { width: 8%; }
    thead th:nth-child(7)  { width: 8%; }
    thead th:nth-child(8)  { width: 8%; }
    thead th:nth-child(9)  { width: 8%; }
    thead th:nth-child(10) { width: 8%; }
    thead th:nth-child(11) { width: 8%; }
    th:first-child, td:first-child { text-align: left; }
    .asset-col { background: var(--asset-col-bg); font-weight: bold; }
    .proposed-col {
      border: 1px dotted var(--proposed-col-border);
      background: #fafafa;
      cursor: pointer;
      transition: border-color 0.3s;
    }
    body.dark-mode .proposed-col { background: #333; }
    .proposed-positive { color: green; font-weight: bold; }
    .proposed-negative { color: red; font-weight: bold; }
    .delta-positive { color: green; font-weight: bold; }
    .delta-negative { color: red;   font-weight: bold; }
    .expand-toggle {
      cursor: pointer; color: #007bff; margin-right: 0.5rem;
    }
    .class-row td { padding-left: 2em; }
    .position-row td { padding-left: 4em; }
    .subtotal-row td { font-weight: bold; background: #f0f0f0; }
    .total-row {
      background: var(--header-footer-bg);
      font-weight: bold;
      text-align: right;
    }
    .total-row td {
      border-top: 2px solid #ccc;
      padding: 8px;
    }
    .charts-container {
      display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap; justify-content: space-evenly;
    }
    .chart-box {
      flex: 1; min-width: 250px; max-width: 300px; max-height: 300px;
      position: relative; margin: auto; background: #f9f9f9;
      border-radius: 4px; padding: 1rem; text-align: center;
      transition: background 0.3s;
    }
    body.dark-mode .chart-box { background: #333; }
    .chart-title {
      margin-bottom: 0.5rem; font-weight: bold; font-size: 0.95rem;
    }
    .chart-box canvas {
      width: 100% !important; height: 100% !important;
    }
    .footer {
      text-align: center; margin-top: 2rem; font-size: 0.85rem;
      transition: color 0.3s;
      color: var(--text-color);
    }
    .success { color: green; font-weight: bold; }
    .error   { color: red;   font-weight: bold; }
  </style>
</head>
<body>
  
  <div class="dark-mode-toggle" id="darkModeToggle"></div>

  <div class="container">
    <h1>Portfolio Manager Simulator – Phase 2 (CSV Import, Export, Template)</h1>

    <div class="top-row">
      <!-- LEFT: Client Profile -->
      <div class="profile-col">
        <h2>Client Profile</h2>
        <div class="profile-info">
          <p><strong>Name:</strong> <span id="clientName">--</span></p>
          <p>
            <strong>Risk Tolerance:</strong>
            <select id="riskSelect">
              <option value="conservative">Conservative</option>
              <option value="moderate" selected>Moderate</option>
              <option value="aggressive">Aggressive</option>
            </select>
          </p>
          <p>
            <strong>Portfolio Value:</strong>
            $<span id="clientValue" class="editable-field">0</span>
          </p>
          <p>
            <strong>Target Allocation:</strong>
            <span id="targetStocks">--</span>% Stocks, 
            <span id="targetBonds">--</span>% Bonds, 
            <span id="targetCash">--</span>% Cash
          </p>
          <p>
            <strong>Cash Target (%):</strong>
            <input type="number" id="cashTargetInput" value="10" min="0" max="100" step="1"/>
          </p>
          <div class="profile-actions">
            <button class="btn" id="newClientBtn">Generate New Client</button>
          </div>
        </div>
      </div>
      
      <!-- RIGHT: CSV (import, export, template) + custom profile -->
      <div class="enhancements-col">
        <h2>Phase 2 Enhancements</h2>
        
        <!-- CSV Import/Export/Template -->
        <div style="margin-bottom:1rem;">
          <button class="btn" id="importCSVBtn">Import CSV</button>
          <input type="file" id="csvFileInput" accept=".csv" style="display:none"/>
          <button class="btn" id="exportCSVBtn">Export CSV</button>
          <button class="btn" id="downloadCSVTemplateBtn">Download CSV Template</button>
        </div>

        <!-- Custom Profiles -->
        <div id="custom-profile-section">
          <h3>Custom Profile</h3>
          <div>
            <label>Stocks (%):</label>
            <input type="number" id="customStockPct" value="40"/>
            <label>Bonds (%):</label>
            <input type="number" id="customBondPct" value="30"/>
          </div>
          <div style="margin-top:0.5rem;">
            <label>Cash (%):</label>
            <input type="number" id="customCashPct" value="20"/>
            <label>Real Est. (%):</label>
            <input type="number" id="customRePct" value="10"/>
          </div>
          <div style="margin-top:0.5rem;">
            <button class="btn" id="saveProfileBtn">Save as New Profile</button>
          </div>
          <div style="margin-top:0.5rem;">
            <label>Apply Profile:</label>
            <select id="customProfilesSelect">
              <option value="">--No custom profile--</option>
            </select>
            <button class="btn" id="applyProfileBtn">Apply</button>
          </div>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="portfolio-header">
        <h2>Current (or Projected) Portfolio</h2>
        <div class="portfolio-buttons">
          <button class="btn" id="rebalanceBtn">Rebalance</button>
          <button class="btn" id="resetTradesBtn">Reset Trades</button>
        </div>
      </div>

      <table id="portfolioTable">
        <thead>
          <tr>
            <th>Asset/Class/Position</th>
            <th>Current ($)</th>
            <th>Target ($)</th>
            <th>Delta ($)</th>
            <th>Proposed ($)</th>
            <th>Total ($)</th>
            <th>Current (%)</th>
            <th>Target (%)</th>
            <th>Delta (%)</th>
            <th>Proposed (%)</th>
            <th>Total (%)</th>
          </tr>
        </thead>
        <tbody id="portfolioRows"></tbody>
      </table>

      <div class="charts-container">
        <div class="chart-box">
          <div class="chart-title">Current Allocation</div>
          <canvas id="currentChart"></canvas>
        </div>
        <div class="chart-box">
          <div class="chart-title">Target Allocation</div>
          <canvas id="targetChart"></canvas>
        </div>
        <div class="chart-box">
          <div class="chart-title">Total Allocation</div>
          <canvas id="finalChart"></canvas>
        </div>
      </div>
      <p id="tradeMessage"></p>
    </div>
  </div>

  <div class="footer">
    &copy; Phase 2 – CSV Import, Export, Template
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    /***************************************************************
     * 1) Data Model & Globals
     ***************************************************************/
    let root = { name:"ROOT", expanded:true, children:[] };
    let originalData = null;
    let clientName = "";
    let totalPortfolioValue = 0;
    let originalPortfolioValue = 0;

    // For longer-term "Quantity" – not used in UI yet, but we handle columns
    // in CSV so the user can fill them for the future
    // let quantity = 0;

    let userStockPct=0.5, userBondPct=0.4, userCashPct=0.1, userRePct=0;
    let currentChart, targetChart, finalChart;
    let customProfiles={};

    /***************************************************************
     * 2) Dark Mode
     ***************************************************************/
    const darkToggle = document.getElementById('darkModeToggle');
    darkToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
    });

    /***************************************************************
     * 3) CSV Import
     ***************************************************************/
    document.getElementById('importCSVBtn').addEventListener('click', () => {
      document.getElementById('csvFileInput').click();
    });
    document.getElementById('csvFileInput').addEventListener('change', (evt) => {
      let file = evt.target.files[0];
      if(!file) return;
      let reader = new FileReader();
      reader.onload = (e) => {
        try {
          parseCSV(e.target.result);
          renderAll();
          document.getElementById('tradeMessage').textContent = "Imported from CSV.";
        } catch(err) {
          alert("Error parsing CSV: " + err);
        }
      };
      reader.readAsText(file);
    });

    /**
     * parseCSV lines. Required: Ticker. Optional columns:
     * - Current($) or Current(%)
     * - Target($)  or Target(%)
     * - Proposed($) or Proposed(%)
     * - Quantity
     * We'll store them all in a single 'CSV Imports' asset node
     */
    function parseCSV(csvText) {
      let lines = csvText.split(/\r?\n/).map(l => l.trim()).filter(l => l.length>0);
      if(lines.length<2) throw new Error("Not enough CSV lines (need header + data).");

      let header = lines[0].split(",").map(h => h.trim().toLowerCase());
      let idxTicker      = header.indexOf("ticker");
      let idxCurDollar   = header.indexOf("current($)");
      let idxCurPct      = header.indexOf("current(%)");
      let idxTarDollar   = header.indexOf("target($)");
      let idxTarPct      = header.indexOf("target(%)");
      let idxPropDollar  = header.indexOf("proposed($)");
      let idxPropPct     = header.indexOf("proposed(%)");
      let idxQty         = header.indexOf("quantity");

      if(idxTicker<0) throw new Error("CSV must have 'Ticker' column at least.");

      // We'll create a single top-level "CSV Imports" node
      let csvAsset = { name:"CSV Imports", isAsset:true, expanded:true, children:[] };

      for(let i=1; i<lines.length; i++){
        let row = lines[i].split(",").map(x=>x.trim());
        if(row.length<1) continue;
        let ticker = row[idxTicker]||"";
        if(!ticker) continue; // skip row if no Ticker

        let curDollar=0, tarDollar=0, propDollar=0;
        // parse optional fields:
        if(idxCurDollar>=0 && row[idxCurDollar]) {
          curDollar = parseFloat(row[idxCurDollar].replace(/[$]/g,""))||0;
        } else if(idxCurPct>=0 && row[idxCurPct]) {
          let cPct = parseFloat(row[idxCurPct].replace(/[%]/g,""))||0;
          curDollar = (cPct/100)*totalPortfolioValue;
        }
        if(idxTarDollar>=0 && row[idxTarDollar]) {
          tarDollar = parseFloat(row[idxTarDollar].replace(/[$]/g,""))||0;
        } else if(idxTarPct>=0 && row[idxTarPct]) {
          let tPct = parseFloat(row[idxTarPct].replace(/[%]/g,""))||0;
          tarDollar= (tPct/100)*totalPortfolioValue;
        }
        if(idxPropDollar>=0 && row[idxPropDollar]) {
          propDollar = parseFloat(row[idxPropDollar].replace(/[$]/g,""))||0;
        } else if(idxPropPct>=0 && row[idxPropPct]) {
          let pPct = parseFloat(row[idxPropPct].replace(/[%]/g,""))||0;
          propDollar= (pPct/100)*totalPortfolioValue;
        }

        let qty=0;
        if(idxQty>=0 && row[idxQty]) {
          qty = parseFloat(row[idxQty])||0;
        }

        let node = {
          name: ticker,
          isPosition: true,
          expanded: true,
          currentDollar:  curDollar,
          targetDollar:   tarDollar,
          proposedDollar: propDollar,
          totalDollar:    0,
          quantity: qty // placeholder for future
        };
        csvAsset.children.push(node);
      }
      if(csvAsset.children.length<1) throw new Error("No valid Ticker rows found in CSV.");

      // replace root
      root = { name:"ROOT", expanded:true, children:[csvAsset] };
    }

    /***************************************************************
     * 4) CSV Export
     ***************************************************************/
    document.getElementById('exportCSVBtn').addEventListener('click', exportCSVPortfolio);

    function exportCSVPortfolio(){
      // flatten positions
      let positions = [];
      flattenPositions(root, positions);

      // columns
      let lines=[];
      lines.push("Ticker,Current($),Current(%),Target($),Target(%),Proposed($),Proposed(%),Quantity");
      positions.forEach(pos => {
        // We'll do 2 decimals for $ and % fields
        let cDollar=(pos.currentDollar||0).toFixed(2);
        let cPct   =(pos.currentPct||0).toFixed(2);
        let tDollar=(pos.targetDollar||0).toFixed(2);
        let tPct   =(pos.targetPct||0).toFixed(2);
        let pDollar=(pos.proposedDollar||0).toFixed(2);
        let pPct   =(pos.proposedPct||0).toFixed(2);
        let qty    =(pos.quantity||0).toString();

        // combine row
        let row=`${pos.name},${cDollar},${cPct},${tDollar},${tPct},${pDollar},${pPct},${qty}`;
        lines.push(row);
      });

      let csvStr=lines.join("\n");
      let blob = new Blob([csvStr], {type:"text/csv"});
      let url = URL.createObjectURL(blob);
      let a=document.createElement('a');
      a.href=url;
      a.download="portfolio_export.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function flattenPositions(node, out){
      if(node.isPosition){
        out.push(node);
        return;
      }
      if(node.children && node.children.length>0){
        node.children.forEach(ch => flattenPositions(ch, out));
      }
    }

    /***************************************************************
     * 5) Download CSV Template
     ***************************************************************/
    document.getElementById('downloadCSVTemplateBtn').addEventListener('click', downloadCSVTemplate);

    function downloadCSVTemplate(){
      // minimal example with one line of data
      let lines = [
        "Ticker,Current($),Current(%),Target($),Target(%),Proposed($),Proposed(%),Quantity",
        "AAPL,5000,,6000,,100,,50"
      ];
      let csvStr = lines.join("\n");
      let blob = new Blob([csvStr], {type:"text/csv"});
      let url = URL.createObjectURL(blob);
      let a = document.createElement('a');
      a.href = url;
      a.download = "portfolio_template.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    /***************************************************************
     * 6) Custom Profiles, Negative Proposed, Rebalance, etc.
     *    (Same as prior Phase 2 code)
     ***************************************************************/
    let customProfileSection = document.getElementById('custom-profile-section');
    // Save
    document.getElementById('saveProfileBtn').addEventListener('click', () => {
      let s = parseFloat(document.getElementById('customStockPct').value)||0;
      let b = parseFloat(document.getElementById('customBondPct').value)||0;
      let c = parseFloat(document.getElementById('customCashPct').value)||0;
      let re= parseFloat(document.getElementById('customRePct').value)||0;
      let sum=s+b+c+re;
      if(Math.abs(sum-100)>0.001){
        alert("Your custom percentages must total 100%!");
        return;
      }
      let profName = prompt("Enter a name for this profile:", "MyCustomProfile");
      if(!profName)return;

      customProfiles[profName]={stocks:s/100, bonds:b/100, cash:c/100, re:re/100};
      let sel=document.getElementById('customProfilesSelect');
      let opt=document.createElement('option');
      opt.value=profName; opt.textContent=profName;
      sel.appendChild(opt);
      alert("Profile saved!");
    });
    // Apply
    document.getElementById('applyProfileBtn').addEventListener('click', () => {
      let selVal=document.getElementById('customProfilesSelect').value;
      if(!selVal||!customProfiles[selVal]){
        alert("No custom profile selected.");
        return;
      }
      let pr=customProfiles[selVal];
      userStockPct=pr.stocks; userBondPct=pr.bonds; userCashPct=pr.cash; userRePct=pr.re;
      document.getElementById('targetStocks').textContent=(userStockPct*100).toFixed(0);
      document.getElementById('targetBonds').textContent =(userBondPct*100).toFixed(0);
      document.getElementById('targetCash').textContent  =(userCashPct*100).toFixed(0);
      applyRiskAllocation();
      renderAll();
    });

    // Negative Proposed allowed, Rebalance sets Proposed = Target - Current
    document.getElementById('rebalanceBtn').addEventListener('click', () => {
      setProposedRebalance(root);
      renderAll();
      document.getElementById('tradeMessage').textContent="Rebalanced to target allocations.";
    });
    function setProposedRebalance(node){
      if(!node.children||node.children.length===0){
        node.proposedDollar=(node.targetDollar||0)-(node.currentDollar||0);
        return;
      }
      node.children.forEach(ch=>setProposedRebalance(ch));
    }

    // Risk Tolerance
    document.getElementById('riskSelect').addEventListener('change', onRiskChange);
    function onRiskChange(){
      let val=document.getElementById('riskSelect').value;
      if(val==="conservative"){
        userStockPct=0.3; userBondPct=0.5; userCashPct=0.2; userRePct=0;
      } else if(val==="aggressive"){
        userStockPct=0.7; userBondPct=0.2; userCashPct=0.1; userRePct=0;
      } else {
        userStockPct=0.5; userBondPct=0.4; userCashPct=0.1; userRePct=0;
      }
      document.getElementById('cashTargetInput').value=(userCashPct*100).toFixed(0);
      document.getElementById('targetStocks').textContent=(userStockPct*100).toFixed(0);
      document.getElementById('targetBonds').textContent =(userBondPct*100).toFixed(0);
      document.getElementById('targetCash').textContent  =(userCashPct*100).toFixed(0);
      applyRiskAllocation();
      renderAll();
    }
    document.getElementById('cashTargetInput').addEventListener('change',()=>{
      let newC=parseFloat(document.getElementById('cashTargetInput').value)||0;
      if(newC<0)newC=0; if(newC>100)newC=100;
      userCashPct=newC/100;
      let oldStock=userStockPct, oldBond=userBondPct, oldRe=userRePct;
      let oldSum=oldStock+oldBond+oldRe;
      let leftover=1-userCashPct;
      if(oldSum<0.0001){
        userStockPct=leftover; userBondPct=0; userRePct=0;
      }else{
        let ratio=leftover/oldSum;
        userStockPct*=ratio; userBondPct*=ratio; userRePct*=ratio;
      }
      document.getElementById('targetStocks').textContent=(userStockPct*100).toFixed(0);
      document.getElementById('targetBonds').textContent =(userBondPct*100).toFixed(0);
      document.getElementById('targetCash').textContent  =(userCashPct*100).toFixed(0);
      applyRiskAllocation();
      renderAll();
    });

    // "Generate New Client", "Reset"
    document.getElementById('newClientBtn').addEventListener('click', doGenerateNewClient);
    function doGenerateNewClient(){
      const names=["John Smith","Jane Doe","Alex Johnson","Maria Garcia","Lee Wong"];
      let nm=names[Math.floor(Math.random()*names.length)];
      clientName=nm; 
      document.getElementById('clientName').textContent=nm;
      let val=80000+Math.random()*40000; //80k-120k
      val=Math.round(val/100)*100;
      totalPortfolioValue=val;
      document.getElementById('clientValue').textContent=formatMoney(val);

      generateRandomNestedData();
      aggregateNode(root);
      let sumCur=root.currentDollar||1;
      let ratio=totalPortfolioValue/sumCur;
      scaleNode(root,ratio);
      aggregateNode(root);

      originalData=JSON.parse(JSON.stringify(root));
      originalPortfolioValue=val;

      applyRiskAllocation();
      renderAll();
    }
    function scaleNode(node,ratio){
      if(!node.children||node.children.length===0){
        node.currentDollar=Math.round(node.currentDollar*ratio);
        node.targetDollar=Math.round(node.targetDollar*ratio);
        return;
      }
      node.children.forEach(ch=>scaleNode(ch,ratio));
    }
    document.getElementById('resetTradesBtn').addEventListener('click', ()=>{
      if(originalData){
        root=JSON.parse(JSON.stringify(originalData));
        totalPortfolioValue=originalPortfolioValue;
        document.getElementById('clientValue').textContent=formatMoney(totalPortfolioValue);
        renderAll();
        document.getElementById('tradeMessage').textContent="Reset to initial scenario.";
      }
    });

    // Risk-based distribution
    function applyRiskAllocation(){
      let tVal=totalPortfolioValue;
      let stVal=userStockPct*tVal;
      let bdVal=userBondPct *tVal;
      let chVal=userCashPct *tVal;
      let reVal=userRePct   *tVal;
      root.children.forEach(ch=>{
        if(/stock/i.test(ch.name))ch.targetDollar=stVal;
        else if(/bond/i.test(ch.name))ch.targetDollar=bdVal;
        else if(/cash/i.test(ch.name))ch.targetDollar=chVal;
        else if(/real estate/i.test(ch.name))ch.targetDollar=reVal;
        else ch.targetDollar=0;
      });
      root.children.forEach(ch=>distributeTargets(ch));
    }
    function distributeTargets(node){
      if(!node.children||node.children.length===0)return;
      let totalCur=node.children.reduce((acc,c)=>acc+(c.currentDollar||0),0);
      if(totalCur<1) totalCur=1;
      node.children.forEach(ch=>{
        let ratio=(ch.currentDollar||0)/totalCur;
        ch.targetDollar=node.targetDollar*ratio;
        distributeTargets(ch);
      });
    }

    /***************************************************************
     * 7) Table Rendering, Proposed Editing, Negative Proposed
     ***************************************************************/
    // (Already defined above)

    /***************************************************************
     * 8) Recalc & Rerender
     ***************************************************************/
    function renderAll(){
      aggregateNode(root);
      computePercentages(root,root);
      renderTable();
      updateCharts();
    }

    /***************************************************************
     * 9) Charts
     ***************************************************************/
    function initCharts(){
      currentChart=new Chart(document.getElementById('currentChart'), {
        type:'pie',
        data:{
          labels:[],
          datasets:[{
            label:'Current',
            data:[],
            backgroundColor:['#2196f3','#8bc34a','#ffc107','#ff5722']
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:true,
          plugins:{ legend:{position:'bottom'} }
        }
      });
      targetChart=new Chart(document.getElementById('targetChart'), {
        type:'pie',
        data:{
          labels:[],
          datasets:[{
            label:'Target',
            data:[],
            backgroundColor:['#2196f3','#8bc34a','#ffc107','#ff5722']
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:true,
          plugins:{ legend:{position:'bottom'} }
        }
      });
      finalChart=new Chart(document.getElementById('finalChart'), {
        type:'pie',
        data:{
          labels:[],
          datasets:[{
            label:'Total',
            data:[],
            backgroundColor:['#2196f3','#8bc34a','#ffc107','#ff5722']
          }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:true,
          plugins:{ legend:{position:'bottom'} }
        }
      });
    }
    function updateCharts(){
      let labels=[], curVals=[], tarVals=[], totVals=[];
      root.children.forEach(ch=>{
        labels.push(ch.name);
        curVals.push(ch.currentDollar ||0);
        tarVals.push(ch.targetDollar ||0);
        totVals.push(ch.totalDollar  ||0);
      });
      currentChart.data.labels=labels;
      currentChart.data.datasets[0].data=curVals;
      currentChart.update();

      targetChart.data.labels=labels;
      targetChart.data.datasets[0].data=tarVals;
      targetChart.update();

      finalChart.data.labels=labels;
      finalChart.data.datasets[0].data=totVals;
      finalChart.update();
    }

    /***************************************************************
     * 10) Utility
     ***************************************************************/
    function formatMoney(x){
      return new Intl.NumberFormat('en-US',{
        style:'decimal',
        minimumFractionDigits:2,
        maximumFractionDigits:2
      }).format(x);
    }
    function colorDeltaCell(td,val){
      td.classList.remove('delta-positive','delta-negative');
      let r=parseFloat(val.toFixed(2));
      if(Math.abs(r)<0.01){
        // zero => no color
      } else if(r<0){
        td.classList.add('delta-negative');
      } else {
        td.classList.add('delta-positive');
      }
    }
    function withSignMoney(v){
      let r=parseFloat(v.toFixed(2));
      if(Math.abs(r)<0.01)r=0;
      let absVal=Math.abs(r);
      let absStr=formatMoney(absVal);
      if(r>0)return `+${absStr}`;
      if(r<0)return `-${absStr}`;
      return absStr;
    }
    function withSignPct(v){
      let r=parseFloat(v.toFixed(2));
      if(Math.abs(r)<0.01)r=0;
      let absVal=Math.abs(r).toFixed(2);
      if(r>0)return `+${absVal}%`;
      if(r<0)return `-${absVal}%`;
      return "0.00%";
    }

    /***************************************************************
     * 11) Enable Editing of Portfolio Value
     ***************************************************************/
    function enablePortfolioValueEdit(){
      const valElem=document.getElementById('clientValue');
      valElem.addEventListener('click',()=>{
        const oldVal=valElem.textContent.replace(/,/g,'').replace(/[^\d.\-+]/g,'');
        valElem.innerHTML='';
        const input=document.createElement('input');
        input.type='text';
        input.value=oldVal||'0';
        input.onblur=function(){
          let parsed=parseFloat(input.value.replace(/,/g,''))||0;
          if(parsed<1)parsed=1;
          totalPortfolioValue=parsed;
          valElem.innerHTML=formatMoney(parsed);
          onRiskChange();
        };
        input.onkeydown=function(e){
          if(e.key==='Enter'){
            e.preventDefault();
            input.blur();
          }
        };
        valElem.appendChild(input);
        input.select();
      });
    }

    /***************************************************************
     * 12) Startup
     ***************************************************************/
    window.addEventListener('DOMContentLoaded',()=>{
      initCharts();
      enablePortfolioValueEdit();

      // Make sure we do the initial risk re-calc
      onRiskChange();
      doGenerateNewClient();
    });
  </script>
</body>
</html>
