<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Portfolio Manager Simulator – Nested Aggregation</title>
  <style>
    /****************************************
     * LIGHT/DARK MODE THEMES
     ****************************************/
    :root {
      /* Default Light Mode */
      --bg-body: #f8f9fa;
      --bg-container: #fff;
      --text-color: #000;
      --header-footer-bg: #e9e9e9;
      --asset-col-bg: #f7f7f7;
      --proposed-col-border: #007bff;
      --editable-field-border: #ccc;
    }
    body.dark-mode {
      /* Dark Mode overrides */
      --bg-body: #202020;
      --bg-container: #2c2c2c;
      --text-color: #eee;
      --header-footer-bg: #444;
      --asset-col-bg: #333;
      --proposed-col-border: #66afff;
      --editable-field-border: #888;
    }

    body {
      margin: 0;
      font-family: 'Helvetica Neue', Arial, sans-serif;
      /* Force landscape/wide layout */
      min-width: 1200px;

      background: var(--bg-body);
      color: var(--text-color);
      transition: background 0.3s, color 0.3s;
    }
    .container {
      max-width: 1200px;
      margin: 1rem auto;
      padding: 1.5rem;
      background: var(--bg-container);
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      transition: background 0.3s, color 0.3s;
    }

    h1, h2 {
      margin-top: 0;
      margin-bottom: 0.75rem;
    }

    .section {
      margin-bottom: 1.5rem;
      border-bottom: 1px solid #ddd;
      padding-bottom: 1rem;
    }
    .btn {
      padding: 0.4rem 0.8rem;
      border: none;
      background: #007bff;
      color: #fff;
      cursor: pointer;
      border-radius: 3px;
      margin-left: 0.5rem;
      font-size: 0.9rem;
    }
    .btn:hover {
      background: #0069d9;
    }

    /* Dot button for Dark Mode toggling */
    .dark-mode-toggle {
      width: 20px; height: 20px;
      border-radius: 50%;
      background: #666;
      position: absolute;
      top: 10px; right: 10px;
      cursor: pointer;
      border: 2px solid #999;
      transition: background 0.3s;
    }
    .dark-mode-toggle:hover { background: #444; }
    body.dark-mode .dark-mode-toggle {
      background: #aaa;
      border-color: #ccc;
    }
    body.dark-mode .dark-mode-toggle:hover {
      background: #ccc;
    }

    /* Profile Layout */
    #client-profile {
      display: flex; 
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .profile-info {
      flex: 1; 
      min-width: 320px;
      margin-right: 1rem;
    }
    .profile-actions {
      margin-top: 1rem;
    }
    #riskSelect { margin-left: 0.5rem; }

    /* Editable (Portfolio Value) */
    .editable-field {
      cursor: pointer;
      border: 1px dotted var(--editable-field-border);
      padding: 2px 4px;
      background: #fafafa;
      transition: border-color 0.3s;
    }
    body.dark-mode .editable-field { background: #333; }
    .editable-field input {
      width: 80px; 
      border: 1px solid #007bff;
      outline: none; 
      font: inherit; 
      box-sizing: border-box;
      text-align: right;
    }

    /* Table with expansions */
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 0.5rem 0;
      transition: background 0.3s, color 0.3s;
    }
    thead th {
      background: var(--header-footer-bg);
    }
    tfoot td {
      background: var(--header-footer-bg);
      font-weight: bold;
    }
    th, td {
      text-align: left;
      padding: 0.4rem;
      border-bottom: 1px solid #eee;
      vertical-align: middle;
    }
    /* Asset column => bold text, slightly darker BG */
    .asset-col {
      background: var(--asset-col-bg);
      font-weight: bold;
      transition: background 0.3s;
    }
    /* Proposed columns => color invert from final columns:
       if proposed>0 => green/bold, <0 => red/bold, zero => black.
    */
    .proposed-col {
      border: 1px dotted var(--proposed-col-border);
      background: #fafafa;
      cursor: pointer;
      transition: border-color 0.3s;
    }
    body.dark-mode .proposed-col { background: #333; }
    .proposed-positive { color: green; font-weight: bold; }
    .proposed-negative { color: red;   font-weight: bold; }

    /* Delta => final surplus/deficit => positive => red/bold, negative => green/bold, zero => black */
    .delta-positive { color: red;   font-weight: bold; }
    .delta-negative { color: green; font-weight: bold; }

    /* Expand toggles */
    .expand-toggle {
      cursor: pointer; color: #007bff; margin-right: 0.5rem;
    }
    .hidden { display: none; }

    /* Indentation for sub-levels */
    .class-row td { padding-left: 2em; }
    .position-row td { padding-left: 4em; }

    /* 
      We'll highlight TOT row in sub-level 
      Optional: entire row bold or some style
    */
    .subtotal-row td { font-weight: bold; background: #f0f0f0; }
    /* 3 smaller charts side by side */
    .charts-container {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
      flex-wrap: wrap;
      justify-content: space-evenly;
    }
    .chart-box {
      flex: 1;
      min-width: 250px; 
      max-width: 300px; 
      max-height: 300px;
      position: relative;
      margin: auto; 
      background: #f9f9f9;
      border-radius: 4px; 
      padding: 1rem; 
      text-align: center;
      transition: background 0.3s;
    }
    body.dark-mode .chart-box { background: #333; }
    .chart-title {
      margin-bottom: 0.5rem; 
      font-weight: bold;
    }
    .chart-box canvas {
      width: 100% !important; 
      height: 100% !important;
    }

    .footer {
      text-align: center;
      margin-top: 2rem;
      font-size: 0.85rem;
      transition: color 0.3s;
      color: var(--text-color);
    }
    .success { color: green; font-weight: bold; }
    .error   { color: red;   font-weight: bold; }
  </style>
</head>
<body>

<!-- Dot button for Dark Mode toggle (appended in JS or we can define here) -->
<div class="dark-mode-toggle" id="darkModeToggle"></div>

<div class="container">
  <h1>Portfolio Manager Simulator – Nested Aggregation</h1>
  
  <!-- CLIENT PROFILE -->
  <div id="client-profile" class="section">
    <div class="profile-info">
      <p><strong>Name:</strong> <span id="clientName">--</span></p>
      <p>
        <strong>Risk Tolerance:</strong>
        <select id="riskSelect">
          <option value="conservative">Conservative</option>
          <option value="moderate" selected>Moderate</option>
          <option value="aggressive">Aggressive</option>
        </select>
      </p>
      <p>
        <strong>Portfolio Value:</strong>
        $<span id="clientValue" class="editable-field">0</span>
      </p>
      <p>
        <strong>Target Allocation:</strong>
        <span id="targetStocks">--</span>% Stocks,
        <span id="targetBonds">--</span>% Bonds,
        <span id="targetCash">--</span>% Cash
      </p>
      <div class="profile-actions">
        <button class="btn" id="newClientBtn">Generate New Client</button>
      </div>
    </div>
  </div>

  <!-- TABLE & CHARTS -->
  <div class="section">
    <div class="portfolio-header">
      <h2>Current (or Projected) Portfolio</h2>
      <div class="portfolio-buttons">
        <button class="btn" id="resetTradesBtn">Reset Trades</button>
      </div>
    </div>

    <table id="portfolioTable">
      <thead>
        <tr>
          <th>Asset/Class/Position</th>
          <th>Current ($)</th>
          <th>Target ($)</th>
          <th>Proposed +/- ($)</th>
          <th>Final ($)</th>
          <th>Delta ($)</th>
          <th>Current (%)</th>
          <th>Target (%)</th>
          <th>Proposed +/- (%)</th>
          <th>Final (%)</th>
          <th>Delta (%)</th>
        </tr>
      </thead>
      <tbody id="portfolioRows"></tbody>
      <tfoot>
        <tr id="totalRow"></tr>
      </tfoot>
    </table>

    <div class="charts-container">
      <div class="chart-box">
        <div class="chart-title">Current Allocation</div>
        <canvas id="currentChart"></canvas>
      </div>
      <div class="chart-box">
        <div class="chart-title">Target Allocation</div>
        <canvas id="targetChart"></canvas>
      </div>
      <div class="chart-box">
        <div class="chart-title">Final Allocation</div>
        <canvas id="finalChart"></canvas>
      </div>
    </div>

    <p id="tradeMessage"></p>
  </div>
</div>

<div class="footer">
  &copy; Final Example – Expandable Nested Aggregation with Proposed Inversion & Dark Mode
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/************************************************************************
 * 1) Data Model
 * We store nested assets => classes => positions, each with numeric fields.
 ************************************************************************/
let totalPortfolioValue = 0;
let originalPortfolioValue = 0;
let clientName = "";
let userStockPct=0.5, userBondPct=0.4, userCashPct=0.1; // default: moderate

// We'll store the entire nested structure in a "portfolioRoot" object
let portfolioRoot = {
  name: "ROOT",
  expanded: true, // always expanded
  children: []    // each child is an "asset"
};

// A simple reference for fallback
let originalPortfolioData = null; // for reset

/************************************************************************
 * 2) Dark Mode Toggle
 ************************************************************************/
const darkToggle = document.getElementById('darkModeToggle');
darkToggle.addEventListener('click', () => {
  document.body.classList.toggle('dark-mode');
});

/************************************************************************
 * 3) Generating a Random Client & Nested Data
 ************************************************************************/
function generateRandomClient() {
  const names = ["John Smith","Jane Doe","Alex Johnson","Maria Garcia"];
  let randomName = names[Math.floor(Math.random()*names.length)];
  let val = 80000 + Math.random()*40000; // 80k to 120k
  let portfolioVal = Math.round(val/100)*100; // round to nearest 100

  clientName = randomName;
  totalPortfolioValue = portfolioVal;
  originalPortfolioValue = portfolioVal;

  // Clear old structure
  portfolioRoot.children = [];
  // Example: 2 top-level Assets: "Stocks", "Bonds"
  let stocks = {
    name: "Stocks",
    isAsset: true,
    expanded: false,
    children: []
  };
  let bonds = {
    name: "Bonds",
    isAsset: true,
    expanded: false,
    children: []
  };

  // Let's randomly add Classes to Stocks
  stocks.children.push({
    name: "Large Cap",
    isClass: true,
    expanded: false,
    children: [
      makeRandomPosition("AAPL"),
      makeRandomPosition("MSFT")
    ]
  });
  stocks.children.push({
    name: "Small Cap",
    isClass: true,
    expanded: false,
    children: [
      makeRandomPosition("RGEN"),
      makeRandomPosition("FIZZ")
    ]
  });

  // Bonds might have no sub-classes, just positions
  bonds.children.push(makeRandomPosition("Corp Bond A"));
  bonds.children.push(makeRandomPosition("Gov Bond B"));

  portfolioRoot.children.push(stocks);
  portfolioRoot.children.push(bonds);

  // Save a copy for resets
  originalPortfolioData = JSON.parse(JSON.stringify(portfolioRoot));
}

/** Utility to produce a random position node */
function makeRandomPosition(tickerName) {
  let cur = 3000 + Math.random()*9000; // between 3k and 12k
  let tar = cur + (Math.random()-0.5)*2000; // target near current
  return {
    name: tickerName,
    isPosition: true,
    expanded: false,
    currentDollar: Math.round(cur/100)*100,
    targetDollar: Math.round(tar/100)*100,
    proposedDollar: 0,
    finalDollar: 0
  };
}

/************************************************************************
 * 4) Aggregating the Nested Structure
 *    We sum up each node's children to fill currentDollar, targetDollar, etc.
 ************************************************************************/
function aggregateNode(node) {
  // If it's a position (leaf), finalize it
  if(node.isPosition) {
    node.finalDollar = node.currentDollar + node.proposedDollar;
    return;
  }
  // If it has children, reset sums to zero, then aggregate each child
  let cDollar=0, tDollar=0, pDollar=0, fDollar=0;
  node.children.forEach(child => {
    aggregateNode(child);
    // Summation
    if(child.isPosition || child.isClass || child.isAsset) {
      cDollar += (child.currentDollar||0);
      tDollar += (child.targetDollar||0);
      pDollar += (child.proposedDollar||0);
      fDollar += (child.finalDollar||0);
    }
  });
  node.currentDollar = cDollar;
  node.targetDollar  = tDollar;
  node.proposedDollar= pDollar;
  node.finalDollar   = fDollar;
}

/************************************************************************
 * 5) Rendering Table Recursively
 ************************************************************************/
const tbody = document.getElementById('portfolioRows');
const tfoot = document.getElementById('totalRow');

function renderPortfolioTable() {
  // Clear
  tbody.innerHTML="";
  // Recursively build rows
  portfolioRoot.children.forEach(asset => buildRows(asset, 0));
  // Build total row
  buildTotalRow();
}

function buildRows(node, level) {
  // node can be isAsset, isClass, or isPosition
  // We'll create one row for 'node'. If expanded, create sub-rows for its children
  let tr = document.createElement('tr');
  
  // 1) First col => expand toggle + name
  let tdName = document.createElement('td');
  if(node.isAsset) tdName.className='asset-col';
  let toggle = document.createElement('span');
  toggle.className='expand-toggle';
  // If it has children, show a toggle
  if(node.children && node.children.length>0) {
    toggle.textContent = node.expanded? "▼":"▶";
    toggle.onclick = ()=>{
      node.expanded=!node.expanded;
      renderAll();
    };
    tdName.appendChild(toggle);
  }
  // Indent
  if(node.isClass) tr.classList.add('class-row');
  if(node.isPosition) tr.classList.add('position-row');
  tdName.appendChild(document.createTextNode(node.name));
  tr.appendChild(tdName);

  // 2) Current($)
  let tdCur= document.createElement('td');
  tdCur.textContent= formatMoney(node.currentDollar||0);
  tr.appendChild(tdCur);

  // 3) Target($)
  let tdTar= document.createElement('td');
  tdTar.textContent= formatMoney(node.targetDollar||0);
  tr.appendChild(tdTar);

  // 4) Proposed($)
  let tdProp= document.createElement('td');
  tdProp.className='proposed-col';
  // color logic => positive => green, negative => red
  let pd = node.proposedDollar||0;
  if(Math.abs(pd)>0.01) {
    if(pd>0) tdProp.classList.add('proposed-positive');
    else tdProp.classList.add('proposed-negative');
  }
  tdProp.textContent= formatMoney(pd);
  // In a real app, you'd let them edit on single click
  tr.appendChild(tdProp);

  // 5) Final($)
  let tdFin= document.createElement('td');
  tdFin.textContent= formatMoney(node.finalDollar||0);
  tr.appendChild(tdFin);

  // 6) Delta($) => target - final
  let dd= (node.targetDollar||0) - (node.finalDollar||0);
  let tdDelta= document.createElement('td');
  tdDelta.textContent= withSignMoney(dd);
  colorDeltaCell(tdDelta, dd);
  tr.appendChild(tdDelta);

  // For the next columns (7..11), we can do real percentages or placeholders
  let tdCurPct= document.createElement('td');
  tdCurPct.textContent="---%"; // or we can compute absolute
  tr.appendChild(tdCurPct);

  let tdTarPct= document.createElement('td');
  tdTarPct.textContent="---%";
  tr.appendChild(tdTarPct);

  let tdPropPct= document.createElement('td');
  tdPropPct.className='proposed-col';
  if(Math.abs(pd)>0.01) {
    if(pd>0) tdPropPct.classList.add('proposed-positive');
    else tdPropPct.classList.add('proposed-negative');
  }
  tdPropPct.textContent="---%";
  tr.appendChild(tdPropPct);

  let tdFinPct= document.createElement('td');
  tdFinPct.textContent="---%";
  tr.appendChild(tdFinPct);

  let tdDeltaPct= document.createElement('td');
  tdDeltaPct.textContent="+0.00%";
  tr.appendChild(tdDeltaPct);

  tbody.appendChild(tr);

  // If expanded and has children, build sub-rows
  if(node.expanded && node.children && node.children.length>0) {
    node.children.forEach(child => buildRows(child, level+1));
    // Subtotal row
    buildSubTotalRow(node, level);
  }
}

// Subtotal row for each node if you like
function buildSubTotalRow(node, level) {
  let tr= document.createElement('tr');
  tr.className='subtotal-row';
  let td= document.createElement('td');
  td.colSpan= 11;
  td.textContent= `[Subtotal] ${node.name}`;
  tr.appendChild(td);
  tbody.appendChild(tr);
}

// Very top-level total row
function buildTotalRow() {
  tfoot.innerHTML="";
  let tr= document.createElement('tr');
  let td= document.createElement('td');
  td.colSpan=11;
  td.textContent="TOTAL PORTFOLIO";
  tr.appendChild(td);
  tfoot.appendChild(tr);
}

/************************************************************************
 * 6) Summation & Rerender
 ************************************************************************/
function renderAll() {
  // 1) Aggregate from bottom up
  aggregateNode(portfolioRoot);
  // 2) render table
  renderPortfolioTable();
  // 3) update charts
  updateCharts();
}

/************************************************************************
 * Chart placeholders
 ************************************************************************/
function initCharts() {
  currentChart= new Chart(document.getElementById('currentChart'), {
    type:'pie',
    data:{ 
      labels:[], 
      datasets:[{ label:'Current', data:[], backgroundColor:['#2196f3','#8bc34a','#ffc107']}]
    },
    options:{ responsive:true, maintainAspectRatio:true, plugins:{ legend:{ position:'bottom'}} }
  });
  targetChart= new Chart(document.getElementById('targetChart'), {
    type:'pie',
    data:{ 
      labels:[], 
      datasets:[{ label:'Target', data:[], backgroundColor:['#2196f3','#8bc34a','#ffc107']}]
    },
    options:{ responsive:true, maintainAspectRatio:true, plugins:{ legend:{ position:'bottom'}} }
  });
  finalChart= new Chart(document.getElementById('finalChart'), {
    type:'pie',
    data:{ 
      labels:[], 
      datasets:[{ label:'Final', data:[], backgroundColor:['#2196f3','#8bc34a','#ffc107']}]
    },
    options:{ responsive:true, maintainAspectRatio:true, plugins:{ legend:{ position:'bottom'}} }
  });
}

// For demonstration, we'll skip real chart data population or implement it similarly
function updateCharts() {
  // This is where you'd gather top-level "Stocks/Bonds" sums, feed into currentChart, etc.
  currentChart.update();
  targetChart.update();
  finalChart.update();
}

/************************************************************************
 * Color & Format Helpers
 ************************************************************************/
// Proposed: positive => green bold, negative => red bold, zero => black
function applyProposedColor(cell, value) {
  cell.classList.remove('proposed-positive','proposed-negative');
  if(Math.abs(value)<0.01) {
    // zero => black
  } else if(value>0) {
    cell.classList.add('proposed-positive');
  } else {
    cell.classList.add('proposed-negative');
  }
}

// Delta: positive => red bold, negative => green bold, zero => black
function colorDeltaCell(td, val){
  td.classList.remove('delta-positive','delta-negative');
  let r= parseFloat(val.toFixed(2));
  if(Math.abs(r)<0.01) {
    // zero => black
  } else if(r>0) {
    td.classList.add('delta-positive');
  } else {
    td.classList.add('delta-negative');
  }
}

/** + or - sign + comma formatting */
function withSignMoney(value){
  let r= parseFloat(value.toFixed(2));
  if(Math.abs(r)<0.01) r=0;
  let absVal=Math.abs(r);
  let absStr=formatMoney(absVal);
  if(r>0) return `+${absStr}`;
  else if(r<0) return `-${absStr}`;
  return absStr;
}

/** Just a placeholder, we show 0.00% if zero */
function withSignPct(value){
  let r=parseFloat(value.toFixed(2));
  if(Math.abs(r)<0.01) r=0;
  let absStr=Math.abs(r).toFixed(2);
  if(r>0) return `+${absStr}%`;
  else if(r<0) return `-${absStr}%`;
  return "0.00%";
}

/** Thousands-separators, 2 decimals. */
function formatMoney(x) {
  return new Intl.NumberFormat('en-US',{
    minimumFractionDigits:2,
    maximumFractionDigits:2
  }).format(x);
}

/************************************************************************
 * 7) Risk Handling
 ************************************************************************/
function readRiskSelect() {
  const val=document.getElementById('riskSelect').value;
  if(val==="conservative") {
    userStockPct=0.3; userBondPct=0.5; userCashPct=0.2;
  } else if(val==="aggressive") {
    userStockPct=0.7; userBondPct=0.2; userCashPct=0.1;
  } else {
    userStockPct=0.5; userBondPct=0.4; userCashPct=0.1;
  }
  document.getElementById('targetStocks').textContent=(userStockPct*100).toFixed(0);
  document.getElementById('targetBonds').textContent=(userBondPct*100).toFixed(0);
  document.getElementById('targetCash').textContent=(userCashPct*100).toFixed(0);
}

/************************************************************************
 * 8) Portfolio Value Editable
 ************************************************************************/
function enablePortfolioValueEdit() {
  const valSpan=document.getElementById('clientValue');
  valSpan.onclick= function onClick() {
    let oldStr= valSpan.textContent.replace(/[^\d.-]/g,'');
    let oldVal=parseFloat(oldStr)||0;

    valSpan.onclick=null;
    valSpan.innerHTML='';

    const inp=document.createElement('input');
    inp.type='text';
    inp.value=oldStr||'0';
    setTimeout(()=>inp.select(),0);

    inp.onblur=()=> finishEdit(inp.value,oldVal);
    inp.onkeydown=(ev)=>{
      if(ev.key==='Enter'){
        ev.preventDefault();inp.blur();
      }
    };
    valSpan.appendChild(inp);
    inp.focus();

    function finishEdit(newStr, oldVal) {
      let newVal=parseFloat(newStr)||0;
      if(newVal<=0) newVal=oldVal;
      newVal=Math.round(newVal/100)*100;

      if(Math.abs(newVal-oldVal)>0.00001 && oldVal>0) {
        let scale=newVal/oldVal;
        totalPortfolioValue=newVal;
        // We'll re-aggregate the entire structure with a scale
        scaleAll(portfolioRoot,scale);
        renderAll();
      }
      valSpan.textContent=formatMoney(newVal);
      valSpan.onclick=onClick;
    }
  };
}
function scaleAll(node,scale) {
  // if position => scale
  if(node.isPosition) {
    node.currentDollar*=scale;
    node.targetDollar*=scale;
    node.proposedDollar*=scale;
    node.finalDollar*=scale;
    return;
  }
  // else if it has children => scale each
  if(node.children) {
    node.children.forEach(ch=> scaleAll(ch,scale));
  }
}

/************************************************************************
 * 9) Main Startup
 ************************************************************************/
window.addEventListener('DOMContentLoaded',()=>{
  initCharts();
  enablePortfolioValueEdit();

  // Risk select
  document.getElementById('riskSelect').addEventListener('change',()=>{
    readRiskSelect();
    renderAll(); 
  });
  // Generate new client
  document.getElementById('newClientBtn').addEventListener('click',()=>{
    generateRandomClient();
    document.getElementById('clientName').textContent= clientName;
    document.getElementById('clientValue').textContent= formatMoney(totalPortfolioValue);
    readRiskSelect();
    renderAll();
  });
  // Reset
  document.getElementById('resetTradesBtn').addEventListener('click',()=>{
    // revert
    if(originalPortfolioData) {
      portfolioRoot = JSON.parse(JSON.stringify(originalPortfolioData));
      totalPortfolioValue = originalPortfolioValue;
      document.getElementById('clientValue').textContent= formatMoney(totalPortfolioValue);
      renderAll();
      document.getElementById('tradeMessage').textContent="All trades reset to initial scenario.";
    }
  });

  // Initialize baseline
  generateRandomClient();
  document.getElementById('clientName').textContent= clientName;
  document.getElementById('clientValue').textContent= formatMoney(totalPortfolioValue);
  readRiskSelect();
  renderAll();
});

/************************************************************************
 * Done.
 ************************************************************************/
</script>
</body>
</html>
