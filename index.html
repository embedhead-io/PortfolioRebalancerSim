<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Portfolio Manager Simulator (Delta Enhancements)</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background: #f8f9fa;
    }

    .container {
      max-width: 900px;
      margin: 1rem auto;
      padding: 1.5rem;
      background: #fff;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      border-radius: 5px;
    }

    h1, h2 {
      margin-top: 0;
      margin-bottom: 0.75rem;
    }

    .section {
      margin-bottom: 1.5rem;
      border-bottom: 1px solid #ddd;
      padding-bottom: 1rem;
    }

    .btn {
      padding: 0.4rem 0.8rem;
      border: none;
      background: #007bff;
      color: #fff;
      cursor: pointer;
      border-radius: 3px;
      margin-left: 0.5rem;
      font-size: 0.9rem;
    }
    .btn:hover {
      background: #0069d9;
    }

    /* Client Profile */
    #client-profile {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
    }
    .profile-info {
      flex: 1;
      min-width: 250px;
      margin-right: 1rem;
    }
    .profile-actions {
      margin-top: 1rem;
    }

    /* Portfolio Header w/ Buttons */
    .portfolio-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      margin-bottom: 0.5rem;
    }
    .portfolio-buttons {
      display: flex;
      gap: 0.5rem;
    }

    /* Table */
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 0.5rem 0;
    }
    th, td {
      text-align: left;
      padding: 0.4rem;
      border-bottom: 1px solid #eee;
      vertical-align: middle;
    }
    th {
      background: #f0f0f0;
    }
    .editable-cell {
      cursor: pointer;
      background: #fafafa;
      border: 1px solid transparent;
    }
    .editable-cell input {
      width: 100%;
      border: 1px solid #007bff;
      outline: none;
      font: inherit;
      box-sizing: border-box;
      padding: 2px 4px;
      text-align: right;
    }

    tfoot td {
      font-weight: bold;
    }

    /* We will color positive deltas red and negative deltas green. */
    .delta-positive {
      color: red;
    }
    .delta-negative {
      color: green;
    }
    /* zero => no special class => black */

    /* Charts */
    .charts-container {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
      flex-wrap: wrap;
    }
    .chart-box {
      flex: 1;
      min-width: 270px;
      max-width: 400px;
      max-height: 400px;
      position: relative;
      margin: auto;
      background: #f9f9f9;
      border-radius: 4px;
      padding: 1rem;
      text-align: center;
    }
    .chart-title {
      margin-bottom: 0.5rem;
      font-weight: bold;
    }
    .chart-box canvas {
      width: 100% !important;
      height: 100% !important;
    }

    @media (max-width: 700px) {
      .charts-container {
        flex-direction: column;
      }
      .chart-box {
        max-width: 100%;
        margin-bottom: 1rem;
      }
    }

    .footer {
      text-align: center;
      margin-top: 2rem;
      font-size: 0.85rem;
      color: #666;
    }

    .success {
      color: green;
      font-weight: bold;
    }
    .error {
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>Portfolio Manager Simulator</h1>

  <!-- SECTION: CLIENT PROFILE -->
  <div class="section">
    <h2>Client Profile</h2>
    <div id="client-profile">
      <div class="profile-info">
        <p><strong>Name:</strong> <span id="clientName">--</span></p>
        <p><strong>Risk Tolerance:</strong> <span id="clientRisk">--</span></p>
        <p><strong>Portfolio Value:</strong> $<span id="clientValue">0</span></p>
        <p><strong>Target Allocation:</strong> 
          <span id="targetStocks">--</span>% Stocks, 
          <span id="targetBonds">--</span>% Bonds, 
          <span id="targetCash">--</span>% Cash
        </p>

        <div class="profile-actions">
          <button class="btn" id="newClientBtn">Generate New Client</button>
        </div>
      </div>
    </div>
  </div>

  <!-- SECTION: CURRENT (OR PROJECTED) PORTFOLIO -->
  <div class="section">
    <div class="portfolio-header">
      <h2>Current (or Projected) Portfolio</h2>
      <div class="portfolio-buttons">
        <button class="btn" id="rebalanceBtn">Rebalance</button>
        <button class="btn" id="resetTradesBtn">Reset Trades</button>
      </div>
    </div>

    <!-- 11 columns (as before):
        1)  Asset
        2)  Current($)
        3)  Target($)
        4)  Proposed +/-($)
        5)  Final($)
        6)  Delta($)
        7)  Current(%)
        8)  Target(%)
        9)  Proposed +/-(%)
        10) Final(%)
        11) Delta(%)
     -->
    <table id="portfolioTable">
      <thead>
        <tr>
          <th>Asset</th>
          <th>Current ($)</th>
          <th>Target ($)</th>
          <th>Proposed +/- ($)</th>
          <th>Final ($)</th>
          <th>Delta ($)</th>
          <th>Current (%)</th>
          <th>Target (%)</th>
          <th>Proposed +/- (%)</th>
          <th>Final (%)</th>
          <th>Delta (%)</th>
        </tr>
      </thead>
      <tbody id="portfolioRows"></tbody>
      <tfoot>
        <tr id="totalRow"></tr>
      </tfoot>
    </table>

    <div class="charts-container">
      <!-- LEFT: Target -->
      <div class="chart-box">
        <div class="chart-title">Target Allocation</div>
        <canvas id="targetChart"></canvas>
      </div>
      <!-- RIGHT: Final -->
      <div class="chart-box">
        <div class="chart-title">Final Allocation</div>
        <canvas id="finalChart"></canvas>
      </div>
    </div>

    <p id="tradeMessage"></p>
  </div>
</div>

<div class="footer">
  &copy; Delta Enhancements: Rounding &amp; Coloring
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/**
 * Proposed(%) => Proposed($)= (Proposed(%)/100)* totalPortfolioValue
 * Final($)= current($)+ proposed($)
 * Final(%)= final($)/ totalPortfolioValue*100
 * 
 * Delta($)= final($) - target($)
 * Delta(%)= final(%)- target(%)
 * 
 * - Round Delta(%) to 2 decimals, replacing any -0.00 with 0.00 
 * - Color the Delta columns:
 *    > 0 => red
 *    < 0 => green
 *    ==0 => black (default)
 * - Include Delta in total row: sum of delta($) = sum(all final($)) - sum(all target($))
 *                                 sum of delta(%) = sum(all final(%)) - sum(all target(%))
 */

let totalPortfolioValue = 0;
let assets = [];
let finalChart, targetChart;

/** Generate random client. */
function generateRandomClient() {
  const names = ['John Smith','Jane Doe','Alex Johnson','Maria Garcia','Lee Wong'];
  const riskLevels = [
    { label:'Conservative', stockPct:0.3, bondPct:0.5, cashPct:0.2 },
    { label:'Moderate',     stockPct:0.5, bondPct:0.4, cashPct:0.1 },
    { label:'Aggressive',   stockPct:0.7, bondPct:0.2, cashPct:0.1 }
  ];
  const randName = names[Math.floor(Math.random()*names.length)];
  const randRisk = riskLevels[Math.floor(Math.random()*riskLevels.length)];
  return {
    name: randName,
    risk: randRisk.label,
    portfolioValue: 100000,
    stockPct: randRisk.stockPct,
    bondPct:  randRisk.bondPct,
    cashPct:  randRisk.cashPct
  };
}

function newRandomClient() {
  const c = generateRandomClient();
  totalPortfolioValue = c.portfolioValue;

  // We'll deviate the current distribution from the target for variety
  const deviate = () => (Math.random()*0.2 - 0.1);
  let stShare= c.stockPct+ deviate();
  let boShare= c.bondPct + deviate();
  let caShare= c.cashPct + deviate();
  let sum= Math.max(stShare+boShare+caShare, 0.0001);

  let stPct= stShare/sum;
  let boPct= boShare/sum;
  let caPct= caShare/sum;

  let curSt= stPct* totalPortfolioValue;
  let tarSt= c.stockPct* totalPortfolioValue;
  let curBo= boPct* totalPortfolioValue;
  let tarBo= c.bondPct* totalPortfolioValue;
  let curCa= caPct* totalPortfolioValue;
  let tarCa= c.cashPct* totalPortfolioValue;

  assets= [
    {
      name: 'Stocks',
      currentDollar: curSt,
      currentPct: (curSt/ totalPortfolioValue)*100,
      targetDollar: tarSt,
      targetPct: (tarSt/ totalPortfolioValue)*100,
      proposedDollar: 0,
      proposedPct: 0,
      finalDollar: curSt,
      finalPct: (curSt/ totalPortfolioValue)*100
    },
    {
      name: 'Bonds',
      currentDollar: curBo,
      currentPct: (curBo/ totalPortfolioValue)*100,
      targetDollar: tarBo,
      targetPct: (tarBo/ totalPortfolioValue)*100,
      proposedDollar: 0,
      proposedPct: 0,
      finalDollar: curBo,
      finalPct: (curBo/ totalPortfolioValue)*100
    },
    {
      name: 'Cash',
      currentDollar: curCa,
      currentPct: (curCa/ totalPortfolioValue)*100,
      targetDollar: tarCa,
      targetPct: (tarCa/ totalPortfolioValue)*100,
      proposedDollar: 0,
      proposedPct: 0,
      finalDollar: curCa,
      finalPct: (curCa/ totalPortfolioValue)*100
    }
  ];

  document.getElementById('clientName').textContent = c.name;
  document.getElementById('clientRisk').textContent = c.risk;
  document.getElementById('clientValue').textContent = formatMoney(c.portfolioValue);
  document.getElementById('targetStocks').textContent = (c.stockPct*100).toFixed(0);
  document.getElementById('targetBonds').textContent  = (c.bondPct*100).toFixed(0);
  document.getElementById('targetCash').textContent   = (c.cashPct*100).toFixed(0);

  document.getElementById('tradeMessage').textContent='';
  renderTableAndCharts();
}

/** Re-render table & charts. */
function renderTableAndCharts(){
  const tbody= document.getElementById('portfolioRows');
  tbody.innerHTML='';

  let sumCurrentD=0, sumTargetD=0, sumProposedD=0, sumFinalD=0;
  let sumCurrentPct=0, sumTargetPct=0, sumProposedPct=0, sumFinalPct=0;

  assets.forEach((a, idx)=>{
    let deltaDollar = a.finalDollar - a.targetDollar; // final - target
    let deltaPct    = a.finalPct - a.targetPct;       // final% - target%

    // accumulate sums
    sumCurrentD   += a.currentDollar;
    sumTargetD    += a.targetDollar;
    sumProposedD  += a.proposedDollar;
    sumFinalD     += a.finalDollar;
    sumCurrentPct += a.currentPct;
    sumTargetPct  += a.targetPct;
    sumProposedPct+= a.proposedPct;
    sumFinalPct   += a.finalPct;

    const tr= document.createElement('tr');

    // (1) Asset
    let tdName= document.createElement('td');
    tdName.textContent= a.name;
    tr.appendChild(tdName);

    // (2) Current($)
    let tdCurD= document.createElement('td');
    tdCurD.textContent= formatMoney(a.currentDollar);
    tr.appendChild(tdCurD);

    // (3) Target($)
    let tdTarD= document.createElement('td');
    tdTarD.textContent= formatMoney(a.targetDollar);
    tr.appendChild(tdTarD);

    // (4) Proposed($) [editable]
    let tdPropD= document.createElement('td');
    tdPropD.className='editable-cell';
    tdPropD.textContent= formatMoney(a.proposedDollar);
    tdPropD.onclick= ()=> makeEditable(tdPropD, idx, 'dollar');
    tr.appendChild(tdPropD);

    // (5) Final($)
    let tdFinD= document.createElement('td');
    tdFinD.textContent= formatMoney(a.finalDollar);
    tr.appendChild(tdFinD);

    // (6) Delta($): color if positive => red, negative => green
    let tdDeltaD= document.createElement('td');
    tdDeltaD.textContent= formatMoney(deltaDollar);
    colorDeltaCell(tdDeltaD, deltaDollar);
    tr.appendChild(tdDeltaD);

    // (7) Current(%)
    let tdCurP= document.createElement('td');
    tdCurP.textContent= a.currentPct.toFixed(2)+'%';
    tr.appendChild(tdCurP);

    // (8) Target(%)
    let tdTarP= document.createElement('td');
    tdTarP.textContent= a.targetPct.toFixed(2)+'%';
    tr.appendChild(tdTarP);

    // (9) Proposed(%) [editable]
    let tdPropP= document.createElement('td');
    tdPropP.className='editable-cell';
    tdPropP.textContent= a.proposedPct.toFixed(2)+'%';
    tdPropP.onclick= ()=> makeEditable(tdPropP, idx, 'percent');
    tr.appendChild(tdPropP);

    // (10) Final(%)
    let tdFinP= document.createElement('td');
    tdFinP.textContent= a.finalPct.toFixed(2)+'%';
    tr.appendChild(tdFinP);

    // (11) Delta(%): round to 0.01, no negative zero
    let tdDeltaP= document.createElement('td');
    let dpVal = roundDeltaPct(deltaPct); // string like "1.25%"
    tdDeltaP.textContent= dpVal;
    colorDeltaCell(tdDeltaP, parseFloat(dpVal)); // parse the float portion to check sign
    tr.appendChild(tdDeltaP);

    tbody.appendChild(tr);
  });

  // Build total row, including delta:
  const tfoot= document.getElementById('totalRow');
  tfoot.innerHTML='';

  // sumDeltaDollar = sumFinalD - sumTargetD
  let sumDeltaDollar = sumFinalD - sumTargetD;
  // sumDeltaPct    = sumFinalPct - sumTargetPct
  let sumDeltaPct    = sumFinalPct - sumTargetPct;

  // We have 11 columns
  // 1) "TOTAL"
  const col1= document.createElement('td');
  col1.textContent= 'TOTAL';
  tfoot.appendChild(col1);

  // 2) sum of Current($)
  const col2= document.createElement('td');
  col2.textContent= formatMoney(sumCurrentD);
  tfoot.appendChild(col2);

  // 3) sum of Target($)
  const col3= document.createElement('td');
  col3.textContent= formatMoney(sumTargetD);
  tfoot.appendChild(col3);

  // 4) sum of Proposed($)
  const col4= document.createElement('td');
  col4.textContent= formatMoney(sumProposedD);
  tfoot.appendChild(col4);

  // 5) sum of Final($)
  const col5= document.createElement('td');
  col5.textContent= formatMoney(sumFinalD);
  tfoot.appendChild(col5);

  // 6) Delta($) => color
  const col6= document.createElement('td');
  col6.textContent= formatMoney(sumDeltaDollar);
  colorDeltaCell(col6, sumDeltaDollar);
  tfoot.appendChild(col6);

  // 7) sum of Current(%)
  const col7= document.createElement('td');
  col7.textContent= sumCurrentPct.toFixed(2)+'%';
  tfoot.appendChild(col7);

  // 8) sum of Target(%)
  const col8= document.createElement('td');
  col8.textContent= sumTargetPct.toFixed(2)+'%';
  tfoot.appendChild(col8);

  // 9) sum of Proposed(%)
  const col9= document.createElement('td');
  col9.textContent= sumProposedPct.toFixed(2)+'%';
  tfoot.appendChild(col9);

  // 10) sum of Final(%)
  const col10= document.createElement('td');
  col10.textContent= sumFinalPct.toFixed(2)+'%';
  tfoot.appendChild(col10);

  // 11) Delta(%)
  const col11= document.createElement('td');
  let sumDp= roundDeltaPct(sumDeltaPct);
  col11.textContent= sumDp;
  colorDeltaCell(col11, parseFloat(sumDp));
  tfoot.appendChild(col11);

  // Update charts
  updateCharts();
}

/** Round Delta(%) to 2 decimals, replacing -0.00 with 0.00. */
function roundDeltaPct(value){
  // We'll do normal rounding to 2 decimals:
  let r = parseFloat(value.toFixed(2));
  // If it's extremely close to zero, force 0:
  if(Math.abs(r) < 0.005) r=0;
  // Return as string with 2 decimals and a % sign
  return r.toFixed(2)+'%';
}

/** Color the cell red if val>0, green if val<0, black if val==0. */
function colorDeltaCell(td, val){
  // val might be e.g. 123.45 or -0.05
  // If val>0 => red, if val<0 => green, else default
  td.classList.remove('delta-positive','delta-negative');
  if(val>0) td.classList.add('delta-positive');
  else if(val<0) td.classList.add('delta-negative');
  // 0 => no class => black
}

/** Editing Proposed($ or %). */
function makeEditable(cell, assetIndex, mode){
  let oldVal= cell.textContent.replace(/[^\d.-]/g,'');
  cell.onclick=null;
  cell.innerHTML='';

  let input= document.createElement('input');
  input.type='text';
  input.value= oldVal||'0';
  setTimeout(()=> input.select(),0);

  input.onblur= ()=> finishEdit(cell, input.value, assetIndex, mode);
  input.onkeydown= (ev)=>{
    if(ev.key==='Enter'){
      ev.preventDefault();
      input.blur();
    }
  };
  cell.appendChild(input);
  input.focus();
}

/** 
 * Proposed(%) => Proposed($)= (Proposed(%)/100)* totalPortfolioValue
 * Final($)= current($)+ proposed($)
 * Final(%)= (final($)/ totalPortfolioValue)*100
 */
function finishEdit(cell, rawVal, assetIndex, mode){
  let val= parseFloat(rawVal)||0;
  let row= assets[assetIndex];

  if(mode==='percent'){
    row.proposedPct= val;
    row.proposedDollar= (val/100)* totalPortfolioValue;
    row.finalDollar= row.currentDollar+ row.proposedDollar;
    row.finalPct= (row.finalDollar/ totalPortfolioValue)*100;
  } else {
    // mode='dollar'
    row.proposedDollar= val;
    row.proposedPct= (val/ totalPortfolioValue)*100;
    row.finalDollar= row.currentDollar+ val;
    row.finalPct= (row.finalDollar/ totalPortfolioValue)*100;
  }

  renderTableAndCharts();

  // restore single-click
  if(mode==='percent'){
    cell.textContent= row.proposedPct.toFixed(2)+'%';
    cell.onclick= ()=> makeEditable(cell, assetIndex, 'percent');
  } else {
    cell.textContent= formatMoney(row.proposedDollar);
    cell.onclick= ()=> makeEditable(cell, assetIndex, 'dollar');
  }
}

/** Rebalance => does not reset proposed. */
function doRebalance(){
  document.getElementById('tradeMessage').innerHTML=
    '<span class="success">Rebalance triggered (Proposed not cleared).</span>';
}

/** Reset => sets Proposed=0 => Final= current. */
function doResetTrades(){
  assets.forEach(a=>{
    a.proposedDollar=0;
    a.proposedPct=0;
    a.finalDollar=a.currentDollar;
    a.finalPct=a.currentPct;
  });
  renderTableAndCharts();
  document.getElementById('tradeMessage').textContent='All proposed trades reset to 0.';
}

/** Update the two charts => left= target, right= final. */
function updateCharts(){
  const tarVals= assets.map(a=> a.targetDollar);
  const finVals= assets.map(a=> a.finalDollar);
  const labels= assets.map(a=> a.name);

  targetChart.data.labels= labels;
  targetChart.data.datasets[0].data= tarVals;
  targetChart.update();

  finalChart.data.labels= labels;
  finalChart.data.datasets[0].data= finVals;
  finalChart.update();
}

/** Format a number as money, 2 decimals, thousands separators. */
function formatMoney(x){
  return new Intl.NumberFormat('en-US',{
    minimumFractionDigits:2,
    maximumFractionDigits:2
  }).format(x);
}

/** Initialize chart objects. */
function initCharts(){
  targetChart= new Chart(document.getElementById('targetChart'),{
    type:'pie',
    data:{
      labels:[],
      datasets:[{
        label:'Target Allocation',
        data:[],
        backgroundColor:['#2196f3','#8bc34a','#ffc107']
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:true,
      plugins:{ legend:{ position:'bottom' }}
    }
  });

  finalChart= new Chart(document.getElementById('finalChart'),{
    type:'pie',
    data:{
      labels:[],
      datasets:[{
        label:'Final Allocation',
        data:[],
        backgroundColor:['#2196f3','#8bc34a','#ffc107']
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:true,
      plugins:{ legend:{ position:'bottom' }}
    }
  });
}

/** On DOM load. */
window.addEventListener('DOMContentLoaded', ()=>{
  initCharts();
  document.getElementById('newClientBtn').addEventListener('click', newRandomClient);
  document.getElementById('rebalanceBtn').addEventListener('click', doRebalance);
  document.getElementById('resetTradesBtn').addEventListener('click', doResetTrades);

  newRandomClient();
});
</script>
</body>
</html>
