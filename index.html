<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Portfolio Manager Simulator – Final Fixes</title>
  <style>
    /*********************************************************
     * LIGHT vs. DARK theme
     *********************************************************/
    :root {
      --bg-body: #f8f9fa;
      --bg-container: #fff;
      --text-color: #000;
      --header-footer-bg: #e9e9e9;
      --asset-col-bg: #e8f1ff;  /* Distinct background for Asset rows */
      --class-col-bg: #f2ffe8;  /* Distinct background for Class rows */
      --proposed-col-border: #007bff;
      --editable-field-border: #ccc;

      /* Chart legend color for light mode */
      --chart-legend-color: #000;
    }
    body.dark-mode {
      --bg-body: #202020;
      --bg-container: #2c2c2c;
      --text-color: #eee;
      --header-footer-bg: #444;
      --asset-col-bg: #3a3a3a;
      --class-col-bg: #333;
      --proposed-col-border: #66afff;
      --editable-field-border: #888;

      /* Chart legend color for dark mode */
      --chart-legend-color: #fff;
    }

    body {
      margin: 0;
      font-family: 'Helvetica Neue', Arial, sans-serif;
      min-width: 1200px;
      background: var(--bg-body);
      color: var(--text-color);
      transition: background 0.3s, color 0.3s;
    }

    .container {
      max-width: 1200px;
      margin: 1rem auto;
      padding: 1.5rem;
      background: var(--bg-container);
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      transition: background 0.3s, color 0.3s;
    }

    h1, h2 {
      margin-top: 0;
      margin-bottom: 0.75rem;
    }

    .dark-mode-toggle {
      width: 20px; height: 20px;
      border-radius: 50%;
      background: #666;
      position: absolute;
      top: 10px; right: 10px;
      cursor: pointer;
      border: 2px solid #999;
      transition: background 0.3s;
    }
    .dark-mode-toggle:hover { background: #444; }
    body.dark-mode .dark-mode-toggle {
      background: #aaa; border-color: #ccc;
    }
    body.dark-mode .dark-mode-toggle:hover {
      background: #ccc;
    }

    .btn {
      padding: 0.4rem 0.8rem;
      border: none;
      background: #007bff;
      color: #fff;
      cursor: pointer;
      border-radius: 3px;
      margin-left: 0.5rem;
      font-size: 0.9rem;
    }
    .btn:hover {
      background: #0069d9;
    }

    .section {
      margin-bottom: 1.5rem;
      border-bottom: 1px solid #ddd;
      padding-bottom: 1rem;
    }

    /* Profile layout */
    #client-profile {
      display: flex; 
      justify-content: space-between; 
      flex-wrap: wrap;
    }
    .profile-info {
      flex: 1; 
      min-width: 320px; 
      margin-right: 1rem;
    }
    .profile-actions { margin-top: 1rem; }
    #riskSelect { margin-left: 0.5rem; }

    /* Editable Portfolio Value */
    .editable-field {
      cursor: pointer;
      border: 1px dotted var(--editable-field-border);
      padding: 2px 4px;
      background: #fafafa;
      transition: border-color 0.3s;
    }
    body.dark-mode .editable-field { background: #333; }
    .editable-field input {
      width: 80px; 
      border: 1px solid #007bff; 
      outline: none; 
      font: inherit; 
      box-sizing: border-box;
      text-align: right;
    }

    /* Table & expansions */
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 0.5rem 0;
      transition: background 0.3s, color 0.3s;
    }
    thead th {
      background: var(--header-footer-bg);
    }
    tfoot td {
      background: var(--header-footer-bg);
      font-weight: bold;
    }
    th, td {
      text-align: left;
      padding: 0.4rem;
      border-bottom: 1px solid #eee;
      vertical-align: middle;
    }

    /* Asset row => special background color, bold text */
    .asset-col {
      background: var(--asset-col-bg);
      font-weight: bold;
      transition: background 0.3s;
    }
    /* Class row => special background color */
    .class-col {
      background: var(--class-col-bg);
      transition: background 0.3s;
    }

    /* Proposed columns => color invert from total columns */
    .proposed-col {
      border: 1px dotted var(--proposed-col-border);
      background: #fafafa;
      cursor: pointer;
      transition: border-color 0.3s;
    }
    body.dark-mode .proposed-col { background: #333; }
    .proposed-positive { color: green; font-weight: bold; }
    .proposed-negative { color: red;   font-weight: bold; }

    /* Delta => total surplus => pos => red, neg => green, zero => black */
    .delta-positive { color: red;   font-weight: bold; }
    .delta-negative { color: green; font-weight: bold; }

    /* Expand toggles, hidden classes, indentation for sub-levels */
    .expand-toggle {
      cursor: pointer; 
      color: #007bff; 
      margin-right: 0.5rem;
    }
    .hidden { display: none; }
    .class-row td { padding-left: 2em; }
    .position-row td { padding-left: 4em; }
    .subtotal-row td {
      font-weight: bold; 
      background: #f0f0f0;
    }

    /* 3 smaller charts side by side */
    .charts-container {
      display: flex; 
      gap: 1rem; 
      margin-top: 1rem; 
      flex-wrap: wrap; 
      justify-content: space-evenly;
    }
    .chart-box {
      flex: 1; 
      min-width: 250px; 
      max-width: 300px; 
      max-height: 300px; 
      position: relative; 
      margin: auto; 
      background: #f9f9f9; 
      border-radius: 4px; 
      padding: 1rem; 
      text-align: center;
      transition: background 0.3s;
    }
    body.dark-mode .chart-box { background: #333; }
    .chart-title {
      margin-bottom: 0.5rem; 
      font-weight: bold;
    }
    .chart-box canvas {
      width: 100% !important; 
      height: 100% !important;
    }

    /* Force chart legends to use var(--chart-legend-color) */
    .chart-box .legend-color {
      color: var(--chart-legend-color) !important;
    }

    .footer {
      text-align: center; 
      margin-top: 2rem; 
      font-size: 0.85rem; 
      transition: color 0.3s;
      color: var(--text-color);
    }

    .success { color: green; font-weight: bold; }
    .error   { color: red;   font-weight: bold; }
  </style>
</head>
<body>

<div class="dark-mode-toggle" id="darkModeToggle"></div>

<div class="container">
  <h1>Portfolio Manager Simulator – Nested Aggregation (Final Fixes)</h1>

  <!-- Client Profile -->
  <div class="section" id="client-profile">
    <div class="profile-info">
      <p><strong>Name:</strong> <span id="clientName">--</span></p>
      <p>
        <strong>Risk Tolerance:</strong>
        <select id="riskSelect">
          <option value="conservative">Conservative</option>
          <option value="moderate" selected>Moderate</option>
          <option value="aggressive">Aggressive</option>
        </select>
      </p>
      <p>
        <strong>Portfolio Value:</strong>
        $<span id="clientValue" class="editable-field">0</span>
      </p>
      <p>
        <strong>Target Allocation:</strong>
        <span id="targetStocks">--</span>% Stocks, 
        <span id="targetBonds">--</span>% Bonds, 
        <span id="targetCash">--</span>% Cash
      </p>
      <div class="profile-actions">
        <button class="btn" id="newClientBtn">Generate New Client</button>
      </div>
    </div>
  </div>

  <!-- Table & Charts -->
  <div class="section">
    <div class="portfolio-header">
      <h2>Current (or Projected) Portfolio</h2>
      <div class="portfolio-buttons">
        <button class="btn" id="resetTradesBtn">Reset Trades</button>
      </div>
    </div>

    <!-- The column order: Proposed => Total => Delta for both $ and % -->
    <table id="portfolioTable">
      <thead>
        <tr>
          <th>Asset/Class/Position</th>
          <th>Current ($)</th>
          <th>Target ($)</th>
          <th>Proposed ($)</th>
          <th>Total ($)</th>
          <th>Delta ($)</th>
          <th>Current (%)</th>
          <th>Target (%)</th>
          <th>Proposed (%)</th>
          <th>Total (%)</th>
          <th>Delta (%)</th>
        </tr>
      </thead>
      <tbody id="portfolioRows"></tbody>
      <tfoot>
        <tr id="totalRow"></tr>
      </tfoot>
    </table>

    <div class="charts-container">
      <div class="chart-box">
        <div class="chart-title">Current Allocation</div>
        <canvas id="currentChart"></canvas>
      </div>
      <div class="chart-box">
        <div class="chart-title">Target Allocation</div>
        <canvas id="targetChart"></canvas>
      </div>
      <div class="chart-box">
        <div class="chart-title">Total Allocation</div>
        <canvas id="finalChart"></canvas>
      </div>
    </div>

    <p id="tradeMessage"></p>
  </div>
</div>

<div class="footer">
  &copy; Final Example – Resolved Proposed Edits, Risk Tolerance, Dark Mode
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/***************************************************************
 * 1) Data Model
 ***************************************************************/
let root = {
  name: "ROOT",
  expanded: true,
  children: []
};
let originalData = null;

let clientName = "";
let totalPortfolioValue= 0;
let originalPortfolioValue= 0;

/** We'll track userStockPct, userBondPct, userCashPct for the risk. */
let userStockPct=0.5, userBondPct=0.4, userCashPct=0.1;

let currentChart, targetChart, finalChart; // the 3 pie charts

/***************************************************************
 * 2) Dark Mode Toggle
 ***************************************************************/
const darkToggle= document.getElementById('darkModeToggle');
darkToggle.addEventListener('click', () => {
  document.body.classList.toggle('dark-mode');
});

/***************************************************************
 * 3) Generating a “Cash” Asset
 ***************************************************************/
function generateRandomNestedData() {
  // "Stocks" => classes => positions
  const stocks = {
    name: "Stocks",
    isAsset: true,
    expanded: false,
    children: [
      {
        name:"Large Cap",
        isClass:true,
        expanded:false,
        children:[
          makePosition("AAPL"), makePosition("MSFT")
        ]
      },
      {
        name:"Small Cap",
        isClass:true,
        expanded:false,
        children:[
          makePosition("RGEN"), makePosition("FIZZ")
        ]
      }
    ]
  };
  // "Bonds" => direct positions
  const bonds= {
    name: "Bonds",
    isAsset:true,
    expanded:false,
    children: [
      makePosition("Corp Bond A"), 
      makePosition("Gov Bond B")
    ]
  };
  // "Cash" => no children, not expanded
  const cash= {
    name: "Cash",
    isAsset:true, 
    expanded:false,
    children: [] // no sub-level
  };

  root.children= [stocks, bonds, cash];
}
/** Create random position with current/target. */
function makePosition(name) {
  let c= 3000+ Math.random()*9000;
  let t= c + (Math.random()-0.5)*2000;
  return {
    name,
    isPosition:true,
    expanded:false,
    currentDollar: roundTo100(c),
    targetDollar:  roundTo100(t),
    proposedDollar:0,
    totalDollar:0
  };
}
function roundTo100(x) {
  return Math.round(x/100)*100;
}

/***************************************************************
 * 4) Aggregator from bottom up
 ***************************************************************/
function aggregator(node) {
  // if no children => position => total = current + proposed
  if(!node.children || node.children.length===0) {
    node.totalDollar= node.currentDollar + node.proposedDollar;
    return;
  }
  let c=0, t=0, p=0, tot=0;
  node.children.forEach(ch=>{
    aggregator(ch);
    c+= ch.currentDollar||0;
    t+= ch.targetDollar||0;
    p+= ch.proposedDollar||0;
    tot+= ch.totalDollar||0;
  });
  node.currentDollar=c; 
  node.targetDollar=t; 
  node.proposedDollar=p;
  node.totalDollar= tot;
}

/** Next, compute absolute % vs. root sums. */
function computePercents(node, rootRef) {
  const rc= (rootRef.currentDollar>0? rootRef.currentDollar:1);
  const rt= (rootRef.targetDollar>0? rootRef.targetDollar:1);
  const rtot= (rootRef.totalDollar>0? rootRef.totalDollar:1);

  node.currentPct= (node.currentDollar/ rc)*100;
  node.targetPct=  (node.targetDollar / rt)*100;
  node.proposedPct= (node.proposedDollar/ rc)*100;
  node.totalPct=  (node.totalDollar / rtot)*100;

  if(node.children) {
    node.children.forEach(ch=> computePercents(ch,rootRef));
  }
}

/***************************************************************
 * 5) We want the total of top-level child assets (Stocks,Bonds,Cash)
 *    to sum to the user's totalPortfolioValue in Current($).
 *    So we must generate random or partial distributions, then 
 *    aggregator will sum them up to root. Then if root.currentDollar
 *    doesn't match totalPortfolioValue, we fix "Cash" as leftover.
 ***************************************************************/
function ensureRootSumMatchesPortfolioValue() {
  // aggregator gave us root.currentDollar. If it's > or < portfolioVal, we adjust "Cash."
  aggregator(root);
  const diff = totalPortfolioValue - root.currentDollar;
  if(root.children) {
    let cashNode = root.children.find(ch=> /cash/i.test(ch.name));
    if(cashNode) {
      cashNode.currentDollar += diff; // leftover
    }
  }
  // do aggregator again, so we incorporate that leftover
  aggregator(root);
}

/***************************************************************
 * 6) Table rendering 
 ***************************************************************/
function renderTable() {
  const tb=document.getElementById('portfolioRows');
  tb.innerHTML="";
  if(!root.children) return;
  root.children.forEach(asset => renderNode(asset,0));
  buildTotalRow();
}
function renderNode(node,level) {
  const tr= document.createElement('tr');

  // name
  let tdName= document.createElement('td');
  // color if asset or class
  if(node.isAsset) tdName.classList.add('asset-col');
  else if(node.isClass) tdName.classList.add('class-col');
  
  // toggler
  if(node.children && node.children.length>0) {
    let toggler=document.createElement('span');
    toggler.className='expand-toggle';
    toggler.textContent=node.expanded? "▼":"▶";
    toggler.onclick=()=>{
      node.expanded=!node.expanded;
      renderAll();
    };
    tdName.appendChild(toggler);
  }
  tdName.appendChild(document.createTextNode(node.name));
  tr.appendChild(tdName);

  // Current($)
  let tdCur=document.createElement('td');
  tdCur.textContent= formatMoney(node.currentDollar||0);
  tr.appendChild(tdCur);

  // Target($)
  let tdTar=document.createElement('td');
  tdTar.textContent= formatMoney(node.targetDollar||0);
  tr.appendChild(tdTar);

  // Proposed($) => single-click editable
  let tdProp=document.createElement('td');
  tdProp.className='proposed-col';
  let pd=node.proposedDollar||0;
  if(Math.abs(pd)>0.01) {
    if(pd>0) tdProp.classList.add('proposed-positive');
    else     tdProp.classList.add('proposed-negative');
  }
  tdProp.textContent= formatMoney(pd);
  tdProp.onclick= ()=> editProposedCell(tdProp,node,'dollar');
  tr.appendChild(tdProp);

  // Total($)
  let tdTot=document.createElement('td');
  tdTot.textContent= formatMoney(node.totalDollar||0);
  tr.appendChild(tdTot);

  // Delta($)= target - total
  let deltaDollar=(node.targetDollar||0)-(node.totalDollar||0);
  let tdDelta=document.createElement('td');
  tdDelta.textContent= withSignMoney(deltaDollar);
  colorDeltaCell(tdDelta, deltaDollar);
  tr.appendChild(tdDelta);

  // Current(%)
  let tdCurPct=document.createElement('td');
  tdCurPct.textContent= (node.currentPct||0).toFixed(2)+"%";
  tr.appendChild(tdCurPct);

  // Target(%)
  let tdTarPct=document.createElement('td');
  tdTarPct.textContent= (node.targetPct||0).toFixed(2)+"%";
  tr.appendChild(tdTarPct);

  // Proposed(%)
  let tdPropPct=document.createElement('td');
  tdPropPct.className='proposed-col';
  let pp=node.proposedPct||0;
  if(Math.abs(pp)>0.01) {
    if(pp>0) tdPropPct.classList.add('proposed-positive');
    else     tdPropPct.classList.add('proposed-negative');
  }
  tdPropPct.textContent= pp.toFixed(2)+"%";
  tdPropPct.onclick= ()=> editProposedCell(tdPropPct,node,'percent');
  tr.appendChild(tdPropPct);

  // Total(%)
  let tdTotPct=document.createElement('td');
  let totp=node.totalPct||0;
  tdTotPct.textContent= totp.toFixed(2)+"%";
  tr.appendChild(tdTotPct);

  // Delta(%)= target% - total%
  let dPct= (node.targetPct||0) - (node.totalPct||0);
  let tdDeltaPct=document.createElement('td');
  tdDeltaPct.textContent= withSignPct(dPct);
  colorDeltaCell(tdDeltaPct,dPct);
  tr.appendChild(tdDeltaPct);

  tb.appendChild(tr);

  // if expanded => children => sub row
  if(node.expanded && node.children && node.children.length>0) {
    node.children.forEach(ch => renderNode(ch,level+1));
  }
}
function buildTotalRow() {
  let tf=document.getElementById('totalRow');
  tf.innerHTML="";
  let tr=document.createElement('tr');
  let td=document.createElement('td');
  td.colSpan=11;
  td.textContent="TOTAL PORTFOLIO";
  tr.appendChild(td);
  tf.appendChild(tr);
}

/***************************************************************
 * 7) Proposed Cell Editing
 ***************************************************************/
function editProposedCell(cell,node,mode){
  let oldVal= cell.textContent;
  oldVal= oldVal.replace(/,/g,'').replace(/[^\d.\-+]/g,'');
  cell.onclick=null;
  cell.innerHTML='';

  let inp= document.createElement('input');
  inp.type='text';
  inp.value= oldVal||'0';
  setTimeout(()=>inp.select(),0);

  inp.onblur= ()=> finishProposedEdit(cell,node,inp.value,mode);
  inp.onkeydown=(ev)=>{
    if(ev.key==='Enter'){
      ev.preventDefault(); inp.blur();
    }
  };
  cell.appendChild(inp);
  inp.focus();
}
function finishProposedEdit(cell,node,rawVal,mode) {
  rawVal= rawVal.replace(/,/g,'');
  let val= parseFloat(rawVal)||0;

  if(mode==='percent') {
    // Proposed($)= val% of root.currentDollar
    let rCur= root.currentDollar>0? root.currentDollar:1;
    node.proposedDollar= (val/100)* rCur;
  } else {
    // Proposed($)= val
    node.proposedDollar= val;
  }
  renderAll();
}

/***************************************************************
 * 8) aggregator => re-run => compute % => fix leftover Cash
 ***************************************************************/
function renderAll() {
  aggregator(root);
  ensureRootSumMatchesPortfolioValue(); // ensures top-level matches 
  aggregator(root);
  computePercents(root, root);

  renderTable();
  updateCharts();
}

/***************************************************************
 * 9) Risk Tolerance => userStockPct, userBondPct, userCashPct
 ***************************************************************/
function onRiskChange() {
  let val=document.getElementById('riskSelect').value;
  if(val==='conservative'){
    userStockPct=0.3; userBondPct=0.5; userCashPct=0.2;
  } else if(val==='aggressive'){
    userStockPct=0.7; userBondPct=0.2; userCashPct=0.1;
  } else {
    userStockPct=0.5; userBondPct=0.4; userCashPct=0.1;
  }
  document.getElementById('targetStocks').textContent=(userStockPct*100).toFixed(0);
  document.getElementById('targetBonds').textContent=(userBondPct*100).toFixed(0);
  document.getElementById('targetCash').textContent=(userCashPct*100).toFixed(0);

  // apply risk => top-level target => aggregator => 
  applyRiskAllocation();
  renderAll();
}
/** applyRisk => we find top-level "Stocks","Bonds","Cash" and set targetDollar= fraction * totalPortfolioValue */
function applyRiskAllocation() {
  let tVal= totalPortfolioValue;
  let stVal= userStockPct* tVal;
  let boVal= userBondPct * tVal;
  let caVal= userCashPct * tVal;
  if(root.children) {
    root.children.forEach(ch => {
      if(/stock/i.test(ch.name)) {
        ch.targetDollar= stVal;
      } else if(/bond/i.test(ch.name)) {
        ch.targetDollar= boVal;
      } else if(/cash/i.test(ch.name)) {
        ch.targetDollar= caVal;
      }
    });
  }
}

/***************************************************************
 * 10) New Client => random name + random nested
 ***************************************************************/
function doGenerateNewClient() {
  const names=["John Smith","Jane Doe","Alex Johnson","Maria Garcia","Lee Wong"];
  clientName= names[Math.floor(Math.random()* names.length)];
  document.getElementById('clientName').textContent= clientName;

  let val= 80000+ Math.random()*40000;
  val= roundTo100(val);
  totalPortfolioValue= val;
  document.getElementById('clientValue').textContent= formatMoney(val);

  // build random
  root.children=[];
  generateRandomNestedData();
  // add "Cash" node if not present
  let cNode= root.children.find(a=> /cash/i.test(a.name));
  if(!cNode){
    root.children.push({
      name:"Cash", 
      isAsset:true, 
      expanded:false,
      children:[]
    });
  }
  // store original
  originalData= JSON.parse(JSON.stringify(root));
  originalPortfolioValue= val;

  // apply risk => aggregator => render
  applyRiskAllocation();
  renderAll();
}

/***************************************************************
 * 11) Reset trades => revert original
 ***************************************************************/
function doResetTrades() {
  if(originalData){
    root= JSON.parse(JSON.stringify(originalData));
    totalPortfolioValue= originalPortfolioValue;
    document.getElementById('clientValue').textContent= formatMoney(totalPortfolioValue);

    renderAll();
    document.getElementById('tradeMessage').textContent="Reset to initial scenario.";
  }
}

/***************************************************************
 * 12) Chart init & update
 ***************************************************************/
function initCharts() {
  currentChart= new Chart(document.getElementById('currentChart'),{
    type:'pie',
    data:{ labels:[], datasets:[{
      label:'Current',
      data:[],
      backgroundColor:['#2196f3','#8bc34a','#ffc107']
    }]},
    options:{
      responsive:true, 
      maintainAspectRatio:true,
      plugins:{
        legend:{
          position:'bottom',
          labels:{
            // Force the legend color to var(--chart-legend-color)
            color: getComputedStyle(document.body).getPropertyValue('--chart-legend-color')
          }
        }
      }
    }
  });
  targetChart= new Chart(document.getElementById('targetChart'),{
    type:'pie',
    data:{ labels:[], datasets:[{
      label:'Target',
      data:[],
      backgroundColor:['#2196f3','#8bc34a','#ffc107']
    }]},
    options:{
      responsive:true,
      maintainAspectRatio:true,
      plugins:{
        legend:{
          position:'bottom',
          labels:{
            color: getComputedStyle(document.body).getPropertyValue('--chart-legend-color')
          }
        }
      }
    }
  });
  finalChart= new Chart(document.getElementById('finalChart'),{
    type:'pie',
    data:{ labels:[], datasets:[{
      label:'Total',
      data:[],
      backgroundColor:['#2196f3','#8bc34a','#ffc107']
    }]},
    options:{
      responsive:true,
      maintainAspectRatio:true,
      plugins:{
        legend:{
          position:'bottom',
          labels:{
            color: getComputedStyle(document.body).getPropertyValue('--chart-legend-color')
          }
        }
      }
    }
  });
}
function updateCharts() {
  // sum top-level assets
  let labels=[], curVals=[], tarVals=[], totVals=[];
  root.children.forEach(ch=>{
    labels.push(ch.name);
    curVals.push(ch.currentDollar||0);
    tarVals.push(ch.targetDollar||0);
    totVals.push(ch.totalDollar||0);
  });
  // update
  currentChart.data.labels=labels;
  currentChart.data.datasets[0].data=curVals;
  // Force the new label color in dark mode
  currentChart.options.plugins.legend.labels.color= 
    getComputedStyle(document.body).getPropertyValue('--chart-legend-color');
  currentChart.update();

  targetChart.data.labels=labels;
  targetChart.data.datasets[0].data=tarVals;
  targetChart.options.plugins.legend.labels.color=
    getComputedStyle(document.body).getPropertyValue('--chart-legend-color');
  targetChart.update();

  finalChart.data.labels=labels;
  finalChart.data.datasets[0].data= totVals;
  finalChart.options.plugins.legend.labels.color=
    getComputedStyle(document.body).getPropertyValue('--chart-legend-color');
  finalChart.update();
}

/***************************************************************
 * 13) Utility
 ***************************************************************/
function withSignMoney(value){
  let r= parseFloat(value.toFixed(2));
  if(Math.abs(r)<0.01) r=0;
  let absVal= Math.abs(r);
  let absStr= formatMoney(absVal);
  if(r>0) return `+${absStr}`;
  else if(r<0) return `-${absStr}`;
  return absStr;
}

function withSignPct(value){
  let r= parseFloat(value.toFixed(2));
  if(Math.abs(r)<0.01) r=0;
  let absStr=Math.abs(r).toFixed(2);
  if(r>0) return `+${absStr}%`;
  else if(r<0) return `-${absStr}%`;
  return "0.00%";
}

function colorDeltaCell(td, val){
  td.classList.remove('delta-positive','delta-negative');
  let r= parseFloat(val.toFixed(2));
  if(Math.abs(r)<0.01) {
    // zero => black
  } else if(r>0) {
    td.classList.add('delta-positive');
  } else {
    td.classList.add('delta-negative');
  }
}

function formatMoney(x){
  return new Intl.NumberFormat('en-US',{
    minimumFractionDigits:2,
    maximumFractionDigits:2
  }).format(x);
}

/***************************************************************
 * 14) Enable Editing of Portfolio Value
 ***************************************************************/
function enablePortfolioValueEdit() {
  const valElem=document.getElementById('clientValue');
  valElem.onclick= function onClick() {
    let oldStr= valElem.textContent.replace(/,/g,'').replace(/[^\d.\-+]/g,'');
    valElem.onclick=null;
    valElem.innerHTML='';

    const input= document.createElement('input');
    input.type='text';
    input.value= oldStr||'0';
    setTimeout(()=> input.select(),0);

    input.onblur=()=>{
      let parsed=parseFloat(input.value.replace(/,/g,''))||0;
      totalPortfolioValue=parsed;
      valElem.textContent=formatMoney(parsed);

      // Re-apply risk & aggregator
      onRiskChange();
    };
    input.onkeydown=(ev)=>{
      if(ev.key==='Enter'){ev.preventDefault();input.blur();}
    };
    valElem.appendChild(input);
    input.focus();
  };
}

/***************************************************************
 * 15) Startup
 ***************************************************************/
window.addEventListener('DOMContentLoaded',()=>{
  initCharts();
  enablePortfolioValueEdit();

  // riskSelect => onRiskChange
  document.getElementById('riskSelect').addEventListener('change',onRiskChange);
  // newClient
  document.getElementById('newClientBtn').addEventListener('click', doGenerateNewClient);
  // reset
  document.getElementById('resetTradesBtn').addEventListener('click', ()=>{
    if(originalData){
      root= JSON.parse(JSON.stringify(originalData));
      totalPortfolioValue= originalPortfolioValue;
      document.getElementById('clientValue').textContent=formatMoney(totalPortfolioValue);
      renderAll();
      document.getElementById('tradeMessage').textContent="Reset to initial scenario.";
    }
  });

  // default
  onRiskChange();
  doGenerateNewClient();
});
</script>
</body>
</html>
