<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Portfolio Manager Simulator (Per-Row Arithmetic)</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background: #f8f9fa;
    }

    .container {
      max-width: 900px;
      margin: 1rem auto;
      padding: 1.5rem;
      background: #fff;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      border-radius: 5px;
    }

    h1, h2 {
      margin-top: 0;
      margin-bottom: 0.75rem;
    }

    .section {
      margin-bottom: 1.5rem;
      border-bottom: 1px solid #ddd;
      padding-bottom: 1rem;
    }

    /* Buttons */
    .btn {
      padding: 0.4rem 0.8rem;
      border: none;
      background: #007bff;
      color: #fff;
      cursor: pointer;
      border-radius: 3px;
      margin-left: 0.5rem;
      font-size: 0.9rem;
    }
    .btn:hover {
      background: #0069d9;
    }

    /* Client Profile Layout */
    #client-profile {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
    }
    .profile-info {
      flex: 1;
      min-width: 250px;
      margin-right: 1rem;
    }
    .profile-actions {
      margin-top: 1rem;
    }

    /* Portfolio Header w/ Buttons */
    .portfolio-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      margin-bottom: 0.5rem;
    }
    .portfolio-buttons {
      display: flex;
      gap: 0.5rem;
    }

    /* Table */
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 0.5rem 0;
    }
    th, td {
      text-align: left;
      padding: 0.4rem;
      border-bottom: 1px solid #eee;
      vertical-align: middle;
    }
    th {
      background: #f0f0f0;
    }
    .editable-cell {
      cursor: pointer;
      background: #fafafa;
      border: 1px solid transparent;
    }
    .editable-cell input {
      width: 100%;
      border: 1px solid #007bff;
      outline: none;
      font: inherit;
      box-sizing: border-box;
      padding: 2px 4px;
      text-align: right;
    }

    /* Charts */
    .charts-container {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
      flex-wrap: wrap;
    }
    .chart-box {
      flex: 1;
      min-width: 270px;
      max-width: 400px;
      max-height: 400px;
      position: relative;
      margin: auto;
      background: #f9f9f9;
      border-radius: 4px;
      padding: 1rem;
      text-align: center;
    }
    .chart-title {
      margin-bottom: 0.5rem;
      font-weight: bold;
    }
    .chart-box canvas {
      width: 100% !important;
      height: 100% !important;
    }

    @media (max-width: 700px) {
      .charts-container {
        flex-direction: column;
      }
      .chart-box {
        max-width: 100%;
        margin-bottom: 1rem;
      }
    }

    .footer {
      text-align: center;
      margin-top: 2rem;
      font-size: 0.85rem;
      color: #666;
    }

    .success {
      color: green;
      font-weight: bold;
    }
    .error {
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>Portfolio Manager Simulator</h1>

  <!-- SECTION: CLIENT PROFILE -->
  <div class="section">
    <h2>Client Profile</h2>
    <div id="client-profile">
      <div class="profile-info">
        <p><strong>Name:</strong> <span id="clientName">--</span></p>
        <p><strong>Risk Tolerance:</strong> <span id="clientRisk">--</span></p>
        <p><strong>Portfolio Value:</strong> $<span id="clientValue">0</span></p>
        <p><strong>Target Allocation:</strong> 
          <span id="targetStocks">--</span>% Stocks, 
          <span id="targetBonds">--</span>% Bonds, 
          <span id="targetCash">--</span>% Cash
        </p>

        <div class="profile-actions">
          <button class="btn" id="newClientBtn">Generate New Client</button>
        </div>
      </div>
    </div>
  </div>

  <!-- SECTION: CURRENT (OR PROJECTED) PORTFOLIO -->
  <div class="section">
    <div class="portfolio-header">
      <h2>Current (or Projected) Portfolio</h2>
      <div class="portfolio-buttons">
        <button class="btn" id="rebalanceBtn">Rebalance</button>
        <button class="btn" id="resetTradesBtn">Reset Trades</button>
      </div>
    </div>

    <!-- 9-column Table -->
    <table id="portfolioTable">
      <thead>
        <tr>
          <th>Asset</th>
          <th>Current ($)</th>
          <th>Target ($)</th>
          <th>Proposed +/- ($)</th>
          <th>Final ($)</th>
          <th>Current (%)</th>
          <th>Target (%)</th>
          <th>Proposed +/- (%)</th>
          <th>Final (%)</th>
        </tr>
      </thead>
      <tbody id="portfolioRows">
        <!-- Populated dynamically -->
      </tbody>
    </table>

    <div class="charts-container">
      <!-- Left chart: sum of Final($) across all assets -->
      <div class="chart-box">
        <div class="chart-title">Final Allocation</div>
        <canvas id="finalChart"></canvas>
      </div>
      <!-- Right chart: sum of Target($) across all assets -->
      <div class="chart-box">
        <div class="chart-title">Target Allocation</div>
        <canvas id="targetChart"></canvas>
      </div>
    </div>

    <p id="tradeMessage"></p>
  </div>
</div>

<div class="footer">
  &copy; Per-Row Arithmetic Example
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/* 
  Per your instructions, for each row:

  CASE 1: User edits Proposed(%)
    Final(%)     = Current(%) + Proposed(%)
    Proposed($)  = Proposed(%) * Current($)
    Final($)     = Current($) + Proposed($)

  CASE 2: User edits Proposed($)
    Final($)     = Current($) + Proposed($)
    Proposed(%)  = Proposed($) / Current($) * 100
    Final(%)     = Current(%) + Proposed(%)

  We do not enforce that sum of Final(%) across rows = 100. 
  Each row is computed in isolation. The final chart is based on summing each row's Final($).
*/

let assets = []; // Each row: {name, currentDollar, currentPct, targetDollar, targetPct, proposedDollar, proposedPct, finalDollar, finalPct}
let finalChart, targetChart;

/** Generates random client info. */
function generateRandomClient() {
  const names = ['John Smith','Jane Doe','Alex Johnson','Maria Garcia','Lee Wong'];
  const riskConfigs = [
    { name:'Conservative', stockPct:0.3, bondPct:0.5, cashPct:0.2 },
    { name:'Moderate',     stockPct:0.5, bondPct:0.4, cashPct:0.1 },
    { name:'Aggressive',   stockPct:0.7, bondPct:0.2, cashPct:0.1 }
  ];
  const randName = names[Math.floor(Math.random()*names.length)];
  const randCfg  = riskConfigs[Math.floor(Math.random()*riskConfigs.length)];

  return {
    clientName: randName,
    riskTolerance: randCfg.name,
    totalValue: 100000,
    stockPct: randCfg.stockPct,
    bondPct:  randCfg.bondPct,
    cashPct:  randCfg.cashPct
  };
}

function newRandomClient() {
  const c = generateRandomClient();
  const deviate = () => (Math.random()*0.2 - 0.1);
  // We'll produce row-based "Current(%)" that sums to ~some total
  // The "Current($)" also deviates from target
  const stDev = c.stockPct + deviate();
  const boDev = c.bondPct  + deviate();
  const caDev = c.cashPct  + deviate();
  const sumAlloc = Math.max(stDev+boDev+caDev, 0.0001);

  // row #1: Stocks
  const row1CurPct = (stDev/sumAlloc)*100;
  const row1CurDollar = (row1CurPct/100)* c.totalValue;
  // row #2: Bonds
  const row2CurPct = (boDev/sumAlloc)*100;
  const row2CurDollar= (row2CurPct/100)* c.totalValue;
  // row #3: Cash
  const row3CurPct = (caDev/sumAlloc)*100;
  const row3CurDollar= (row3CurPct/100)* c.totalValue;

  assets = [
    {
      name:'Stocks',
      currentDollar: row1CurDollar,
      currentPct: row1CurPct,
      targetDollar: c.totalValue * c.stockPct,
      targetPct: c.stockPct *100,
      proposedDollar:0,
      proposedPct:0,
      finalDollar: row1CurDollar,   // initially same as current
      finalPct: row1CurPct
    },
    {
      name:'Bonds',
      currentDollar: row2CurDollar,
      currentPct: row2CurPct,
      targetDollar: c.totalValue * c.bondPct,
      targetPct: c.bondPct*100,
      proposedDollar:0,
      proposedPct:0,
      finalDollar: row2CurDollar,
      finalPct: row2CurPct
    },
    {
      name:'Cash',
      currentDollar: row3CurDollar,
      currentPct: row3CurPct,
      targetDollar: c.totalValue * c.cashPct,
      targetPct: c.cashPct*100,
      proposedDollar:0,
      proposedPct:0,
      finalDollar: row3CurDollar,
      finalPct: row3CurPct
    }
  ];

  document.getElementById('clientName').textContent = c.clientName;
  document.getElementById('clientRisk').textContent = c.riskTolerance;
  document.getElementById('clientValue').textContent = formatMoney(c.totalValue);
  document.getElementById('targetStocks').textContent = (c.stockPct*100).toFixed(0);
  document.getElementById('targetBonds').textContent  = (c.bondPct*100).toFixed(0);
  document.getElementById('targetCash').textContent   = (c.cashPct*100).toFixed(0);

  document.getElementById('tradeMessage').textContent = '';
  renderTableAndCharts();
}

/** Renders the table from the "assets" array, plus updates charts. */
function renderTableAndCharts(){
  const tbody = document.getElementById('portfolioRows');
  tbody.innerHTML = '';

  assets.forEach((row, idx) => {
    const tr = document.createElement('tr');

    // 1) Asset
    let tdName = document.createElement('td');
    tdName.textContent = row.name;
    tr.appendChild(tdName);

    // 2) Current($)
    let tdCurrentDollar = document.createElement('td');
    tdCurrentDollar.textContent = formatMoney(row.currentDollar);
    tr.appendChild(tdCurrentDollar);

    // 3) Target($)
    let tdTargetDollar = document.createElement('td');
    tdTargetDollar.textContent = formatMoney(row.targetDollar);
    tr.appendChild(tdTargetDollar);

    // 4) Proposed +/- ($) [editable]
    let tdPropDollar = document.createElement('td');
    tdPropDollar.className = 'editable-cell';
    tdPropDollar.textContent = formatMoney(row.proposedDollar);
    tdPropDollar.onclick = () => makeEditable(tdPropDollar, idx, 'dollar');
    tr.appendChild(tdPropDollar);

    // 5) Final($)
    let tdFinalDollar = document.createElement('td');
    tdFinalDollar.textContent = formatMoney(row.finalDollar);
    tr.appendChild(tdFinalDollar);

    // 6) Current(%)
    let tdCurrentPct = document.createElement('td');
    tdCurrentPct.textContent = row.currentPct.toFixed(2) + '%';
    tr.appendChild(tdCurrentPct);

    // 7) Target(%)
    let tdTargetPct = document.createElement('td');
    tdTargetPct.textContent = row.targetPct.toFixed(2) + '%';
    tr.appendChild(tdTargetPct);

    // 8) Proposed +/- (%) [editable]
    let tdPropPct = document.createElement('td');
    tdPropPct.className = 'editable-cell';
    tdPropPct.textContent = row.proposedPct.toFixed(2) + '%';
    tdPropPct.onclick = () => makeEditable(tdPropPct, idx, 'percent');
    tr.appendChild(tdPropPct);

    // 9) Final(%)
    let tdFinalPct = document.createElement('td');
    tdFinalPct.textContent = row.finalPct.toFixed(2) + '%';
    tr.appendChild(tdFinalPct);

    tbody.appendChild(tr);
  });

  // After table is rendered, update the charts (summing final$ for left chart, target$ for right)
  updateCharts();
}

/**
 * Single-click editing logic. 
 * mode = 'dollar' or 'percent'
 * We parse the old text, let user type a new value, then call finishEdit() 
 */
function makeEditable(cell, assetIndex, mode){
  const oldValue = cell.textContent.replace(/[^\d.-]/g,''); 
  cell.onclick = null;
  cell.innerHTML = '';
  let input = document.createElement('input');
  input.type = 'text';
  input.value = oldValue||'0';

  input.onblur = ()=> finishEdit(cell, input.value, assetIndex, mode);
  input.onkeydown= (ev)=>{
    if(ev.key==='Enter'){
      ev.preventDefault();
      input.blur();
    }
  };
  cell.appendChild(input);
  setTimeout(()=>input.select(),0);
}

/**
 * Applies your exact rules:
 * 
 * CASE 1: If user edits Proposed(%):
 *   final(%) = current(%) + newVal
 *   proposed($) = newVal * current($)
 *   final($) = current($) + proposed($)
 * 
 * CASE 2: If user edits Proposed($):
 *   final($) = current($) + proposed($)
 *   proposed(%) = proposed($)/ current($)*100
 *   final(%) = current(%) + proposed(%)
 */
function finishEdit(cell, raw, assetIndex, mode){
  let val = parseFloat(raw)||0;
  let row = assets[assetIndex];

  if(mode==='percent'){
    // final(%) = current(%) + val
    // proposed($)= val * current($)
    // final($)= current($)+ proposed($)

    row.finalPct = row.currentPct + val;        // user says val is an absolute number to add
    row.proposedPct = val;                     // store that for the table
    row.proposedDollar = val * row.currentDollar;  
    row.finalDollar = row.currentDollar + row.proposedDollar;

  } else {
    // mode==='dollar'
    // final($)= current($)+ val
    // proposed(%)= val/current($)*100
    // final(%)= current(%)+ proposed(%)
    row.proposedDollar = val;
    row.finalDollar = row.currentDollar + val;
    row.proposedPct = (val/ row.currentDollar)*100;
    row.finalPct = row.currentPct + row.proposedPct;
  }

  renderTableAndCharts(); // re-render
  // restore single-click for next time
  if(mode==='percent'){
    cell.textContent = row.proposedPct.toFixed(2)+'%';
    cell.onclick = () => makeEditable(cell, assetIndex, 'percent');
  } else {
    cell.textContent = formatMoney(row.proposedDollar);
    cell.onclick = () => makeEditable(cell, assetIndex, 'dollar');
  }
}

/** Rebalance button does not reset proposed amounts. */
function doRebalance(){
  document.getElementById('tradeMessage').innerHTML =
    '<span class="success">Rebalance triggered (Proposed amounts not cleared).</span>';
}

/** Reset: sets all Proposed +/- to 0. */
function doResetTrades(){
  assets.forEach(a=>{
    a.proposedDollar=0;
    a.proposedPct=0;
    a.finalDollar = a.currentDollar;
    a.finalPct    = a.currentPct;
  });
  renderTableAndCharts();
  document.getElementById('tradeMessage').textContent = 'All proposed trades reset to 0.';
}

/** Chart: sums each asset's finalDollar for the "Final Allocation", targetDollar for "Target Allocation." */
function updateCharts(){
  const finalVals = assets.map(a=> a.finalDollar);
  const targetVals= assets.map(a=> a.targetDollar);
  const labels   = assets.map(a=> a.name);

  finalChart.data.labels = labels;
  finalChart.data.datasets[0].data = finalVals;
  finalChart.update();

  targetChart.data.labels = labels;
  targetChart.data.datasets[0].data = targetVals;
  targetChart.update();
}

/** Format a dollar with commas, 2 decimals. */
function formatMoney(x){
  return new Intl.NumberFormat('en-US',{
    minimumFractionDigits:2,
    maximumFractionDigits:2
  }).format(x);
}

/** Initialize our two pie charts. */
function initCharts(){
  finalChart = new Chart(document.getElementById('finalChart'),{
    type:'pie',
    data:{
      labels: [],
      datasets:[{
        label: 'Final Allocation',
        data: [],
        backgroundColor:['#2196f3','#8bc34a','#ffc107']
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:true,
      plugins:{legend:{position:'bottom'}}
    }
  });

  targetChart = new Chart(document.getElementById('targetChart'),{
    type:'pie',
    data:{
      labels: [],
      datasets:[{
        label: 'Target Allocation',
        data: [],
        backgroundColor:['#2196f3','#8bc34a','#ffc107']
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:true,
      plugins:{legend:{position:'bottom'}}
    }
  });
}

/** On page load */
window.addEventListener('DOMContentLoaded',()=>{
  initCharts();
  document.getElementById('newClientBtn').addEventListener('click', newRandomClient);
  document.getElementById('rebalanceBtn').addEventListener('click', doRebalance);
  document.getElementById('resetTradesBtn').addEventListener('click', doResetTrades);

  // create initial scenario
  newRandomClient();
});
</script>
</body>
</html>
