<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Portfolio Manager Simulator (Revised Requirements)</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background: #f8f9fa;
    }

    .container {
      max-width: 900px;
      margin: 1rem auto;
      padding: 1.5rem;
      background: #fff;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      border-radius: 5px;
    }

    h1, h2, h3 {
      margin-top: 0;
      margin-bottom: 0.75rem;
    }

    .section {
      margin-bottom: 1.5rem;
      border-bottom: 1px solid #ddd;
      padding-bottom: 1rem;
    }

    .btn {
      padding: 0.4rem 0.8rem;
      border: none;
      background: #007bff;
      color: #fff;
      cursor: pointer;
      border-radius: 3px;
      margin-left: 0.5rem;
      font-size: 0.9rem;
    }
    .btn:hover {
      background: #0069d9;
    }

    /* CLIENT PROFILE */
    #client-profile {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
    }
    .profile-info {
      flex: 1;
      min-width: 250px;
      margin-right: 1rem;
    }
    .profile-info p {
      margin: 0.3rem 0;
    }

    /* Moved generate new client button to bottom of client profile */
    .profile-actions {
      margin-top: 1rem;
    }

    /* CURRENT (OR PROJECTED) HEADER WITH BUTTONS ON THE SAME LINE, RIGHT-ALIGNED */
    .portfolio-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      margin-bottom: 0.5rem;
    }
    .portfolio-header h2 {
      margin-bottom: 0.3rem;
    }
    .portfolio-buttons {
      display: flex;
      gap: 0.5rem;
    }

    /* TABLE */
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 0.5rem 0;
    }
    th, td {
      text-align: left;
      padding: 0.4rem;
      border-bottom: 1px solid #eee;
      vertical-align: middle;
    }
    th {
      background: #f0f0f0;
    }

    /* Proposed +/- cells become editable on single click */
    .editable-cell {
      cursor: pointer;
      background: #fafafa;
      border: 1px solid transparent;
    }
    .editable-cell input {
      width: 100%;
      border: 1px solid #007bff;
      outline: none;
      font: inherit;
      box-sizing: border-box;
      padding: 2px 4px;
      text-align: right;
    }

    /* CHARTS LAYOUT */
    .charts-container {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
      flex-wrap: wrap;
    }
    .chart-box {
      flex: 1;
      min-width: 270px;
      max-width: 400px;
      max-height: 400px;
      position: relative;
      margin: auto;
      background: #f9f9f9;
      border-radius: 4px;
      padding: 1rem;
      text-align: center;
    }
    .chart-title {
      margin-bottom: 0.5rem;
      font-weight: bold;
    }
    .chart-box canvas {
      width: 100% !important;
      height: 100% !important;
    }

    @media (max-width: 700px) {
      .charts-container {
        flex-direction: column;
      }
      .chart-box {
        max-width: 100%;
        margin-bottom: 1rem;
      }
    }

    .footer {
      text-align: center;
      margin-top: 2rem;
      font-size: 0.85rem;
      color: #666;
    }

    .success {
      color: green;
      font-weight: bold;
    }
    .error {
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>Portfolio Manager Simulator</h1>

  <!-- SECTION: CLIENT PROFILE -->
  <div class="section">
    <h2>Client Profile</h2>
    <div id="client-profile">
      <div class="profile-info">
        <p><strong>Name:</strong> <span id="clientName">--</span></p>
        <p><strong>Risk Tolerance:</strong> <span id="clientRisk">--</span></p>
        <p><strong>Portfolio Value:</strong> $<span id="clientValue">0</span></p>
        <p><strong>Target Allocation:</strong> 
          <span id="targetStocks">--</span>% Stocks, 
          <span id="targetBonds">--</span>% Bonds, 
          <span id="targetCash">--</span>% Cash
        </p>

        <!-- Moved "Generate New Client" button to bottom of client profile -->
        <div class="profile-actions">
          <button class="btn" id="newClientBtn">Generate New Client</button>
        </div>
      </div>
    </div>
  </div>

  <!-- SECTION: CURRENT (OR PROJECTED) PORTFOLIO -->
  <div class="section">
    <div class="portfolio-header">
      <h2>Current (or Projected) Portfolio</h2>
      <div class="portfolio-buttons">
        <!-- Right-aligned Rebalance & Reset Trades -->
        <button class="btn" id="rebalanceBtn">Rebalance</button>
        <button class="btn" id="resetTradesBtn">Reset Trades</button>
      </div>
    </div>

    <!-- 
      TABLE COLUMNS: 
        1) Asset Class
        2) Current($)
        3) Target($)
        4) Proposed +/-($)
        5) Final($)
        6) Current(%)
        7) Target(%)
        8) Proposed +/-(%)
        9) Final(%)
    -->
    <table id="portfolioTable">
      <thead>
        <tr>
          <th>Asset</th>
          <th>Current ($)</th>
          <th>Target ($)</th>
          <th>Proposed +/- ($)</th>
          <th>Final ($)</th>
          <th>Current (%)</th>
          <th>Target (%)</th>
          <th>Proposed +/- (%)</th>
          <th>Final (%)</th>
        </tr>
      </thead>
      <tbody id="portfolioRows">
        <!-- Populated by JS -->
      </tbody>
    </table>

    <div class="charts-container">
      <!-- Left chart: Final Allocation (based on Current + Proposed) -->
      <div class="chart-box">
        <div class="chart-title">Final Allocation</div>
        <canvas id="finalChart"></canvas>
      </div>
      <!-- Right chart: Target Allocation -->
      <div class="chart-box">
        <div class="chart-title">Target Allocation</div>
        <canvas id="targetChart"></canvas>
      </div>
    </div>

    <p id="tradeMessage"></p>
  </div>
</div>

<div class="footer">
  &copy; Revised MVP with Single-Click Editing &amp; Expanded Table Columns
</div>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/* 
  Implementation Details:

  1) We store each asset row in an array "assets".
     For each asset:
       { 
         name: "Stocks",
         currentDollar:  55000,
         targetDollar:   50000,
         proposedDollar: 0,       // user enters +/- here
         finalDollar:    55000,   // calculated: current + proposed
         currentPct:     0,       // row share of total current
         targetPct:      0,       // row share of total target
         proposedPct:    0,       // user enters +/- in % form (like +5.0 => +5% of total current?)
         finalPct:       0        // row share of final total
       }

  2) Single-click on Proposed +/- ($) or Proposed +/- (%) cells:
     - We replace the cell with an <input>, auto-select the existing value
     - On blur (or Enter), we parse the new value, update "proposedDollar" or "proposedPct", recalc the row & entire portfolio.

  3) The "Final($)" = currentDollar + proposedDollar
     The "Final(%)" = finalDollar / sumOfAllFinalDollars * 100
     Similarly for "proposedPct": If user edits Proposed +/-(%), we convert that to a dollar amount:
       proposedDollar = (proposedPct / 100) * totalCurrentDollars
     Then recalc finalDollar.

  4) Rebalance does NOT reset the Proposed columns. It's up to your game logic what "rebalance" should do.

  5) "Reset Trades" sets all Proposed +/- columns to zero. 
  6) Thousands separators handled by a "formatMoney()" function using Intl.NumberFormat.

*/

/** Global arrays for assets. We handle 3: Stocks, Bonds, Cash. */
let assets = [];
let totalCurrent = 0;
let totalTarget  = 0;
let totalFinal   = 0; // sum of final dollars across all assets

// Chart.js references
let finalChart, targetChart;

// Example data used initially:
let clientName = '';
let clientRisk = '';
let clientValue = 0; // total portfolio
let targetStocksPct = 0;
let targetBondsPct  = 0;
let targetCashPct   = 0;

/** Create a random client. You can expand this logic as you like. */
function generateRandomClient() {
  const names = ['John Smith', 'Jane Doe', 'Alex Johnson', 'Maria Garcia', 'Lee Wong'];
  const riskLevels = [
    { name: 'Conservative', stockPct: 0.3, bondPct: 0.5, cashPct: 0.2 },
    { name: 'Moderate',     stockPct: 0.5, bondPct: 0.4, cashPct: 0.1 },
    { name: 'Aggressive',   stockPct: 0.7, bondPct: 0.2, cashPct: 0.1 }
  ];
  const randName = names[Math.floor(Math.random() * names.length)];
  const randRisk = riskLevels[Math.floor(Math.random() * riskLevels.length)];
  return {
    clientName: randName,
    riskTolerance: randRisk.name,
    totalValue: 100000,
    targetStockPct: randRisk.stockPct,
    targetBondPct:  randRisk.bondPct,
    targetCashPct:  randRisk.cashPct
  };
}

/** Called on DOMContentLoaded or when user clicks "Generate New Client". */
function newRandomClient() {
  const c = generateRandomClient();
  clientName = c.clientName;
  clientRisk = c.riskTolerance;
  clientValue = c.totalValue;
  targetStocksPct = c.targetStockPct;
  targetBondsPct  = c.targetBondPct;
  targetCashPct   = c.targetCashPct;

  // We'll deviate the current amounts a bit from target
  // just to make it interesting:
  // If target was 50% stocks, let's do +/âˆ’ up to 10% random
  const deviate = () => (Math.random() * 0.2 - 0.1); 
  const stDev = targetStocksPct + deviate();
  const boDev = targetBondsPct + deviate();
  const caDev = targetCashPct + deviate();
  const sum   = Math.max(stDev + boDev + caDev, 0.001);
  const stPct = stDev / sum;
  const boPct = boDev / sum;
  const caPct = caDev / sum;

  // Build the assets array
  // currentDollar = totalValue * each pct
  // targetDollar  = totalValue * official target
  assets = [
    {
      name: "Stocks",
      currentDollar: c.totalValue * stPct,
      targetDollar:  c.totalValue * c.targetStockPct,
      proposedDollar: 0,
      finalDollar: 0,
      currentPct: 0,
      targetPct: 0,
      proposedPct: 0,
      finalPct: 0
    },
    {
      name: "Bonds",
      currentDollar: c.totalValue * boPct,
      targetDollar:  c.totalValue * c.targetBondPct,
      proposedDollar: 0,
      finalDollar: 0,
      currentPct: 0,
      targetPct: 0,
      proposedPct: 0,
      finalPct: 0
    },
    {
      name: "Cash",
      currentDollar: c.totalValue * caPct,
      targetDollar:  c.totalValue * c.targetCashPct,
      proposedDollar: 0,
      finalDollar: 0,
      currentPct: 0,
      targetPct: 0,
      proposedPct: 0,
      finalPct: 0
    }
  ];

  document.getElementById('tradeMessage').textContent = '';

  renderClientProfile();
  recalcAndRender();
}

/** Display the name/risk in the Client Profile. */
function renderClientProfile() {
  document.getElementById('clientName').textContent = clientName;
  document.getElementById('clientRisk').textContent = clientRisk;
  document.getElementById('clientValue').textContent = formatMoney(clientValue);

  document.getElementById('targetStocks').textContent = (targetStocksPct * 100).toFixed(0);
  document.getElementById('targetBonds').textContent  = (targetBondsPct  * 100).toFixed(0);
  document.getElementById('targetCash').textContent   = (targetCashPct   * 100).toFixed(0);
}

/** Recalculate all columns (currentPct, finalDollar, finalPct, etc.) and update DOM & charts. */
function recalcAndRender() {
  // 1) Sum up all currentDollar, sum up all targetDollar, sum up all finalDollar
  totalCurrent = assets.reduce((acc,a) => acc + a.currentDollar, 0);
  totalTarget  = assets.reduce((acc,a) => acc + a.targetDollar,  0);

  // The finalDollar for each asset = currentDollar + proposedDollar
  // We'll compute total final, then finalPct = finalDollar / totalFinal * 100
  assets.forEach(a => {
    a.finalDollar = a.currentDollar + a.proposedDollar;
  });
  totalFinal = assets.reduce((acc,a) => acc + a.finalDollar, 0);

  // 2) Now compute % columns
  assets.forEach(a => {
    a.currentPct = (totalCurrent > 0) ? (a.currentDollar / totalCurrent) * 100 : 0;
    a.targetPct  = (totalTarget  > 0) ? (a.targetDollar  / totalTarget ) * 100 : 0;
    // If user typed Proposed +/- in dollars, we convert that to a portfolio-based percentage:
    // proposedPct = proposedDollar / totalCurrent * 100
    a.proposedPct = (totalCurrent > 0) ? (a.proposedDollar / totalCurrent) * 100 : 0;
    a.finalPct    = (totalFinal   > 0) ? (a.finalDollar   / totalFinal)   * 100 : 0;
  });

  // 3) Render the table rows
  renderPortfolioTable();

  // 4) Update the Final Allocation chart (left) & Target Allocation (right)
  updateCharts();
}

/** Populate the portfolio table's rows. */
function renderPortfolioTable() {
  const tbody = document.getElementById('portfolioRows');
  tbody.innerHTML = ''; // clear old rows

  assets.forEach((asset, idx) => {
    const tr = document.createElement('tr');

    // 1) Asset Class
    const tdName = document.createElement('td');
    tdName.textContent = asset.name;
    tr.appendChild(tdName);

    // 2) Current ($)
    const tdCurrentDollar = document.createElement('td');
    tdCurrentDollar.textContent = formatMoney(asset.currentDollar);
    tr.appendChild(tdCurrentDollar);

    // 3) Target ($)
    const tdTargetDollar = document.createElement('td');
    tdTargetDollar.textContent = formatMoney(asset.targetDollar);
    tr.appendChild(tdTargetDollar);

    // 4) Proposed +/- ($) [editable cell]
    const tdProposedDollar = document.createElement('td');
    tdProposedDollar.className = 'editable-cell';
    tdProposedDollar.textContent = formatMoney(asset.proposedDollar);
    tdProposedDollar.onclick = () => makeEditable(tdProposedDollar, idx, 'dollar');
    tr.appendChild(tdProposedDollar);

    // 5) Final ($)
    const tdFinalDollar = document.createElement('td');
    tdFinalDollar.textContent = formatMoney(asset.finalDollar);
    tr.appendChild(tdFinalDollar);

    // 6) Current (%)
    const tdCurrentPct = document.createElement('td');
    tdCurrentPct.textContent = asset.currentPct.toFixed(1) + '%';
    tr.appendChild(tdCurrentPct);

    // 7) Target (%)
    const tdTargetPct = document.createElement('td');
    tdTargetPct.textContent = asset.targetPct.toFixed(1) + '%';
    tr.appendChild(tdTargetPct);

    // 8) Proposed +/- (%) [editable cell]
    const tdProposedPct = document.createElement('td');
    tdProposedPct.className = 'editable-cell';
    tdProposedPct.textContent = asset.proposedPct.toFixed(2) + '%';
    tdProposedPct.onclick = () => makeEditable(tdProposedPct, idx, 'percent');
    tr.appendChild(tdProposedPct);

    // 9) Final (%)
    const tdFinalPct = document.createElement('td');
    tdFinalPct.textContent = asset.finalPct.toFixed(1) + '%';
    tr.appendChild(tdFinalPct);

    tbody.appendChild(tr);
  });
}

/** Make a cell in Proposed +/- ($ or %) editable on single click. */
function makeEditable(cell, assetIndex, mode) {
  // mode is either 'dollar' or 'percent'
  const oldValue = cell.textContent.replace(/[^0-9.-]/g, ''); 
  // e.g. remove commas, $, and % to parse as float

  cell.onclick = null; // disable re-click
  cell.innerHTML = ''; // clear text
  const input = document.createElement('input');
  input.type = 'text';
  input.value = oldValue || '0';
  // Auto-select the text
  setTimeout(() => input.select(), 0);

  // On blur or Enter, finalize
  input.onblur = () => finishEdit(cell, input.value, assetIndex, mode);
  input.onkeydown = (ev) => {
    if (ev.key === 'Enter') {
      ev.preventDefault();
      input.blur();
    }
  };

  cell.appendChild(input);
  input.focus();
}

/** Finalize user input in Proposed +/- cell, update data, recalc. */
function finishEdit(cell, rawVal, assetIndex, mode) {
  let newVal = parseFloat(rawVal) || 0;

  // 1) If mode is 'dollar', we set proposedDollar = newVal
  //    If mode is 'percent', we interpret newVal as "Proposed +/-(%) of total current portfolio"
  //    => proposedDollar = (newVal / 100) * totalCurrent
  if (mode === 'percent') {
    const propDollar = (newVal / 100) * totalCurrent;
    assets[assetIndex].proposedDollar = propDollar;
  } else {
    // mode === 'dollar'
    assets[assetIndex].proposedDollar = newVal;
  }

  // 2) Recalc the entire table
  recalcAndRender();

  // 3) Restore single-click event
  if (mode === 'percent') {
    const displayedPct = assets[assetIndex].proposedPct.toFixed(2) + '%';
    cell.textContent = displayedPct;
    cell.onclick = () => makeEditable(cell, assetIndex, 'percent');
  } else {
    const displayedDollar = formatMoney(assets[assetIndex].proposedDollar);
    cell.textContent = displayedDollar;
    cell.onclick = () => makeEditable(cell, assetIndex, 'dollar');
  }
}

/** Rebalance: does not reset proposed amounts per your request. */
function doRebalance() {
  document.getElementById('tradeMessage').innerHTML =
    '<span class="success">Rebalance triggered (but Proposed amounts not cleared).</span>';
}

/** Reset all Proposed +/- columns to zero. */
function doResetTrades() {
  assets.forEach(a => {
    a.proposedDollar = 0;
  });
  recalcAndRender();
  document.getElementById('tradeMessage').textContent = 'All proposed trades reset to 0.';
}

/** Update the charts: left is "Final Allocation", right is "Target Allocation". */
function updateCharts() {
  const finalVals = assets.map(a => a.finalDollar);
  const finalLabels = assets.map(a => a.name);

  // The sum for final is totalFinal. We'll scale target by the same sum to visualize side by side.
  // Or we can show the actual target $ share. But let's keep it consistent with how we've done it so far:
  const targetVals = assets.map(a => a.targetDollar);

  finalChart.data.labels = finalLabels;
  finalChart.data.datasets[0].data = finalVals;
  finalChart.update();

  targetChart.data.labels = finalLabels;
  targetChart.data.datasets[0].data = targetVals;
  targetChart.update();
}

/** Format a dollar value with thousands separators, 2 decimals. */
function formatMoney(value) {
  return new Intl.NumberFormat('en-US', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  }).format(value);
}

/** Initialize Chart.js. */
function initCharts() {
  const ctxFinal   = document.getElementById('finalChart');
  const ctxTarget  = document.getElementById('targetChart');

  finalChart = new Chart(ctxFinal, {
    type: 'pie',
    data: {
      labels: [], // filled later
      datasets: [{
        label: 'Final Allocation',
        data: [],
        backgroundColor: ['#2196f3', '#8bc34a', '#ffc107']
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { position: 'bottom' }
      }
    }
  });

  targetChart = new Chart(ctxTarget, {
    type: 'pie',
    data: {
      labels: [],
      datasets: [{
        label: 'Target Allocation',
        data: [],
        backgroundColor: ['#2196f3', '#8bc34a', '#ffc107']
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { position: 'bottom' }
      }
    }
  });
}

/** Main init */
window.addEventListener('DOMContentLoaded', () => {
  initCharts();

  document.getElementById('newClientBtn').addEventListener('click', newRandomClient);
  document.getElementById('rebalanceBtn').addEventListener('click', doRebalance);
  document.getElementById('resetTradesBtn').addEventListener('click', doResetTrades);

  // Generate the first client scenario
  newRandomClient();
});
</script>
</body>
</html>
