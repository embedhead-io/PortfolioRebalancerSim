<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Portfolio Manager Simulator – Corrected Table Rendering</title>
  <style>
    /*********************************************************
     * LIGHT vs. DARK theme
     *********************************************************/
    :root {
      --bg-body: #f8f9fa;
      --bg-container: #fff;
      --text-color: #000;
      --header-footer-bg: #e9e9e9;
      --asset-col-bg: #e8f1ff;  /* Distinct background for Assets */
      --class-col-bg: #f2ffe8;  /* Distinct background for Classes */
      --proposed-col-border: #007bff;
      --editable-field-border: #ccc;

      /* Chart legend color in light mode */
      --chart-legend-color: #000;
    }
    body.dark-mode {
      --bg-body: #202020;
      --bg-container: #2c2c2c;
      --text-color: #eee;
      --header-footer-bg: #444;
      --asset-col-bg: #3a3a3a;
      --class-col-bg: #333;
      --proposed-col-border: #66afff;
      --editable-field-border: #888;

      /* Chart legend color in dark mode */
      --chart-legend-color: #fff;
    }

    body {
      margin: 0;
      font-family: 'Helvetica Neue', Arial, sans-serif;
      min-width: 1200px;
      background: var(--bg-body);
      color: var(--text-color);
      transition: background 0.3s, color 0.3s;
    }

    .container {
      max-width: 1200px;
      margin: 1rem auto;
      padding: 1.5rem;
      background: var(--bg-container);
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      transition: background 0.3s, color 0.3s;
    }

    h1, h2 {
      margin-top: 0;
      margin-bottom: 0.75rem;
    }

    .dark-mode-toggle {
      width: 20px; height: 20px;
      border-radius: 50%;
      background: #666;
      position: absolute;
      top: 10px; right: 10px;
      cursor: pointer;
      border: 2px solid #999;
      transition: background 0.3s;
    }
    .dark-mode-toggle:hover { background: #444; }
    body.dark-mode .dark-mode-toggle {
      background: #aaa; border-color: #ccc;
    }
    body.dark-mode .dark-mode-toggle:hover {
      background: #ccc;
    }

    .btn {
      padding: 0.4rem 0.8rem;
      border: none;
      background: #007bff;
      color: #fff;
      cursor: pointer;
      border-radius: 3px;
      margin-left: 0.5rem;
      font-size: 0.9rem;
    }
    .btn:hover {
      background: #0069d9;
    }

    .section {
      margin-bottom: 1.5rem;
      border-bottom: 1px solid #ddd;
      padding-bottom: 1rem;
    }

    /* Profile layout */
    #client-profile {
      display: flex; 
      justify-content: space-between; 
      flex-wrap: wrap;
    }
    .profile-info {
      flex: 1; 
      min-width: 320px; 
      margin-right: 1rem;
    }
    .profile-actions { margin-top: 1rem; }
    #riskSelect { margin-left: 0.5rem; }

    /* Editable Portfolio Value */
    .editable-field {
      cursor: pointer;
      border: 1px dotted var(--editable-field-border);
      padding: 2px 4px;
      background: #fafafa;
      transition: border-color 0.3s;
    }
    body.dark-mode .editable-field { background: #333; }
    .editable-field input {
      width: 80px; 
      border: 1px solid #007bff; 
      outline: none; 
      font: inherit; 
      box-sizing: border-box;
      text-align: right;
    }

    /* Table & expansions */
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 0.5rem 0;
      transition: background 0.3s, color 0.3s;
    }
    thead th {
      background: var(--header-footer-bg);
    }
    tfoot td {
      background: var(--header-footer-bg);
      font-weight: bold;
    }
    th, td {
      text-align: left;
      padding: 0.4rem;
      border-bottom: 1px solid #eee;
      vertical-align: middle;
    }

    /* Asset row => special background color, bold text */
    .asset-col {
      background: var(--asset-col-bg);
      font-weight: bold;
      transition: background 0.3s;
    }
    /* Class row => special background color */
    .class-col {
      background: var(--class-col-bg);
      transition: background 0.3s;
    }

    /* Proposed columns => color invert from total columns */
    .proposed-col {
      border: 1px dotted var(--proposed-col-border);
      background: #fafafa;
      cursor: pointer;
      transition: border-color 0.3s;
    }
    body.dark-mode .proposed-col { background: #333; }
    .proposed-positive { color: green; font-weight: bold; }
    .proposed-negative { color: red;   font-weight: bold; }

    /* Delta => total surplus => pos => red, neg => green, zero => black */
    .delta-positive { color: red;   font-weight: bold; }
    .delta-negative { color: green; font-weight: bold; }

    /* Expand toggles, indentation for sub-levels */
    .expand-toggle {
      cursor: pointer; 
      color: #007bff; 
      margin-right: 0.5rem;
    }
    .class-row td { padding-left: 2em; }
    .position-row td { padding-left: 4em; }

    /* 3 smaller charts side by side */
    .charts-container {
      display: flex; 
      gap: 1rem; 
      margin-top: 1rem; 
      flex-wrap: wrap; 
      justify-content: space-evenly;
    }
    .chart-box {
      flex: 1; 
      min-width: 250px; 
      max-width: 300px; 
      max-height: 300px; 
      position: relative; 
      margin: auto; 
      background: #f9f9f9; 
      border-radius: 4px; 
      padding: 1rem; 
      text-align: center;
      transition: background 0.3s;
    }
    body.dark-mode .chart-box { background: #333; }
    .chart-title {
      margin-bottom: 0.5rem; 
      font-weight: bold;
    }
    .chart-box canvas {
      width: 100% !important; 
      height: 100% !important;
    }
    .footer {
      text-align: center; 
      margin-top: 2rem; 
      font-size: 0.85rem; 
      transition: color 0.3s;
      color: var(--text-color);
    }
    .success { color: green; font-weight: bold; }
    .error   { color: red;   font-weight: bold; }
  </style>
</head>
<body>

<!-- Dark Mode Toggle Dot -->
<div class="dark-mode-toggle" id="darkModeToggle"></div>

<div class="container">
  <h1>Portfolio Manager Simulator – Final Table Rendering</h1>

  <!-- Client Profile -->
  <div class="section" id="client-profile">
    <div class="profile-info">
      <p><strong>Name:</strong> <span id="clientName">--</span></p>
      <p>
        <strong>Risk Tolerance:</strong>
        <select id="riskSelect">
          <option value="conservative">Conservative</option>
          <option value="moderate" selected>Moderate</option>
          <option value="aggressive">Aggressive</option>
        </select>
      </p>
      <p>
        <strong>Portfolio Value:</strong>
        $<span id="clientValue" class="editable-field">0</span>
      </p>
      <p>
        <strong>Target Allocation:</strong>
        <span id="targetStocks">--</span>% Stocks, 
        <span id="targetBonds">--</span>% Bonds, 
        <span id="targetCash">--</span>% Cash
      </p>
      <div class="profile-actions">
        <button class="btn" id="newClientBtn">Generate New Client</button>
      </div>
    </div>
  </div>

  <!-- Table & Charts -->
  <div class="section">
    <div class="portfolio-header">
      <h2>Current (or Projected) Portfolio</h2>
      <div class="portfolio-buttons">
        <button class="btn" id="resetTradesBtn">Reset Trades</button>
      </div>
    </div>

    <!-- Proposed => Total => Delta columns for both $ and % -->
    <table id="portfolioTable">
      <thead>
        <tr>
          <th>Asset/Class/Position</th>
          <th>Current ($)</th>
          <th>Target ($)</th>
          <th>Proposed ($)</th>
          <th>Total ($)</th>
          <th>Delta ($)</th>
          <th>Current (%)</th>
          <th>Target (%)</th>
          <th>Proposed (%)</th>
          <th>Total (%)</th>
          <th>Delta (%)</th>
        </tr>
      </thead>
      <tbody id="portfolioRows"></tbody>
      <tfoot>
        <tr id="totalRow"></tr>
      </tfoot>
    </table>

    <div class="charts-container">
      <div class="chart-box">
        <div class="chart-title">Current Allocation</div>
        <canvas id="currentChart"></canvas>
      </div>
      <div class="chart-box">
        <div class="chart-title">Target Allocation</div>
        <canvas id="targetChart"></canvas>
      </div>
      <div class="chart-box">
        <div class="chart-title">Total Allocation</div>
        <canvas id="finalChart"></canvas>
      </div>
    </div>

    <p id="tradeMessage"></p>
  </div>
</div>

<div class="footer">
  &copy; Example – Sums Actually Add Up, Distinct BG for Assets/Classes, Dark Mode Chart Legend
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/****************************************************************
 * 1) Data Model
 ****************************************************************/
let root = { name:"ROOT", expanded:true, children:[] };
let originalData=null;

let clientName="";
let totalPortfolioValue=0;
let originalPortfolioValue=0;

let userStockPct=0.5, userBondPct=0.4, userCashPct=0.1; // default moderate

let currentChart, targetChart, finalChart;

/****************************************************************
 * 2) Dark Mode Toggle
 ****************************************************************/
const darkToggle= document.getElementById('darkModeToggle');
darkToggle.addEventListener('click',()=> {
  document.body.classList.toggle('dark-mode');
  // Also re-update chart legends
  updateCharts();
});

/****************************************************************
 * 3) Generate Random Nested Data with "Cash"
 ****************************************************************/
function generateNestedData() {
  // "Stocks" => 2 classes => positions
  const stocks={
    name:"Stocks",
    isAsset:true,
    expanded:false,
    children:[
      {
        name:"Large Cap", 
        isClass:true,
        expanded:false,
        children:[
          makePosition("AAPL"), makePosition("MSFT")
        ]
      },
      {
        name:"Small Cap",
        isClass:true,
        expanded:false,
        children:[
          makePosition("RGEN"), makePosition("FIZZ")
        ]
      }
    ]
  };
  // "Bonds" => direct positions
  const bonds={
    name:"Bonds",
    isAsset:true,
    expanded:false,
    children:[
      makePosition("Corp Bond A"), makePosition("Gov Bond B")
    ]
  };
  // "Cash" => no children
  const cash={
    name:"Cash",
    isAsset:true,
    expanded:false,
    children:[]
  };

  root.children= [stocks, bonds, cash];
}
function makePosition(ticker) {
  let c=3000 + Math.random()*9000;
  let t=c + (Math.random()-0.5)*2000;
  return {
    name: ticker,
    isPosition:true,
    expanded:false,
    currentDollar: round100(c),
    targetDollar: round100(t),
    proposedDollar:0,
    totalDollar:0
  };
}
function round100(x) {
  return Math.round(x/100)*100;
}

/****************************************************************
 * 4) aggregator => sum from bottom up
 ****************************************************************/
function aggregator(node) {
  if(!node.children || node.children.length===0) {
    // position => total= current+ proposed
    node.totalDollar= node.currentDollar+ (node.proposedDollar||0);
    return;
  }
  let c=0, t=0, p=0, tot=0;
  node.children.forEach(ch=>{
    aggregator(ch);
    c+= ch.currentDollar;
    t+= ch.targetDollar;
    p+= ch.proposedDollar;
    tot+= ch.totalDollar;
  });
  node.currentDollar=c;
  node.targetDollar=t;
  node.proposedDollar=p;
  node.totalDollar= tot;
}

/****************************************************************
 * 5) If aggregator sum is off from user’s totalPortfolioValue 
 *    => adjust "Cash"
 ****************************************************************/
function fixCash() {
  aggregator(root);
  let diff= totalPortfolioValue - root.currentDollar;
  let cashNode= root.children.find(a=> /cash/i.test(a.name));
  if(cashNode) {
    cashNode.currentDollar+= diff; 
  }
  aggregator(root); // re-run to apply that fix
}

/****************************************************************
 * 6) compute absolute(%) vs. root sum
 ****************************************************************/
function computePercentages(node, rootRef) {
  let rc= (rootRef.currentDollar>0? rootRef.currentDollar:1);
  let rt= (rootRef.targetDollar>0? rootRef.targetDollar:1);
  let rtot= (rootRef.totalDollar>0? rootRef.totalDollar:1);

  node.currentPct= (node.currentDollar/rc)*100;
  node.targetPct= (node.targetDollar/rt)*100;
  node.proposedPct= (node.proposedDollar/rc)*100;
  node.totalPct= (node.totalDollar/rtot)*100; // or do total vs total?

  if(node.children) {
    node.children.forEach(ch=> computePercentages(ch,rootRef));
  }
}

/****************************************************************
 * 7) Render Table
 ****************************************************************/
function renderTable() {
  const tb= document.getElementById('portfolioRows');
  tb.innerHTML="";
  if(!root.children) return;
  root.children.forEach(asset => buildRow(asset,0));
  buildTotalRow();
}
function buildRow(node, level) {
  let tr= document.createElement('tr');

  // Name
  let tdName= document.createElement('td');
  if(node.isAsset) tdName.classList.add('asset-col');
  else if(node.isClass) tdName.classList.add('class-col');
  if(node.children && node.children.length>0) {
    let toggler= document.createElement('span');
    toggler.className='expand-toggle';
    toggler.textContent=node.expanded? "▼":"▶";
    toggler.onclick= ()=>{
      node.expanded=!node.expanded;
      renderAll();
    };
    tdName.appendChild(toggler);
  }
  tdName.appendChild(document.createTextNode(node.name));
  tr.appendChild(tdName);

  // Current($)
  let tdCur= document.createElement('td');
  tdCur.textContent= formatMoney(node.currentDollar||0);
  tr.appendChild(tdCur);

  // Target($)
  let tdTar= document.createElement('td');
  tdTar.textContent= formatMoney(node.targetDollar||0);
  tr.appendChild(tdTar);

  // Proposed($) => editable
  let tdProp= document.createElement('td');
  tdProp.className='proposed-col';
  let pd=node.proposedDollar||0;
  if(Math.abs(pd)>0.01) {
    if(pd>0) tdProp.classList.add('proposed-positive');
    else     tdProp.classList.add('proposed-negative');
  }
  tdProp.textContent= formatMoney(pd);
  tdProp.onclick= ()=> editProposedCell(tdProp,node,'dollar');
  tr.appendChild(tdProp);

  // Total($)
  let tdTot= document.createElement('td');
  tdTot.textContent= formatMoney(node.totalDollar||0);
  tr.appendChild(tdTot);

  // Delta($)= target- total
  let dd=node.targetDollar - node.totalDollar;
  let tdDelta= document.createElement('td');
  tdDelta.textContent= withSignMoney(dd);
  colorDeltaCell(tdDelta,dd);
  tr.appendChild(tdDelta);

  // Current(%)
  let tdCurPct= document.createElement('td');
  tdCurPct.textContent= (node.currentPct||0).toFixed(2)+"%";
  tr.appendChild(tdCurPct);

  // Target(%)
  let tdTarPct= document.createElement('td');
  tdTarPct.textContent= (node.targetPct||0).toFixed(2)+"%";
  tr.appendChild(tdTarPct);

  // Proposed(%)
  let tdPropPct= document.createElement('td');
  tdPropPct.className='proposed-col';
  let pp=node.proposedPct||0;
  if(Math.abs(pp)>0.01) {
    if(pp>0) tdPropPct.classList.add('proposed-positive');
    else     tdPropPct.classList.add('proposed-negative');
  }
  tdPropPct.textContent= pp.toFixed(2)+"%";
  tdPropPct.onclick= ()=> editProposedCell(tdPropPct,node,'percent');
  tr.appendChild(tdPropPct);

  // Total(%)
  let tdTotPct= document.createElement('td');
  let totp=node.totalPct||0;
  tdTotPct.textContent= totp.toFixed(2)+"%";
  tr.appendChild(tdTotPct);

  // Delta(%)= target% - total%
  let dp=(node.targetPct||0)-(node.totalPct||0);
  let tdDeltaPct= document.createElement('td');
  tdDeltaPct.textContent= withSignPct(dp);
  colorDeltaCell(tdDeltaPct,dp);
  tr.appendChild(tdDeltaPct);

  tb.appendChild(tr);

  if(node.expanded && node.children && node.children.length>0){
    node.children.forEach(ch=> buildRow(ch,level+1));
  }
}
function buildTotalRow() {
  const tf=document.getElementById('totalRow');
  tf.innerHTML="";
  let tr=document.createElement('tr');
  let td=document.createElement('td');
  td.colSpan=11;
  td.textContent="TOTAL PORTFOLIO";
  tr.appendChild(td);
  tf.appendChild(tr);
}

/****************************************************************
 * 8) Proposed Cell Single-Click Editing
 ****************************************************************/
function editProposedCell(cell,node,mode){
  let oldVal= cell.textContent.replace(/,/g,'').replace(/[^\d.\-+]/g,'');
  cell.onclick=null;
  cell.innerHTML='';

  let inp= document.createElement('input');
  inp.type='text';
  inp.value= oldVal||'0';
  setTimeout(()=>inp.select(),0);

  inp.onblur=()=>{
    finishProposedEdit(cell,node,inp.value,mode);
  };
  inp.onkeydown=(ev)=>{
    if(ev.key==='Enter'){
      ev.preventDefault(); inp.blur();
    }
  };
  cell.appendChild(inp);
  inp.focus();
}
function finishProposedEdit(cell,node,rawVal,mode){
  rawVal= rawVal.replace(/,/g,'');
  let val= parseFloat(rawVal)||0;
  if(mode==='percent'){
    let rCur=(root.currentDollar>0? root.currentDollar:1);
    node.proposedDollar= (val/100)* rCur;
  } else {
    node.proposedDollar= val;
  }
  renderAll();
}

/****************************************************************
 * 9) Full Recalc => aggregator => fixCash => aggregator => % => table => charts
 ****************************************************************/
function renderAll(){
  aggregator(root);
  fixCash(); // leftover goes to "Cash"
  aggregator(root);
  computePercentages(root, root);
  renderTable();
  updateCharts();
}

/****************************************************************
 * 10) Risk Tolerance => userStockPct, userBondPct, userCashPct
 ****************************************************************/
function onRiskChange(){
  let val= document.getElementById('riskSelect').value;
  if(val==="conservative"){
    userStockPct=0.3; userBondPct=0.5; userCashPct=0.2;
  } else if(val==="aggressive"){
    userStockPct=0.7; userBondPct=0.2; userCashPct=0.1;
  } else {
    userStockPct=0.5; userBondPct=0.4; userCashPct=0.1;
  }
  // update UI
  document.getElementById('targetStocks').textContent=(userStockPct*100).toFixed(0);
  document.getElementById('targetBonds').textContent=(userBondPct*100).toFixed(0);
  document.getElementById('targetCash').textContent= (userCashPct*100).toFixed(0);

  applyRiskAllocation();
  renderAll();
}
/** top-level "Stocks","Bonds","Cash" => targetDollar= fraction * totalPortfolioValue */
function applyRiskAllocation(){
  let stVal= userStockPct* totalPortfolioValue;
  let boVal= userBondPct * totalPortfolioValue;
  let caVal= userCashPct * totalPortfolioValue;

  if(root.children){
    root.children.forEach(ch=>{
      if(/stock/i.test(ch.name)) ch.targetDollar= stVal;
      else if(/bond/i.test(ch.name)) ch.targetDollar= boVal;
      else if(/cash/i.test(ch.name)) ch.targetDollar= caVal;
    });
  }
}

/****************************************************************
 * 11) "Generate New Client"
 ****************************************************************/
function doGenerateNewClient(){
  // random name
  const names=["John Smith","Jane Doe","Alex Johnson","Maria Garcia","Lee Wong"];
  clientName= names[Math.floor(Math.random()* names.length)];
  document.getElementById('clientName').textContent= clientName;

  // random portfolioValue
  let val= 80000 + Math.random()*40000;
  val= roundTo100(val);
  totalPortfolioValue= val;
  document.getElementById('clientValue').textContent= formatMoney(val);

  // build random
  generateNestedData();

  // store original
  originalData= JSON.parse(JSON.stringify(root));
  originalPortfolioValue= val;

  // apply risk => aggregator => table => charts
  applyRiskAllocation();
  renderAll();
}

/****************************************************************
 * 12) "Reset trades"
 ****************************************************************/
function doResetTrades(){
  if(originalData){
    root= JSON.parse(JSON.stringify(originalData));
    totalPortfolioValue= originalPortfolioValue;
    document.getElementById('clientValue').textContent= formatMoney(totalPortfolioValue);
    renderAll();
    document.getElementById('tradeMessage').textContent="Reset to initial scenario.";
  }
}

/****************************************************************
 * 13) Chart init & update
 ****************************************************************/
function initCharts(){
  currentChart= new Chart(document.getElementById('currentChart'),{
    type:'pie',
    data:{
      labels:[],
      datasets:[{
        label:'Current',
        data:[],
        backgroundColor:['#2196f3','#8bc34a','#ffc107']
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:true,
      plugins:{
        legend:{
          position:'bottom',
          labels:{
            color: getComputedStyle(document.body).getPropertyValue('--chart-legend-color')
          }
        }
      }
    }
  });
  targetChart= new Chart(document.getElementById('targetChart'),{
    type:'pie',
    data:{
      labels:[],
      datasets:[{
        label:'Target',
        data:[],
        backgroundColor:['#2196f3','#8bc34a','#ffc107']
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:true,
      plugins:{
        legend:{
          position:'bottom',
          labels:{
            color: getComputedStyle(document.body).getPropertyValue('--chart-legend-color')
          }
        }
      }
    }
  });
  finalChart= new Chart(document.getElementById('finalChart'),{
    type:'pie',
    data:{
      labels:[],
      datasets:[{
        label:'Total',
        data:[],
        backgroundColor:['#2196f3','#8bc34a','#ffc107']
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:true,
      plugins:{
        legend:{
          position:'bottom',
          labels:{
            color: getComputedStyle(document.body).getPropertyValue('--chart-legend-color')
          }
        }
      }
    }
  });
}
function updateCharts(){
  // sum top-level
  let labels=[], curVals=[], tarVals=[], totVals=[];
  if(root.children){
    root.children.forEach(ch=>{
      labels.push(ch.name);
      curVals.push(ch.currentDollar||0);
      tarVals.push(ch.targetDollar||0);
      totVals.push(ch.totalDollar||0);
    });
  }
  // update
  currentChart.data.labels= labels;
  currentChart.data.datasets[0].data= curVals;
  currentChart.options.plugins.legend.labels.color= getComputedStyle(document.body).getPropertyValue('--chart-legend-color');
  currentChart.update();

  targetChart.data.labels= labels;
  targetChart.data.datasets[0].data= tarVals;
  targetChart.options.plugins.legend.labels.color= getComputedStyle(document.body).getPropertyValue('--chart-legend-color');
  targetChart.update();

  finalChart.data.labels= labels;
  finalChart.data.datasets[0].data= totVals;
  finalChart.options.plugins.legend.labels.color= getComputedStyle(document.body).getPropertyValue('--chart-legend-color');
  finalChart.update();
}

/****************************************************************
 * 14) Format & color
 ****************************************************************/
function withSignMoney(value){
  let r= parseFloat(value.toFixed(2));
  if(Math.abs(r)<0.01) r=0;
  let absVal=Math.abs(r);
  let absStr=formatMoney(absVal);
  if(r>0) return `+${absStr}`;
  else if(r<0) return `-${absStr}`;
  return absStr;
}
function withSignPct(value){
  let r= parseFloat(value.toFixed(2));
  if(Math.abs(r)<0.01) r=0;
  let absVal=Math.abs(r).toFixed(2);
  if(r>0) return `+${absVal}%`;
  else if(r<0) return `-${absVal}%`;
  return "0.00%";
}
function colorDeltaCell(td, val) {
  td.classList.remove('delta-positive','delta-negative');
  let r=parseFloat(val.toFixed(2));
  if(Math.abs(r)<0.01) {
    // zero => black normal
  } else if(r>0) {
    td.classList.add('delta-positive');
  } else {
    td.classList.add('delta-negative');
  }
}
function formatMoney(x) {
  return new Intl.NumberFormat('en-US',{
    minimumFractionDigits:2,
    maximumFractionDigits:2
  }).format(x);
}

/****************************************************************
 * 15) Enable editing portfolio value
 ****************************************************************/
function enablePortfolioValueEdit(){
  const valSpan= document.getElementById('clientValue');
  valSpan.onclick= function onClick() {
    let oldVal= valSpan.textContent.replace(/,/g,'').replace(/[^\d.\-+]/g,'');
    valSpan.onclick=null;
    valSpan.innerHTML='';

    const inp= document.createElement('input');
    inp.type='text';
    inp.value= oldVal||'0';
    setTimeout(()=> inp.select(),0);

    inp.onblur=()=>{
      let parsed= parseFloat(inp.value.replace(/,/g,''))||0;
      totalPortfolioValue= parsed;
      valSpan.textContent= formatMoney(parsed);
      onRiskChange(); // re-apply risk => aggregator => table => chart
    };
    inp.onkeydown=(ev)=>{
      if(ev.key==='Enter'){ev.preventDefault();inp.blur();}
    };
    valSpan.appendChild(inp);
    inp.focus();
  };
}

/****************************************************************
 * 16) Startup
 ****************************************************************/
window.addEventListener('DOMContentLoaded', ()=>{
  initCharts();
  enablePortfolioValueEdit();

  document.getElementById('riskSelect').addEventListener('change', onRiskChange);
  document.getElementById('newClientBtn').addEventListener('click', doGenerateNewClient);
  document.getElementById('resetTradesBtn').addEventListener('click', ()=>{
    if(originalData){
      root= JSON.parse(JSON.stringify(originalData));
      totalPortfolioValue= originalPortfolioValue;
      document.getElementById('clientValue').textContent= formatMoney(totalPortfolioValue);
      renderAll();
      document.getElementById('tradeMessage').textContent="Reset to initial scenario.";
    }
  });

  // default
  onRiskChange();
  doGenerateNewClient();
});
</script>
</body>
</html>
