<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Portfolio Manager Simulator (Enhanced & Fixed)</title>
  <style>
    /* Basic resets and fonts */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Helvetica Neue', Arial, sans-serif;
      background: #f8f9fa;
    }

    /* Container for the entire app */
    .container {
      max-width: 900px;
      margin: 1rem auto;
      padding: 1.5rem;
      background: #fff;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      border-radius: 5px;
    }

    h1, h2, h3 {
      margin-top: 0;
      margin-bottom: 0.75rem;
    }

    .section {
      margin-bottom: 1.5rem;
      border-bottom: 1px solid #ddd;
      padding-bottom: 1rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 0.75rem 0;
    }
    th, td {
      text-align: left;
      padding: 0.5rem;
    }
    th {
      background: #f0f0f0;
    }
    .allocation-table tr:not(:last-child) td {
      border-bottom: 1px solid #eee;
    }

    .input-row {
      margin: 0.5rem 0;
    }
    .input-row label {
      display: inline-block;
      width: 80px;
      font-weight: bold;
    }
    .input-row input {
      width: 100px;
      padding: 0.3rem;
      margin-right: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 3px;
    }

    .btn {
      padding: 0.5rem 1rem;
      border: none;
      background: #007bff;
      color: #fff;
      cursor: pointer;
      border-radius: 3px;
      margin-right: 0.5rem;
      font-size: 0.9rem;
    }
    .btn:hover {
      background: #0069d9;
    }

    .success {
      color: green;
      font-weight: bold;
    }
    .error {
      color: red;
      font-weight: bold;
    }

    /* 
      CHARTS & RESPONSIVE LAYOUT
      We fix the height of each .chart-box to avoid infinite growth.
    */
    .charts-container {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
      flex-wrap: wrap; /* allows wrapping on smaller screens */
    }
    .chart-box {
      flex: 1;
      min-width: 270px;
      max-width: 400px;
      max-height: 400px; /* fix the max height to prevent infinite stretch */
      position: relative;
      margin: auto;
      background: #f9f9f9;
      border-radius: 4px;
      padding: 1rem;
      text-align: center;
    }
    .chart-title {
      margin-bottom: 0.5rem;
      font-weight: bold;
    }
    /* The canvas will fill the parent box but preserve aspect ratio */
    .chart-box canvas {
      width: 100% !important;
      height: 100% !important;
    }

    @media (max-width: 700px) {
      .charts-container {
        flex-direction: column;
      }
      .chart-box {
        max-width: 100%;
        margin-bottom: 1rem;
      }
    }

    .footer {
      text-align: center;
      margin-top: 2rem;
      font-size: 0.85rem;
      color: #666;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>Portfolio Manager Simulator (Enhanced &amp; Fixed)</h1>

  <!-- SECTION: Client Profile -->
  <div class="section">
    <h2>Client Profile</h2>
    <p><strong>Name:</strong> <span id="clientName">--</span></p>
    <p><strong>Risk Tolerance:</strong> <span id="clientRisk">--</span></p>
    <p><strong>Portfolio Value:</strong> $<span id="clientValue">0</span></p>
    <p><strong>Target Allocation:</strong> 
      <span id="targetStocks">--</span>% Stocks, 
      <span id="targetBonds">--</span>% Bonds, 
      <span id="targetCash">--</span>% Cash
    </p>
  </div>

  <!-- SECTION: Current Portfolio & Trade Inputs -->
  <div class="section">
    <h2>Current (or Projected) Portfolio</h2>
    <table class="allocation-table">
      <thead>
        <tr>
          <th>Asset Class</th>
          <th id="colValueHeader">Current ($)</th>
          <th id="colPctHeader">Current (%)</th>
          <th>Target (%)</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Stocks</td>
          <td id="curStocksVal">--</td>
          <td id="curStocksPct">--</td>
          <td id="tarStocksPct">--</td>
        </tr>
        <tr>
          <td>Bonds</td>
          <td id="curBondsVal">--</td>
          <td id="curBondsPct">--</td>
          <td id="tarBondsPct">--</td>
        </tr>
        <tr>
          <td>Cash</td>
          <td id="curCashVal">--</td>
          <td id="curCashPct">--</td>
          <td id="tarCashPct">--</td>
        </tr>
      </tbody>
    </table>

    <!-- CHARTS SECTION: Current vs. Target side by side -->
    <div class="charts-container">
      <div class="chart-box">
        <div class="chart-title">Current / Projected Allocation</div>
        <canvas id="currentChart"></canvas>
      </div>
      <div class="chart-box">
        <div class="chart-title">Target Allocation</div>
        <canvas id="targetChart"></canvas>
      </div>
    </div>

    <!-- Trade Inputs -->
    <h3>Propose Trades</h3>
    <p>Enter amounts to buy (+) or sell (−). Total buys must equal total sells to preview or rebalance.</p>
    <div class="input-row">
      <label>Stocks:</label>
      <input type="number" id="tradeStocks" step="0.01" value="0">
    </div>
    <div class="input-row">
      <label>Bonds:</label>
      <input type="number" id="tradeBonds" step="0.01" value="0">
    </div>
    <div class="input-row">
      <label>Cash:</label>
      <input type="number" id="tradeCash" step="0.01" value="0">
    </div>

    <button class="btn" id="rebalanceBtn">Rebalance</button>
    <button class="btn" id="resetTradesBtn">Reset Trades</button>

    <p id="tradeMessage"></p>
  </div>

  <!-- SECTION: Controls for new random client -->
  <div class="section">
    <button class="btn" id="newClientBtn">Generate New Client</button>
  </div>
</div>

<div class="footer">
  Portfolio Manager Simulator &bull; Enhanced &amp; Mobile-Friendly &bull; Now with bug fixes
</div>

<!-- SCRIPTS -->

<!-- Load Chart.js from a CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* 
  Portfolio Manager Simulator: Enhanced & Fixed
  - 1) Fixed infinite chart height by setting maintainAspectRatio = true + limiting container height.
  - 2) The "Current (%)" and chart update dynamically (preview) whenever user enters proposed trades.
*/

let clientName = '';
let riskTolerance = '';
let portfolioValue = 0;
let targetAllocation = { stocks: 0.5, bonds: 0.4, cash: 0.1 };
let currentHoldings = { stocks: 0, bonds: 0, cash: 0 };

// We'll store a "previewHoldings" to show dynamic updates as user types.
let previewHoldings = { stocks: 0, bonds: 0, cash: 0 };

let currentChart, targetChart;

// Generate random client
function generateRandomClient() {
  const names = ['John Smith', 'Jane Doe', 'Alex Johnson', 'Maria Garcia', 'Lee Wong'];
  const riskLevels = [
    { risk: 'Conservative', allocations: { stocks: 0.3, bonds: 0.5, cash: 0.2 } },
    { risk: 'Moderate',     allocations: { stocks: 0.5, bonds: 0.4, cash: 0.1 } },
    { risk: 'Aggressive',   allocations: { stocks: 0.7, bonds: 0.2, cash: 0.1 } }
  ];

  const randomName = names[Math.floor(Math.random() * names.length)];
  const randomRisk = riskLevels[Math.floor(Math.random() * riskLevels.length)];

  // total $100k
  const totalVal = 100000;
  // deviate +/- 10%
  const deviate = () => (Math.random() * 0.2 - 0.1);
  const stDev = randomRisk.allocations.stocks + deviate();
  const boDev = randomRisk.allocations.bonds + deviate();
  const caDev = randomRisk.allocations.cash + deviate();
  const sumAlloc = Math.max(stDev + boDev + caDev, 0.001); 
  const normSt = stDev / sumAlloc;
  const normBo = boDev / sumAlloc;
  const normCa = caDev / sumAlloc;

  return {
    name: randomName,
    riskTolerance: randomRisk.risk,
    portfolioValue: totalVal,
    targetAllocation: randomRisk.allocations,
    currentHoldings: {
      stocks: totalVal * normSt,
      bonds:  totalVal * normBo,
      cash:   totalVal * normCa
    }
  };
}

// Initialize new client data
function newRandomClient() {
  const client = generateRandomClient();
  clientName = client.name;
  riskTolerance = client.riskTolerance;
  portfolioValue = client.portfolioValue;
  targetAllocation = client.targetAllocation;
  currentHoldings = client.currentHoldings;
  
  // For safety, reset the proposed trades & message
  resetTradeInputs();
  document.getElementById('tradeMessage').textContent = '';

  // Start with no preview changes
  previewHoldings = { ...currentHoldings };
  renderClientData();
}

// Renders the "Current (or Projected)" data & target data
function renderClientData() {
  // Basic fields
  document.getElementById('clientName').textContent = clientName;
  document.getElementById('clientRisk').textContent = riskTolerance;
  document.getElementById('clientValue').textContent = portfolioValue.toFixed(2);
  document.getElementById('targetStocks').textContent = (targetAllocation.stocks * 100).toFixed(0);
  document.getElementById('targetBonds').textContent = (targetAllocation.bonds * 100).toFixed(0);
  document.getElementById('targetCash').textContent = (targetAllocation.cash * 100).toFixed(0);

  // Current or Projected (i.e., previewHoldings)
  const stVal = previewHoldings.stocks;
  const boVal = previewHoldings.bonds;
  const caVal = previewHoldings.cash;
  const totalVal = stVal + boVal + caVal;

  document.getElementById('curStocksVal').textContent = '$' + stVal.toFixed(2);
  document.getElementById('curBondsVal').textContent = '$' + boVal.toFixed(2);
  document.getElementById('curCashVal').textContent  = '$' + caVal.toFixed(2);

  if (totalVal > 0) {
    document.getElementById('curStocksPct').textContent = ((stVal / totalVal) * 100).toFixed(1) + '%';
    document.getElementById('curBondsPct').textContent = ((boVal / totalVal) * 100).toFixed(1) + '%';
    document.getElementById('curCashPct').textContent  = ((caVal / totalVal) * 100).toFixed(1) + '%';
  } else {
    document.getElementById('curStocksPct').textContent = '--';
    document.getElementById('curBondsPct').textContent = '--';
    document.getElementById('curCashPct').textContent  = '--';
  }

  // Update the table’s "Target (%)" fields
  document.getElementById('tarStocksPct').textContent = (targetAllocation.stocks * 100).toFixed(1) + '%';
  document.getElementById('tarBondsPct').textContent  = (targetAllocation.bonds * 100).toFixed(1) + '%';
  document.getElementById('tarCashPct').textContent   = (targetAllocation.cash * 100).toFixed(1) + '%';

  // Update the charts
  updateCharts();
}

// Called whenever we want to see a "preview" of the trades typed in
function previewRebalance() {
  // Parse the three trade fields
  const stTrade = parseFloat(document.getElementById('tradeStocks').value) || 0;
  const boTrade = parseFloat(document.getElementById('tradeBonds').value) || 0;
  const caTrade = parseFloat(document.getElementById('tradeCash').value) || 0;
  
  // Sum of trades must be zero to be feasible
  const sumTrades = stTrade + boTrade + caTrade;

  // We'll show a partial preview only if the user’s trades net to 0
  // and they do not exceed current holdings if negative
  if (Math.abs(sumTrades) < 0.0001) {
    // Check if the user sells more than they have
    if ((stTrade < 0 && Math.abs(stTrade) > currentHoldings.stocks) ||
        (boTrade < 0 && Math.abs(boTrade) > currentHoldings.bonds) ||
        (caTrade < 0 && Math.abs(caTrade) > currentHoldings.cash)) {
      // If invalid, just revert to actual current holdings
      previewHoldings = { ...currentHoldings };
      document.getElementById('tradeMessage').textContent = 'Error: Selling more than available.';
    } else {
      // Construct a projected holdings object
      previewHoldings = {
        stocks: currentHoldings.stocks + stTrade,
        bonds:  currentHoldings.bonds + boTrade,
        cash:   currentHoldings.cash + caTrade
      };
      document.getElementById('tradeMessage').textContent = 'Preview updated.';
    }
  } else {
    // If trades don’t net to zero, revert to actual holdings
    previewHoldings = { ...currentHoldings };
    document.getElementById('tradeMessage').textContent = 'Trades must sum to zero to preview.';
  }

  renderClientData();
}

// Finalize the rebalance – actually update currentHoldings
function rebalancePortfolio() {
  // If the preview is valid, finalize it
  currentHoldings = { ...previewHoldings };

  // Re-render to confirm final state
  renderClientData();

  document.getElementById('tradeMessage').innerHTML =
    '<span class="success">Success!</span> Portfolio rebalanced. Check the updated allocations above.';

  resetTradeInputs();
}

// Reset the trade inputs to zero
function resetTradeInputs() {
  document.getElementById('tradeStocks').value = 0;
  document.getElementById('tradeBonds').value = 0;
  document.getElementById('tradeCash').value  = 0;
  // Force a fresh preview
  previewHoldings = { ...currentHoldings };
  renderClientData();
}

// Chart.js initialization
function initializeCharts() {
  const ctxCurrent = document.getElementById('currentChart');
  const ctxTarget  = document.getElementById('targetChart');

  currentChart = new Chart(ctxCurrent, {
    type: 'pie',
    data: {
      labels: ['Stocks', 'Bonds', 'Cash'],
      datasets: [{
        label: 'Current / Projected',
        data: [0, 0, 0],
        backgroundColor: ['#2196f3', '#8bc34a', '#ffc107']
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true, /* fix endless growth */
      plugins: {
        legend: { position: 'bottom' }
      }
    }
  });

  targetChart = new Chart(ctxTarget, {
    type: 'pie',
    data: {
      labels: ['Stocks', 'Bonds', 'Cash'],
      datasets: [{
        label: 'Target Allocation',
        data: [0, 0, 0],
        backgroundColor: ['#2196f3', '#8bc34a', '#ffc107']
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { position: 'bottom' }
      }
    }
  });
}

// Updates chart data for both current/projected and target
function updateCharts() {
  if (!currentChart || !targetChart) return;

  // Preview holdings
  const stVal = previewHoldings.stocks;
  const boVal = previewHoldings.bonds;
  const caVal = previewHoldings.cash;
  const total = Math.max(stVal + boVal + caVal, 0);

  // Current / Projected chart
  currentChart.data.datasets[0].data = [stVal, boVal, caVal];
  currentChart.update();

  // Target chart: scale by total for a side-by-side comparison
  targetChart.data.datasets[0].data = [
    targetAllocation.stocks * total,
    targetAllocation.bonds  * total,
    targetAllocation.cash   * total
  ];
  targetChart.update();
}

// MAIN
window.addEventListener('DOMContentLoaded', () => {
  // 1) Initialize charts
  initializeCharts();

  // 2) Event listeners
  document.getElementById('newClientBtn').addEventListener('click', newRandomClient);
  document.getElementById('rebalanceBtn').addEventListener('click', rebalancePortfolio);
  document.getElementById('resetTradesBtn').addEventListener('click', resetTradeInputs);

  // Dynamically preview trades as user types
  document.getElementById('tradeStocks').addEventListener('input', previewRebalance);
  document.getElementById('tradeBonds').addEventListener('input', previewRebalance);
  document.getElementById('tradeCash').addEventListener('input', previewRebalance);

  // 3) Load the first client
  newRandomClient();
});
</script>
</body>
</html>
